# Lesson 1.13: Testing DELETE Endpoints

## A. Concept Overview

### What & Why
**DELETE endpoint testing** verifies that resource deletion works correctly. It's important because deletion is a critical operation that must be tested thoroughly to ensure data is properly removed and related data is handled correctly.

### Analogy
DELETE is like removing a book from a library. You need to verify: the book is actually removed, the catalog is updated, borrowed book history is preserved or cleared appropriately, and you can't check out a deleted book.

---

## B. DELETE Request Basics

**Characteristics**:
- Removes resources
- No request body (usually)
- Idempotent (deleting twice = same result)
- Returns 204 No Content or 200 OK
- May return confirmation message

---

## C. Testing DELETE Requests

File: `tests/test_delete_requests.py`
```python
"""
Test DELETE requests for resource deletion.
"""
import httpx


def test_delete_post():
    """Test deleting a post."""
    post_id = 1
    
    response = httpx.delete(
        f"https://jsonplaceholder.typicode.com/posts/{post_id}"
    )
    
    # Should return 200 OK (JSONPlaceholder returns 200, real APIs often return 204)
    assert response.status_code in [200, 204]


def test_delete_user():
    """Test deleting a user."""
    user_id = 1
    
    response = httpx.delete(
        f"https://jsonplaceholder.typicode.com/users/{user_id}"
    )
    
    assert response.status_code in [200, 204]


def test_delete_returns_empty_or_confirmation():
    """Test that DELETE response is empty or contains confirmation."""
    post_id = 1
    
    response = httpx.delete(
        f"https://jsonplaceholder.typicode.com/posts/{post_id}"
    )
    
    assert response.status_code == 200
    
    # JSONPlaceholder returns empty object
    if response.text:
        data = response.json()
        assert isinstance(data, dict)


def test_delete_nonexistent_resource():
    """Test deleting non-existent resource."""
    response = httpx.delete(
        "https://jsonplaceholder.typicode.com/posts/99999"
    )
    
    # May return 404 Not Found or 200/204 (idempotent behavior)
    assert response.status_code in [200, 204, 404]


def test_delete_idempotency():
    """Test that DELETE is idempotent."""
    post_id = 1
    
    # First DELETE
    response1 = httpx.delete(
        f"https://jsonplaceholder.typicode.com/posts/{post_id}"
    )
    
    # Second DELETE (should be idempotent)
    response2 = httpx.delete(
        f"https://jsonplaceholder.typicode.com/posts/{post_id}"
    )
    
    # Both should succeed (idempotent)
    assert response1.status_code in [200, 204]
    assert response2.status_code in [200, 204, 404]
```

---

## D. Verifying Deletion

File: `tests/test_delete_verification.py`
```python
"""
Test DELETE with verification.
"""
import httpx


def test_delete_and_verify_removed():
    """Test that DELETE actually removes the resource."""
    post_id = 1
    base_url = "https://jsonplaceholder.typicode.com"
    
    with httpx.Client(base_url=base_url) as client:
        # DELETE the post
        delete_response = client.delete(f"/posts/{post_id}")
        assert delete_response.status_code in [200, 204]
        
        # Try to GET deleted post (should return 404 in real API)
        # JSONPlaceholder mock may still return it
        get_response = client.get(f"/posts/{post_id}")
        # In real API: assert get_response.status_code == 404


def test_delete_with_dependencies():
    """Test deleting resource with related data."""
    # In real APIs, this would test:
    # - Cascade delete (related data also deleted)
    # - Prevent delete (409 Conflict if has dependencies)
    # - Soft delete (marked as deleted but not removed)
    
    user_id = 1
    response = httpx.delete(
        f"https://jsonplaceholder.typicode.com/users/{user_id}"
    )
    
    # Should handle deletion appropriately
    assert response.status_code in [200, 204, 409]
```

---

## E. Testing Error Scenarios

File: `tests/test_delete_errors.py`
```python
"""
Test DELETE error scenarios.
"""
import httpx


def test_delete_with_invalid_id():
    """Test DELETE with invalid ID format."""
    response = httpx.delete(
        "https://jsonplaceholder.typicode.com/posts/invalid-id"
    )
    
    # May return 404 or handle gracefully
    assert response.status_code in [200, 404]


def test_delete_protected_resource():
    """Test attempting to delete protected resource."""
    # In real APIs with auth, this would test:
    # - 401 Unauthorized (no auth)
    # - 403 Forbidden (no permission)
    
    # Demonstration with public API
    response = httpx.delete(
        "https://jsonplaceholder.typicode.com/posts/1"
    )
    
    # JSONPlaceholder allows all deletes
    assert response.status_code in [200, 204, 401, 403]
```

---

## F. Key Takeaways

ðŸ”‘ **DELETE removes resources**: Use to delete data  
ðŸ”‘ **Returns 204 No Content**: Or 200 OK with message  
ðŸ”‘ **Idempotent**: Deleting twice = same result  
ðŸ”‘ **Verify deletion**: GET should return 404  
ðŸ”‘ **Handle dependencies**: Cascade, prevent, or soft delete  
ðŸ”‘ **Test permissions**: Auth/authorization required  
ðŸ”‘ **No request body**: Resource ID in URL  

---

## G. What's Next?

In **Lesson 1.14: Response Validation Basics**, we'll learn comprehensive response validation techniques to ensure API responses are correct, complete, and consistent.

**Ready for lesson 1.14?**
