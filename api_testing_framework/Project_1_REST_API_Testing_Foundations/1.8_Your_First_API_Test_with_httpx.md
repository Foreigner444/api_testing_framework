# Lesson 1.8: Your First API Test with httpx

## A. Concept Overview

### What & Why
Your **first API test** is the moment where everything comes together‚Äîpytest framework + httpx client + actual API calls. It's important because this is where theory becomes practice, and you'll see how simple and powerful API testing really is.

### Analogy
Think of this like learning to ride a bike. You've learned about the parts (pytest = frame, httpx = wheels), now it's time to actually ride! Your first wobbly attempt will quickly become confident cruising.

---

## B. Choosing a Test API

For learning, we need a free, public API that:
- ‚úÖ Requires no authentication
- ‚úÖ Returns predictable responses
- ‚úÖ Is reliable and always available
- ‚úÖ Supports all HTTP methods

**We'll use httpbin.org** - a simple HTTP request & response service perfect for testing!

**httpbin.org endpoints**:
- `GET /get` - Returns GET data
- `POST /post` - Returns POST data
- `PUT /put` - Returns PUT data
- `DELETE /delete` - Returns DELETE data
- `GET /status/{code}` - Returns any HTTP status code
- `GET /delay/{seconds}` - Delayed response

---

## C. Your First Test - Simple GET Request

File: `tests/test_first_api.py`
```python
"""
Your first API test using httpx.
"""
import httpx


def test_get_request_returns_200():
    """Test that GET request to httpbin returns 200 OK."""
    # Make GET request
    response = httpx.get("https://httpbin.org/get")
    
    # Assert status code
    assert response.status_code == 200


def test_get_request_returns_json():
    """Test that response contains JSON data."""
    response = httpx.get("https://httpbin.org/get")
    
    # Check status
    assert response.status_code == 200
    
    # Check content type
    assert "application/json" in response.headers["content-type"]
    
    # Parse JSON
    data = response.json()
    
    # Verify JSON structure
    assert isinstance(data, dict)
    assert "url" in data
    assert "headers" in data


def test_get_request_url_matches():
    """Test that response contains correct URL."""
    url = "https://httpbin.org/get"
    response = httpx.get(url)
    
    assert response.status_code == 200
    
    # Parse response
    data = response.json()
    
    # Verify URL in response matches what we sent
    assert data["url"] == url
```

### Line-by-Line Explanation

**Line 1-3**: Module docstring and imports

**Line 6**: Test function (starts with `test_`)

**Line 7**: Docstring explaining what this test does

**Line 9**: Make GET request using httpx
- `httpx.get()` - Makes HTTP GET request
- Returns `Response` object

**Line 12**: Assert status code is 200 OK
- `response.status_code` - Gets HTTP status code
- `assert` - pytest assertion

**Line 16-27**: More complex test
- Gets response
- Checks content type header
- Parses JSON with `.json()`
- Verifies JSON structure

---

## D. Running Your First Test

```bash
pytest tests/test_first_api.py -v
```

**Expected Output**:
```
========================= test session starts ==========================
collected 3 items

tests/test_first_api.py::test_get_request_returns_200 PASSED    [ 33%]
tests/test_first_api.py::test_get_request_returns_json PASSED   [ 66%]
tests/test_first_api.py::test_get_request_url_matches PASSED    [100%]

========================== 3 passed in 1.25s ===========================
```

**üéâ Congratulations!** You just ran your first API tests!

---

## E. Understanding the Response Object

When you make a request, httpx returns a `Response` object with these properties:

```python
import httpx

response = httpx.get("https://httpbin.org/get")

# Status code
print(response.status_code)  # 200

# Headers (dict-like)
print(response.headers)  # {'content-type': 'application/json', ...}
print(response.headers["content-type"])  # 'application/json'

# Body as text
print(response.text)  # Raw text response

# Body as JSON (if applicable)
print(response.json())  # Parsed Python dict

# URL
print(response.url)  # URL object

# Encoding
print(response.encoding)  # 'utf-8'

# Content (raw bytes)
print(response.content)  # b'{"url": "https://..."}'

# Request that was sent
print(response.request.method)  # 'GET'
print(response.request.url)  # URL that was requested
```

---

## F. Testing Different Scenarios

Let's test various success and failure scenarios:

File: `tests/test_api_scenarios.py`
```python
"""
Test different API scenarios.
"""
import httpx


def test_successful_request():
    """Test successful GET request."""
    response = httpx.get("https://httpbin.org/get")
    assert response.status_code == 200


def test_not_found_returns_404():
    """Test that invalid endpoint returns 404."""
    response = httpx.get("https://httpbin.org/nonexistent")
    assert response.status_code == 404


def test_status_endpoint():
    """Test httpbin status endpoint returns requested code."""
    # Request 201 status
    response = httpx.get("https://httpbin.org/status/201")
    assert response.status_code == 201
    
    # Request 404 status
    response = httpx.get("https://httpbin.org/status/404")
    assert response.status_code == 404
    
    # Request 500 status
    response = httpx.get("https://httpbin.org/status/500")
    assert response.status_code == 500


def test_response_headers():
    """Test that response contains expected headers."""
    response = httpx.get("https://httpbin.org/get")
    
    # Check headers exist
    assert "content-type" in response.headers
    assert "content-length" in response.headers
    assert "server" in response.headers
    
    # Check specific values
    assert "application/json" in response.headers["content-type"]


def test_response_data_structure():
    """Test that response has expected JSON structure."""
    response = httpx.get("https://httpbin.org/get")
    data = response.json()
    
    # Check required fields exist
    assert "url" in data
    assert "headers" in data
    assert "args" in data
    assert "origin" in data
    
    # Check data types
    assert isinstance(data["url"], str)
    assert isinstance(data["headers"], dict)
    assert isinstance(data["args"], dict)
```

**Run it**:
```bash
pytest tests/test_api_scenarios.py -v
```

---

## G. Testing POST Requests

File: `tests/test_post_requests.py`
```python
"""
Test POST requests with httpx.
"""
import httpx


def test_post_request_with_json():
    """Test POST request sending JSON data."""
    # Prepare data
    payload = {
        "name": "John Doe",
        "email": "john@example.com",
        "age": 30
    }
    
    # Make POST request
    response = httpx.post(
        "https://httpbin.org/post",
        json=payload  # httpx automatically sets Content-Type: application/json
    )
    
    # Verify request succeeded
    assert response.status_code == 200
    
    # Parse response
    data = response.json()
    
    # httpbin echoes back what we sent in 'json' field
    assert data["json"] == payload
    assert data["json"]["name"] == "John Doe"
    assert data["json"]["email"] == "john@example.com"
    assert data["json"]["age"] == 30


def test_post_request_with_form_data():
    """Test POST request with form-encoded data."""
    form_data = {
        "username": "testuser",
        "password": "secret123"
    }
    
    response = httpx.post(
        "https://httpbin.org/post",
        data=form_data  # application/x-www-form-urlencoded
    )
    
    assert response.status_code == 200
    
    data = response.json()
    assert data["form"]["username"] == "testuser"
    assert data["form"]["password"] == "secret123"


def test_post_returns_correct_content_type():
    """Test that POST with JSON sets correct Content-Type."""
    payload = {"test": "data"}
    
    response = httpx.post(
        "https://httpbin.org/post",
        json=payload
    )
    
    assert response.status_code == 200
    
    # Check what headers were sent (httpbin echoes them back)
    data = response.json()
    assert "application/json" in data["headers"]["Content-Type"]
```

**Run it**:
```bash
pytest tests/test_post_requests.py -v
```

---

## H. Using httpx.Client for Multiple Requests

When making multiple requests, use `httpx.Client` for better performance:

File: `tests/test_with_client.py`
```python
"""
Test using httpx.Client for connection pooling.
"""
import httpx


def test_multiple_requests_with_client():
    """Test making multiple requests with same client."""
    with httpx.Client() as client:
        # Make multiple requests reusing same connection
        response1 = client.get("https://httpbin.org/get")
        response2 = client.get("https://httpbin.org/get")
        response3 = client.get("https://httpbin.org/get")
        
        # All should succeed
        assert response1.status_code == 200
        assert response2.status_code == 200
        assert response3.status_code == 200


def test_client_with_base_url():
    """Test client with base URL for cleaner code."""
    # Set base URL once
    with httpx.Client(base_url="https://httpbin.org") as client:
        # Now we can use relative URLs
        response1 = client.get("/get")
        response2 = client.get("/status/200")
        response3 = client.get("/headers")
        
        assert response1.status_code == 200
        assert response2.status_code == 200
        assert response3.status_code == 200


def test_client_with_default_headers():
    """Test client with default headers for all requests."""
    headers = {
        "User-Agent": "MyTestFramework/1.0",
        "Accept": "application/json"
    }
    
    with httpx.Client(headers=headers) as client:
        response = client.get("https://httpbin.org/headers")
        
        assert response.status_code == 200
        
        # Check that our headers were sent
        data = response.json()
        assert "MyTestFramework" in data["headers"]["User-Agent"]
        assert "application/json" in data["headers"]["Accept"]
```

---

## I. Error Handling

Test how your code handles errors:

```python
"""
Test error handling with httpx.
"""
import httpx
import pytest


def test_timeout_raises_exception():
    """Test that timeout raises appropriate exception."""
    with pytest.raises(httpx.TimeoutException):
        # Set very short timeout (will fail)
        httpx.get("https://httpbin.org/delay/10", timeout=0.1)


def test_invalid_url_raises_exception():
    """Test that invalid URL raises exception."""
    with pytest.raises(httpx.InvalidURL):
        httpx.get("not-a-valid-url")


def test_connection_error():
    """Test handling of connection errors."""
    with pytest.raises(httpx.ConnectError):
        # Try to connect to non-existent server
        httpx.get("http://invalid.nonexistent.domain.test")
```

---

## J. Best Practices Learned

From your first tests:

1. **‚úÖ Clear test names** - `test_get_request_returns_200` explains exactly what's tested

2. **‚úÖ One thing per test** - Each test verifies one specific behavior

3. **‚úÖ Arrange-Act-Assert pattern**:
   ```python
   def test_example():
       # Arrange - set up test data
       url = "https://httpbin.org/get"
       
       # Act - perform the action
       response = httpx.get(url)
       
       # Assert - verify the result
       assert response.status_code == 200
   ```

4. **‚úÖ Use Client for multiple requests** - Better performance

5. **‚úÖ Test both success and failure** - Don't just test happy paths

---

## K. Common Stumbling Blocks

### Mistake 1: Forgetting to check status code first
```python
# ‚ùå Bad - might fail if request failed
def test_bad():
    response = httpx.get("https://httpbin.org/get")
    data = response.json()  # Fails if status != 200

# ‚úÖ Good - verify status first
def test_good():
    response = httpx.get("https://httpbin.org/get")
    assert response.status_code == 200
    data = response.json()
```

### Mistake 2: Not using context manager for Client
```python
# ‚ùå Bad - connection not properly closed
client = httpx.Client()
response = client.get("...")

# ‚úÖ Good - automatically closes
with httpx.Client() as client:
    response = client.get("...")
```

### Mistake 3: Hardcoding URLs everywhere
```python
# ‚ùå Bad - URL repeated everywhere
def test_1():
    response = httpx.get("https://httpbin.org/get")

def test_2():
    response = httpx.get("https://httpbin.org/post")

# ‚úÖ Good - use base_url with Client
with httpx.Client(base_url="https://httpbin.org") as client:
    response1 = client.get("/get")
    response2 = client.post("/post")
```

---

## L. Quick Exercise

**Challenge**: Write three tests:
1. Test GET request to `/uuid` returns valid UUID
2. Test POST request to `/anything` echoes back your data
3. Test GET to `/delay/2` completes in 2-3 seconds

**Solution**:
```python
import httpx
import time


def test_uuid_endpoint():
    """Test UUID endpoint returns valid UUID."""
    response = httpx.get("https://httpbin.org/uuid")
    assert response.status_code == 200
    
    data = response.json()
    assert "uuid" in data
    assert len(data["uuid"]) == 36  # UUID format


def test_anything_endpoint_echoes_data():
    """Test /anything endpoint echoes back data."""
    payload = {"message": "hello", "value": 42}
    
    response = httpx.post(
        "https://httpbin.org/anything",
        json=payload
    )
    
    assert response.status_code == 200
    data = response.json()
    assert data["json"] == payload


def test_delay_endpoint_timing():
    """Test delay endpoint takes expected time."""
    start = time.time()
    
    response = httpx.get("https://httpbin.org/delay/2", timeout=5.0)
    
    end = time.time()
    elapsed = end - start
    
    assert response.status_code == 200
    assert 2.0 <= elapsed <= 3.0  # Should take 2-3 seconds
```

---

## M. Key Takeaways

üîë **httpx.get(url)**: Makes GET request, returns Response  
üîë **response.status_code**: HTTP status code (200, 404, etc.)  
üîë **response.json()**: Parses JSON response to Python dict  
üîë **response.headers**: Dictionary of response headers  
üîë **httpx.Client()**: Use for multiple requests (connection pooling)  
üîë **with statement**: Always use for Client (auto-cleanup)  
üîë **Arrange-Act-Assert**: Clear test structure  
üîë **Test failures too**: Not just success cases  

---

## N. What's Next?

In **Lesson 1.9: httpx Client Basics**, we'll dive deeper into httpx.Client:
- Configuration options
- Base URLs and default headers
- Timeouts and retries
- Connection pooling
- When to use Client vs simple httpx.get()

You've written your first API tests! Now let's level up with Client mastery. üöÄ

**Ready for lesson 1.9?**
