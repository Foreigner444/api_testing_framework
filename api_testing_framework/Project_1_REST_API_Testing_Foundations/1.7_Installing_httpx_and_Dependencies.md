# Lesson 1.7: Installing httpx and Dependencies

## A. Concept Overview

### What & Why
**Installing and managing dependencies** properly ensures your project is reproducible, portable, and maintainable. It's important because it allows anyone (including your future self!) to set up the project quickly and ensures everyone is using the same versions of libraries.

### Analogy
Think of your project like a recipe. The `requirements.txt` file is like the ingredient listâ€”it tells anyone who wants to make your dish (run your tests) exactly what they need and in what quantities (versions). Without it, they might use the wrong ingredients and get different results!

---

## B. Project Setup Review

Let's make sure your project structure is correct:

```
api_testing_project/
â”œâ”€â”€ venv/                  # Virtual environment
â”œâ”€â”€ tests/                 # Test files
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ test_example.py
â”œâ”€â”€ .gitignore
â”œâ”€â”€ pytest.ini
â””â”€â”€ requirements.txt       # We'll update this now!
```

If you don't have this structure yet, create it now:

```bash
mkdir -p api_testing_project/tests
cd api_testing_project
touch tests/__init__.py
```

---

## C. Installing httpx

### Step 1: Activate Virtual Environment

**On Mac/Linux**:
```bash
source venv/bin/activate
```

**On Windows**:
```bash
venv\Scripts\activate
```

**Verify activation** (you should see `(venv)` in your prompt):
```bash
(venv) $ 
```

---

### Step 2: Install httpx

```bash
pip install httpx
```

**Expected output**:
```
Collecting httpx
  Downloading httpx-0.27.0-py3-none-any.whl
Collecting httpcore...
Collecting certifi...
Collecting sniffio...
Installing collected packages: ...
Successfully installed httpx-0.27.0 ...
```

---

### Step 3: Install httpx with HTTP/2 Support (Optional but Recommended)

```bash
pip install httpx[http2]
```

**What this does**:
- Installs base httpx package
- Adds HTTP/2 support via `h2` library
- Enables modern protocol features

**Expected output**:
```
Collecting httpx[http2]
Collecting h2...
Successfully installed h2-4.1.0 ...
```

---

### Step 4: Verify Installation

```bash
python -c "import httpx; print(httpx.__version__)"
```

**Expected output**:
```
0.27.0
```

---

## D. Complete Dependencies for Project 1

For REST API testing, we need these core packages:

| Package | Version | Purpose |
|---------|---------|---------|
| **pytest** | >=8.0.0 | Testing framework |
| **httpx** | >=0.27.0 | HTTP client |
| **httpx[http2]** | >=0.27.0 | HTTP/2 support |

### Install All at Once

```bash
pip install pytest httpx[http2]
```

---

## E. Creating requirements.txt

### What is requirements.txt?

A text file that lists all project dependencies with their versions.

**Benefits**:
- âœ… Reproducible environment
- âœ… Easy setup for team members
- âœ… CI/CD pipeline compatibility
- âœ… Version control friendly
- âœ… Clear dependency documentation

---

### Method 1: Manual Creation (Recommended)

File: `requirements.txt`
```
# Core testing framework
pytest==8.0.0

# HTTP client with HTTP/2 support
httpx[http2]==0.27.0

# Additional dependencies (we'll add more in later projects)
# pytest-asyncio  # For async tests (Project 2)
# pydantic        # For data validation (Project 3)
# faker           # For test data (Project 4)
# allure-pytest   # For reporting (Project 8)
```

**Why exact versions (`==`)?**
- Ensures everyone uses same versions
- Prevents breaking changes
- Makes debugging easier
- Recommended for production

---

### Method 2: Generate from Current Environment

```bash
pip freeze > requirements.txt
```

**Pros**: Captures exact current state  
**Cons**: Includes ALL packages (even transitive dependencies)

**Result** (example):
```
anyio==4.3.0
certifi==2024.2.2
h2==4.1.0
hpack==4.0.0
httpcore==1.0.4
httpx==0.27.0
hyperframe==6.0.1
idna==3.6
iniconfig==2.0.0
packaging==24.0
pluggy==1.4.0
pytest==8.0.0
sniffio==1.3.1
```

**Too verbose!** Better to list only direct dependencies.

---

### Method 3: Best Practice (Hybrid)

File: `requirements.txt`
```
# ====================================
# Project 1: REST API Testing
# ====================================

# Testing Framework
pytest>=8.0.0,<9.0.0        # Range allows minor updates

# HTTP Client
httpx[http2]>=0.27.0,<1.0.0  # Allows compatible updates

# ====================================
# Development Tools (optional)
# ====================================
# pytest-cov        # Code coverage
# pytest-xdist      # Parallel execution
# black             # Code formatter
# mypy              # Type checker
```

**Version specifiers**:
- `==8.0.0` - Exact version (most strict)
- `>=8.0.0` - At least this version
- `>=8.0.0,<9.0.0` - Compatible range (recommended)
- `~=8.0.0` - Compatible release (8.0.x)

---

## F. Installing from requirements.txt

### Install All Dependencies

```bash
pip install -r requirements.txt
```

**Expected output**:
```
Collecting pytest>=8.0.0
Collecting httpx[http2]>=0.27.0
...
Successfully installed ...
```

### Verify Installation

```bash
pip list
```

**Expected output**:
```
Package    Version
---------- -------
httpx      0.27.0
pytest     8.0.0
...
```

---

## G. Understanding httpx Dependencies

When you install httpx, these get installed automatically:

| Package | Purpose |
|---------|---------|
| **httpcore** | Low-level HTTP implementation |
| **certifi** | SSL certificate bundle |
| **idna** | Internationalized domain names |
| **sniffio** | Async library detection |
| **h2** (with http2) | HTTP/2 protocol implementation |
| **hpack** (with http2) | HTTP/2 header compression |

**You don't need to manage these manually!** They're **transitive dependencies** (dependencies of dependencies).

---

## H. Verifying httpx Installation with Test

Let's verify httpx works by making a real request!

File: `tests/test_httpx_installation.py`
```python
"""
Test to verify httpx is installed and working correctly.
"""
import httpx


def test_httpx_can_make_request():
    """Verify httpx can make a simple GET request."""
    # Use a free, public API for testing
    response = httpx.get("https://httpbin.org/get")
    
    # Check response
    assert response.status_code == 200
    assert "application/json" in response.headers["content-type"]
    
    # Parse JSON
    data = response.json()
    assert "url" in data
    assert data["url"] == "https://httpbin.org/get"


def test_httpx_can_send_json():
    """Verify httpx can send JSON data."""
    payload = {"name": "Test User", "email": "test@example.com"}
    
    response = httpx.post(
        "https://httpbin.org/post",
        json=payload
    )
    
    assert response.status_code == 200
    data = response.json()
    assert data["json"] == payload


def test_httpx_client_works():
    """Verify httpx Client works with context manager."""
    with httpx.Client() as client:
        response = client.get("https://httpbin.org/get")
        assert response.status_code == 200


def test_httpx_has_http2_support():
    """Verify HTTP/2 support is available."""
    try:
        import h2
        # If this doesn't raise ImportError, HTTP/2 is available
        assert True, "HTTP/2 support available"
    except ImportError:
        assert False, "HTTP/2 support not installed"
```

### Run the Test

```bash
pytest tests/test_httpx_installation.py -v
```

**Expected output**:
```
tests/test_httpx_installation.py::test_httpx_can_make_request PASSED
tests/test_httpx_installation.py::test_httpx_can_send_json PASSED
tests/test_httpx_installation.py::test_httpx_client_works PASSED
tests/test_httpx_installation.py::test_httpx_has_http2_support PASSED

=================== 4 passed in 1.23s ===================
```

**If all tests pass**: âœ… httpx is installed correctly!  
**If any fail**: Check error messages and verify installation steps.

---

## I. Managing Dependencies Over Time

### Checking for Outdated Packages

```bash
pip list --outdated
```

**Example output**:
```
Package  Version  Latest   Type
-------- -------- -------- -----
httpx    0.26.0   0.27.0   wheel
pytest   7.4.0    8.0.0    wheel
```

### Upgrading Packages

**Upgrade specific package**:
```bash
pip install --upgrade httpx
```

**Upgrade all packages** (not recommended):
```bash
pip install --upgrade -r requirements.txt
```

**Better approach**: Upgrade one at a time and test!

### Pin Versions After Testing

Once you verify a version works, pin it in requirements.txt:
```
httpx==0.27.0  # Tested and working
```

---

## J. Development vs Production Dependencies

### Split Requirements (Best Practice for Large Projects)

**File**: `requirements.txt` (production)
```
# Production dependencies
pytest>=8.0.0
httpx[http2]>=0.27.0
```

**File**: `requirements-dev.txt` (development)
```
# Include production requirements
-r requirements.txt

# Development-only tools
pytest-cov>=4.0.0      # Code coverage
pytest-xdist>=3.0.0    # Parallel execution
black>=24.0.0          # Code formatter
mypy>=1.8.0            # Type checker
ruff>=0.2.0            # Linter
ipython>=8.0.0         # Better REPL
```

**Install for development**:
```bash
pip install -r requirements-dev.txt
```

---

## K. Common Dependency Issues and Solutions

### Issue 1: Module Not Found Error

**Error**:
```
ModuleNotFoundError: No module named 'httpx'
```

**Causes**:
1. Virtual environment not activated
2. Package not installed
3. Wrong Python interpreter

**Solutions**:
```bash
# 1. Activate venv
source venv/bin/activate

# 2. Install package
pip install httpx

# 3. Verify Python
which python  # Should point to venv/bin/python
```

---

### Issue 2: Version Conflicts

**Error**:
```
ERROR: pip's dependency resolver does not currently take into account all the packages that are installed.
```

**Solution**:
```bash
# Start fresh
pip uninstall httpx pytest
pip install -r requirements.txt
```

---

### Issue 3: Permission Errors

**Error**:
```
ERROR: Could not install packages due to an OSError: [Errno 13] Permission denied
```

**Wrong Solution**: âŒ `sudo pip install ...` (don't do this!)

**Right Solution**: âœ… Use virtual environment
```bash
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

---

## L. Setting Up .gitignore (Important!)

Never commit your virtual environment or cache files to Git!

File: `.gitignore`
```gitignore
# Virtual Environment
venv/
env/
ENV/
.venv/

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python

# pytest
.pytest_cache/
.coverage
htmlcov/
.tox/

# IDEs
.vscode/
.idea/
*.swp
*.swo
.DS_Store

# Environment variables (we'll use this in Project 5)
.env
.env.local
```

**Why?**
- Virtual environments are huge (100MB+)
- Can be recreated from requirements.txt
- Cache files are machine-specific
- Environment files contain secrets

---

## M. Complete Setup Checklist

âœ… **Virtual environment created**
```bash
python3 -m venv venv
```

âœ… **Virtual environment activated**
```bash
source venv/bin/activate  # Mac/Linux
```

âœ… **pytest installed**
```bash
pip install pytest
```

âœ… **httpx installed with HTTP/2**
```bash
pip install httpx[http2]
```

âœ… **requirements.txt created**
```
pytest>=8.0.0
httpx[http2]>=0.27.0
```

âœ… **.gitignore created** (excludes venv and cache)

âœ… **Installation verified**
```bash
pytest tests/test_httpx_installation.py -v
```

---

## N. Quick Reference Commands

```bash
# Create virtual environment
python3 -m venv venv

# Activate venv
source venv/bin/activate  # Mac/Linux
venv\Scripts\activate      # Windows

# Install from requirements.txt
pip install -r requirements.txt

# Add new package
pip install package-name
pip freeze > requirements.txt  # Update requirements

# List installed packages
pip list

# Check for updates
pip list --outdated

# Upgrade package
pip install --upgrade package-name

# Deactivate venv
deactivate
```

---

## O. Key Takeaways

ðŸ”‘ **Always use virtual environment**: Isolates dependencies  
ðŸ”‘ **requirements.txt**: Lists project dependencies  
ðŸ”‘ **Pin versions**: Use `==` for reproducibility  
ðŸ”‘ **httpx[http2]**: Installs httpx with HTTP/2 support  
ðŸ”‘ **Verify installation**: Run test to confirm setup  
ðŸ”‘ **.gitignore**: Never commit venv or cache  
ðŸ”‘ **Activate venv first**: Before any pip command  

---

## P. Common Stumbling Blocks

### Mistake 1: Forgetting to activate venv
**Symptom**: "Command not found" or wrong Python version

**Fix**: Always activate first!
```bash
source venv/bin/activate
```

### Mistake 2: Installing globally instead of in venv
**Symptom**: Packages work in terminal but not in tests

**Fix**: Delete global packages, use venv

### Mistake 3: Committing venv to Git
**Symptom**: Huge repository, merge conflicts

**Fix**: Add venv/ to .gitignore

---

## Q. Quick Exercise

Try this yourself!

**Task**: Set up a new project with httpx:
1. Create virtual environment
2. Activate it
3. Install pytest and httpx[http2]
4. Create requirements.txt
5. Run verification test

**Time**: 5-10 minutes

---

## R. What's Next?

In **Lesson 1.8: Your First API Test with httpx**, we'll finally write a real API test! You'll:
- Make your first HTTP request with httpx
- Parse JSON responses
- Write assertions for status codes and data
- Use a public API for testing
- See httpx in action!

Your environment is ready. Time to write some code! ðŸš€

**Ready to write your first API test?**
