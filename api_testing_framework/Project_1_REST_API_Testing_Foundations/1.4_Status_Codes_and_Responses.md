# Lesson 1.4: Status Codes and Responses

## A. Concept Overview

### What & Why
**HTTP Status Codes** are three-digit numbers that the server sends back to tell you whether your request succeeded, failed, or needs further action. They're important because they're the API's way of communicating what happenedâ€”like a receipt that says "success," "error," or "try again."

### Analogy
Think of status codes like traffic lights:
- **2xx (Green)** ğŸŸ¢: Success! Keep going.
- **3xx (Yellow)** ğŸŸ¡: Redirectâ€”you need to go somewhere else.
- **4xx (Red - Your fault)** ğŸ”´: You made a mistake (wrong turn, no access).
- **5xx (Red - Their fault)** ğŸ”´: Server problem (road closed, construction).

Just like you need to know what traffic lights mean to drive, you need to know status codes to test APIs!

---

## B. The Five Categories of Status Codes

| Range | Category | Meaning | Who's Responsible |
|-------|----------|---------|-------------------|
| **1xx** | Informational | Request received, continuing process | Server |
| **2xx** | Success | Request succeeded | - |
| **3xx** | Redirection | Further action needed | Server/Client |
| **4xx** | Client Error | You made a mistake | **You (Client)** |
| **5xx** | Server Error | Server failed | **Server** |

---

## C. 2xx Success Status Codes

These mean your request worked! ğŸ‰

### 200 OK
**What it means**: Request succeeded. Here's your data.  
**Used with**: GET, PUT, PATCH, DELETE (sometimes)  
**Response has body**: Usually yes

**Example**:
```http
GET /api/users/1 HTTP/1.1

Response:
HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "name": "John Doe",
  "email": "john@example.com"
}
```

**When to expect 200**:
- âœ… GET request returns data
- âœ… PUT/PATCH updates successfully
- âœ… DELETE with confirmation message

---

### 201 Created
**What it means**: New resource created successfully!  
**Used with**: POST  
**Response has body**: Yes (the new resource)  
**Special header**: `Location` (URL of new resource)

**Example**:
```http
POST /api/users HTTP/1.1
Content-Type: application/json

{
  "name": "Alice",
  "email": "alice@example.com"
}

Response:
HTTP/1.1 201 Created
Location: /api/users/123
Content-Type: application/json

{
  "id": 123,
  "name": "Alice",
  "email": "alice@example.com",
  "created_at": "2024-01-15T10:30:00Z"
}
```

**When to expect 201**:
- âœ… POST creates new user
- âœ… POST creates new order
- âœ… POST uploads new file

---

### 202 Accepted
**What it means**: Request accepted, processing will happen later.  
**Used with**: POST, PUT, DELETE (for async operations)  
**Response has body**: Sometimes (with status URL)

**Example**:
```http
POST /api/reports/generate HTTP/1.1

Response:
HTTP/1.1 202 Accepted
Content-Type: application/json

{
  "message": "Report generation started",
  "status_url": "/api/reports/status/abc123",
  "estimated_time": "5 minutes"
}
```

**When to expect 202**:
- âœ… Long-running background jobs
- âœ… Batch processing
- âœ… Video encoding, report generation

---

### 204 No Content
**What it means**: Success, but no data to return.  
**Used with**: DELETE, PUT, PATCH  
**Response has body**: **No**

**Example**:
```http
DELETE /api/users/1 HTTP/1.1

Response:
HTTP/1.1 204 No Content
(no body)
```

**When to expect 204**:
- âœ… DELETE successful
- âœ… Update successful (when you don't need the updated resource back)

---

## D. 3xx Redirection Status Codes

These mean "go somewhere else."

### 301 Moved Permanently
**What it means**: Resource permanently moved to new URL.  
**Action**: Client should use new URL from now on.

**Example**:
```http
GET /api/v1/users HTTP/1.1

Response:
HTTP/1.1 301 Moved Permanently
Location: /api/v2/users
```

---

### 302 Found / 303 See Other
**What it means**: Temporary redirect.  
**Action**: Use new URL for this request only.

---

### 304 Not Modified
**What it means**: Resource hasn't changed since last request (caching).  
**Used with**: GET (with caching headers)

---

## E. 4xx Client Error Status Codes

These mean **YOU** made a mistake! ğŸ”´

### 400 Bad Request
**What it means**: Your request is malformed or invalid.  
**Common causes**:
- Invalid JSON syntax
- Missing required fields
- Wrong data types
- Invalid field values

**Example 1: Invalid JSON**:
```http
POST /api/users HTTP/1.1
Content-Type: application/json

{
  "name": "John",
  "email": "john@example.com"  // Missing closing brace!

Response:
HTTP/1.1 400 Bad Request
Content-Type: application/json

{
  "error": "Invalid JSON",
  "message": "Unexpected end of JSON input"
}
```

**Example 2: Validation Error**:
```http
POST /api/users HTTP/1.1
Content-Type: application/json

{
  "name": "",
  "email": "not-an-email"
}

Response:
HTTP/1.1 400 Bad Request
Content-Type: application/json

{
  "error": "Validation failed",
  "details": {
    "name": "Name cannot be empty",
    "email": "Must be a valid email address"
  }
}
```

**When to expect 400**:
- âŒ Missing required fields
- âŒ Invalid data format
- âŒ Field validation fails
- âŒ Invalid JSON/XML

---

### 401 Unauthorized
**What it means**: You need to authenticate (log in).  
**Common causes**:
- Missing authentication token
- Invalid credentials
- Expired token

**Example**:
```http
GET /api/users/me HTTP/1.1

Response:
HTTP/1.1 401 Unauthorized
WWW-Authenticate: Bearer

{
  "error": "Authentication required",
  "message": "No valid authentication token provided"
}
```

**When to expect 401**:
- âŒ No auth token sent
- âŒ Invalid token
- âŒ Expired token

**How to fix**: Include authentication (we'll learn this in Project 6!)

---

### 403 Forbidden
**What it means**: You're authenticated, but don't have permission.  
**Difference from 401**: You're logged in, just not allowed to do this.

**Example**:
```http
DELETE /api/users/999 HTTP/1.1
Authorization: Bearer <valid-user-token>

Response:
HTTP/1.1 403 Forbidden
Content-Type: application/json

{
  "error": "Forbidden",
  "message": "You don't have permission to delete this user"
}
```

**When to expect 403**:
- âŒ User role doesn't have access
- âŒ Resource belongs to someone else
- âŒ Action not allowed for your account type

**401 vs 403**:
- **401**: "Who are you?" (not logged in)
- **403**: "I know who you are, but you can't do that" (no permission)

---

### 404 Not Found
**What it means**: Resource doesn't exist.  
**Common causes**:
- Wrong ID
- Resource was deleted
- Typo in URL

**Example**:
```http
GET /api/users/99999 HTTP/1.1

Response:
HTTP/1.1 404 Not Found
Content-Type: application/json

{
  "error": "Not found",
  "message": "User with ID 99999 does not exist"
}
```

**When to expect 404**:
- âŒ Resource ID doesn't exist
- âŒ Wrong endpoint URL
- âŒ Resource was deleted

---

### 405 Method Not Allowed
**What it means**: HTTP method not supported for this endpoint.  

**Example**:
```http
DELETE /api/health HTTP/1.1

Response:
HTTP/1.1 405 Method Not Allowed
Allow: GET, POST
Content-Type: application/json

{
  "error": "Method not allowed",
  "message": "DELETE is not supported for this endpoint",
  "allowed_methods": ["GET", "POST"]
}
```

**When to expect 405**:
- âŒ Using POST on read-only endpoint
- âŒ Using DELETE on endpoint that doesn't support it

---

### 409 Conflict
**What it means**: Request conflicts with current server state.  
**Common causes**:
- Duplicate resource
- Version conflict
- Business rule violation

**Example**:
```http
POST /api/users HTTP/1.1
Content-Type: application/json

{
  "email": "existing@example.com"
}

Response:
HTTP/1.1 409 Conflict
Content-Type: application/json

{
  "error": "Conflict",
  "message": "User with this email already exists",
  "code": "DUPLICATE_EMAIL"
}
```

**When to expect 409**:
- âŒ Duplicate email/username
- âŒ Conflicting updates (optimistic locking)
- âŒ State transition not allowed

---

### 422 Unprocessable Entity
**What it means**: Request is well-formed, but semantically incorrect.  
**Difference from 400**: JSON is valid, but business logic rejects it.

**Example**:
```http
POST /api/orders HTTP/1.1
Content-Type: application/json

{
  "product_id": 123,
  "quantity": -5  // Negative quantity!
}

Response:
HTTP/1.1 422 Unprocessable Entity
Content-Type: application/json

{
  "error": "Unprocessable entity",
  "details": {
    "quantity": "Must be a positive number"
  }
}
```

**When to expect 422**:
- âŒ Business logic validation fails
- âŒ Invalid value ranges
- âŒ Semantic errors

---

### 429 Too Many Requests
**What it means**: Rate limit exceeded.  

**Example**:
```http
GET /api/users HTTP/1.1

Response:
HTTP/1.1 429 Too Many Requests
Retry-After: 60
Content-Type: application/json

{
  "error": "Rate limit exceeded",
  "message": "Maximum 100 requests per minute. Try again in 60 seconds",
  "retry_after": 60
}
```

---

## F. 5xx Server Error Status Codes

These mean **THE SERVER** messed up! ğŸ”´

### 500 Internal Server Error
**What it means**: Generic server error.  
**Who's responsible**: Server (not you!)

**Example**:
```http
GET /api/users HTTP/1.1

Response:
HTTP/1.1 500 Internal Server Error
Content-Type: application/json

{
  "error": "Internal server error",
  "message": "An unexpected error occurred",
  "request_id": "abc-123-def"
}
```

**Common causes**:
- Unhandled exception in server code
- Database connection failed
- Bug in API code

**What to do**: Report to API developers with request details.

---

### 502 Bad Gateway
**What it means**: Server received invalid response from upstream server.  
**Common causes**:
- API gateway can't reach backend
- Backend crashed
- Network issues between services

---

### 503 Service Unavailable
**What it means**: Server temporarily unavailable.  
**Common causes**:
- Maintenance mode
- Overloaded server
- Temporary shutdown

**Example**:
```http
GET /api/users HTTP/1.1

Response:
HTTP/1.1 503 Service Unavailable
Retry-After: 300
Content-Type: application/json

{
  "error": "Service unavailable",
  "message": "System maintenance in progress",
  "retry_after": 300
}
```

---

### 504 Gateway Timeout
**What it means**: Server didn't receive timely response from upstream.  
**Common causes**:
- Backend is too slow
- Database query timeout
- Network timeout

---

## G. Status Code Decision Tree

Use this to determine what status code to expect:

```
Did the request succeed?
â”œâ”€ YES â†’ 2xx
â”‚  â”œâ”€ Was something created? â†’ 201 Created
â”‚  â”œâ”€ Is there data to return? â†’ 200 OK
â”‚  â””â”€ No data to return? â†’ 204 No Content
â”‚
â””â”€ NO â†’ Error
   â”œâ”€ Is it my (client) fault?
   â”‚  â”œâ”€ YES â†’ 4xx
   â”‚  â”‚  â”œâ”€ Invalid request format? â†’ 400 Bad Request
   â”‚  â”‚  â”œâ”€ Not logged in? â†’ 401 Unauthorized
   â”‚  â”‚  â”œâ”€ No permission? â†’ 403 Forbidden
   â”‚  â”‚  â”œâ”€ Resource not found? â†’ 404 Not Found
   â”‚  â”‚  â”œâ”€ Wrong HTTP method? â†’ 405 Method Not Allowed
   â”‚  â”‚  â”œâ”€ Duplicate/conflict? â†’ 409 Conflict
   â”‚  â”‚  â””â”€ Business logic failed? â†’ 422 Unprocessable Entity
   â”‚  â”‚
   â””â”€â”€â””â”€ NO, server's fault â†’ 5xx
      â”œâ”€ Generic error? â†’ 500 Internal Server Error
      â”œâ”€ Backend unreachable? â†’ 502 Bad Gateway
      â”œâ”€ Temporarily down? â†’ 503 Service Unavailable
      â””â”€ Timeout? â†’ 504 Gateway Timeout
```

---

## H. What to Test for Each Status Code

### Testing Success Codes (2xx)

```python
# Example test structure (we'll write real code soon!)
def test_get_user_returns_200():
    # Assert status code is 200
    # Assert response has expected data
    # Assert data types are correct
    pass

def test_create_user_returns_201():
    # Assert status code is 201
    # Assert response contains new user with ID
    # Assert Location header present
    pass

def test_delete_user_returns_204():
    # Assert status code is 204
    # Assert response body is empty
    # Assert user is actually deleted
    pass
```

### Testing Error Codes (4xx)

```python
def test_invalid_data_returns_400():
    # Send invalid data
    # Assert status code is 400
    # Assert error message explains what's wrong
    pass

def test_missing_auth_returns_401():
    # Don't send auth token
    # Assert status code is 401
    # Assert error indicates authentication needed
    pass

def test_nonexistent_resource_returns_404():
    # Request resource that doesn't exist
    # Assert status code is 404
    # Assert error message clear
    pass

def test_duplicate_email_returns_409():
    # Try to create user with existing email
    # Assert status code is 409
    # Assert error indicates duplicate
    pass
```

---

## I. Common Status Code Testing Patterns

### Pattern 1: Happy Path (Success)
```
1. Send valid request
2. Assert 200/201/204
3. Assert response data correct
4. Verify side effects (resource created/updated/deleted)
```

### Pattern 2: Invalid Input
```
1. Send invalid data
2. Assert 400/422
3. Assert error message helpful
4. Verify nothing was changed on server
```

### Pattern 3: Authentication/Authorization
```
1. Send request without auth
2. Assert 401 (no auth) or 403 (no permission)
3. Verify resource protected
```

### Pattern 4: Not Found
```
1. Request non-existent resource
2. Assert 404
3. Verify error message clear
```

---

## J. Response Body Structures

### Success Response
```json
{
  "id": 123,
  "name": "John Doe",
  "email": "john@example.com",
  "created_at": "2024-01-15T10:30:00Z"
}
```

### Error Response (Good Practice)
```json
{
  "error": "Validation failed",
  "message": "The request contains invalid data",
  "code": "VALIDATION_ERROR",
  "details": {
    "email": "Must be a valid email address",
    "age": "Must be at least 18"
  },
  "request_id": "abc-123-def",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

**Good error responses include**:
- âœ… Clear error type/code
- âœ… Human-readable message
- âœ… Specific field errors
- âœ… Request ID (for support)
- âœ… Timestamp

---

## K. Common Stumbling Blocks

### Mistake 1: Confusing 401 and 403
**Wrong**: Thinking they're the same  
**Right**:
- **401**: "I don't know who you are" â†’ Need to log in
- **403**: "I know who you are, but you can't do this" â†’ No permission

### Mistake 2: Expecting 200 for POST
**Wrong**: Expecting `200 OK` when creating resource  
**Right**: Should be `201 Created`

### Mistake 3: Not Checking Error Response Body
**Wrong**: Only checking status code  
**Right**: Also validate error message and details

```python
# âŒ Bad test
assert response.status_code == 400

# âœ… Good test
assert response.status_code == 400
assert "email" in response.json()["details"]
assert "required" in response.json()["details"]["email"].lower()
```

### Mistake 4: Testing Only Happy Paths
**Wrong**: Only testing successful requests  
**Right**: Test errors too! They're just as important.

---

## L. HTTP Status Code Cheat Sheet

**Quick Reference**:

| Code | Name | Meaning | Test For |
|------|------|---------|----------|
| **200** | OK | Success | Response data correct |
| **201** | Created | Resource created | New ID returned, Location header |
| **204** | No Content | Success, no data | Empty body |
| **400** | Bad Request | Invalid input | Error details present |
| **401** | Unauthorized | Not authenticated | Auth required message |
| **403** | Forbidden | No permission | Permission denied message |
| **404** | Not Found | Resource missing | Clear error message |
| **409** | Conflict | Duplicate/conflict | Conflict reason explained |
| **422** | Unprocessable | Business logic fail | Validation details |
| **429** | Too Many Requests | Rate limited | Retry-After header |
| **500** | Internal Error | Server problem | Request ID for debugging |
| **502** | Bad Gateway | Upstream failed | - |
| **503** | Unavailable | Temporarily down | Retry-After header |

---

## M. Key Takeaways

ğŸ”‘ **2xx**: Success (200 OK, 201 Created, 204 No Content)  
ğŸ”‘ **3xx**: Redirection (301, 302, 304)  
ğŸ”‘ **4xx**: Client error - YOUR fault (400, 401, 403, 404, 409, 422)  
ğŸ”‘ **5xx**: Server error - THEIR fault (500, 502, 503, 504)  
ğŸ”‘ **401 vs 403**: Not logged in vs No permission  
ğŸ”‘ **400 vs 422**: Malformed vs Invalid business logic  
ğŸ”‘ Test both success AND error status codes!

---

## N. Quick Check

Can you answer these?

1. What status code means "resource created successfully"?
2. What's the difference between 401 and 403?
3. Should DELETE return 200 or 204?
4. Who's at fault for a 404 error?
5. What does 500 mean, and who's responsible?

---

## O. What's Next?

In **Lesson 1.5: Setting Up pytest for API Testing**, we'll finally start writing code! We'll install pytest, set up our first test file, and understand how pytest works.

You now understand the "language" APIs speak through status codes. Time to start testing! ğŸš€

**Ready to start coding?**
