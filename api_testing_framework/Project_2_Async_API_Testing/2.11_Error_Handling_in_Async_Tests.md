# Lesson 2.11: Error Handling in Async Tests

## A. Concept Overview

Error handling in async tests requires understanding both Python exceptions and async-specific errors.

---

## B. Common Async Errors

### TimeoutError

```python
@pytest.mark.asyncio
async def test_timeout():
    with pytest.raises(httpx.TimeoutException):
        async with httpx.AsyncClient(timeout=0.1) as client:
            await client.get("https://httpbin.org/delay/10")
```

### Connection Errors

```python
@pytest.mark.asyncio
async def test_connection_error():
    with pytest.raises(httpx.ConnectError):
        async with httpx.AsyncClient() as client:
            await client.get("http://nonexistent.invalid.domain")
```

---

## C. Try/Except in Async

```python
@pytest.mark.asyncio
async def test_with_error_handling(api_client):
    try:
        response = await api_client.get("/users/99999")
        if response.status_code == 404:
            # Expected error
            assert True
    except httpx.HTTPError as e:
        pytest.fail(f"Unexpected error: {e}")
```

---

## D. Handling Errors in gather()

```python
@pytest.mark.asyncio
async def test_gather_error_handling(api_client):
    results = await asyncio.gather(
        api_client.get("/users/1"),
        api_client.get("/invalid/endpoint"),
        api_client.get("/users/2"),
        return_exceptions=True
    )
    
    successes = [r for r in results if isinstance(r, httpx.Response) and r.status_code == 200]
    errors = [r for r in results if isinstance(r, Exception) or (isinstance(r, httpx.Response) and r.status_code >= 400)]
    
    assert len(successes) >= 2  # At least 2 succeeded
```

---

## E. Key Takeaways

ğŸ”‘ Use try/except in async functions  
ğŸ”‘ pytest.raises() works with async  
ğŸ”‘ return_exceptions=True for gather()  
ğŸ”‘ Check response types after gather  

Ready for 2.12? ğŸš€
