# Lesson 2.5: Your First Async Test

## A. Concept Overview

### What & Why
Your **first async test** brings together everything learnedâ€”async functions, AsyncClient, pytest-asyncio. This is where async testing becomes real and tangible!

### Analogy
This is like your first time riding a bike after learning about it. Theory becomes practice, and you'll see async actually work!

---

## B. Your First Async Test

File: `tests/test_first_async.py`
```python
"""Your first async API test."""
import pytest
import httpx


@pytest.mark.asyncio
async def test_get_user_async():
    """Test GET request asynchronously."""
    # Create async client
    async with httpx.AsyncClient() as client:
        # Make async request
        response = await client.get("https://jsonplaceholder.typicode.com/users/1")
    
    # Assertions work normally
    assert response.status_code == 200
    data = response.json()
    assert data["id"] == 1
    assert "name" in data
```

### Line-by-Line

1. **Import pytest**: For @pytest.mark.asyncio
2. **Import httpx**: For AsyncClient
3. **@pytest.mark.asyncio**: Tells pytest this is async
4. **async def**: Defines async function
5. **async with**: Async context manager
6. **httpx.AsyncClient()**: Creates async client
7. **await client.get()**: Makes async request
8. **assert**: Normal pytest assertions

---

## C. Run Your First Async Test

```bash
pytest tests/test_first_async.py -v
```

**Output**:
```
tests/test_first_async.py::test_get_user_async PASSED [100%]

=================== 1 passed in 0.45s ===================
```

ğŸ‰ **Congratulations! Your first async test passed!**

---

## D. Multiple Concurrent Requests

```python
@pytest.mark.asyncio
async def test_three_users_concurrently():
    """Fetch 3 users at the same time."""
    async with httpx.AsyncClient(base_url="https://jsonplaceholder.typicode.com") as client:
        # Create tasks
        task1 = client.get("/users/1")
        task2 = client.get("/users/2")
        task3 = client.get("/users/3")
        
        # Run concurrently
        response1, response2, response3 = await asyncio.gather(task1, task2, task3)
    
    # Verify all
    assert response1.status_code == 200
    assert response2.status_code == 200
    assert response3.status_code == 200
    
    # Check data
    assert response1.json()["id"] == 1
    assert response2.json()["id"] == 2
    assert response3.json()["id"] == 3
```

---

## E. Using List Comprehension

```python
@pytest.mark.asyncio
async def test_ten_users_with_list_comprehension():
    """Fetch 10 users using list comprehension."""
    async with httpx.AsyncClient(base_url="https://jsonplaceholder.typicode.com") as client:
        # Create tasks with list comprehension
        tasks = [client.get(f"/users/{i}") for i in range(1, 11)]
        
        # Execute all concurrently
        responses = await asyncio.gather(*tasks)
    
    # Verify all succeeded
    assert len(responses) == 10
    
    for i, response in enumerate(responses, 1):
        assert response.status_code == 200
        assert response.json()["id"] == i
```

---

## F. Testing POST Async

```python
@pytest.mark.asyncio
async def test_create_post_async():
    """Test POST request asynchronously."""
    payload = {
        "title": "Test Post",
        "body": "This is a test",
        "userId": 1
    }
    
    async with httpx.AsyncClient(base_url="https://jsonplaceholder.typicode.com") as client:
        response = await client.post("/posts", json=payload)
    
    assert response.status_code == 201
    data = response.json()
    assert data["title"] == payload["title"]
    assert "id" in data
```

---

## G. Common Mistakes

### Mistake 1: Forgetting @pytest.mark.asyncio

**Error**:
```
PytestUnraisableExceptionWarning: Exception ignored
```

**Fix**: Add marker
```python
@pytest.mark.asyncio  # Don't forget!
async def test_something():
    pass
```

---

### Mistake 2: Forgetting await

```python
# âŒ Wrong
@pytest.mark.asyncio
async def test_wrong():
    async with httpx.AsyncClient() as client:
        response = client.get(url)  # Missing await!

# âœ… Correct
@pytest.mark.asyncio
async def test_correct():
    async with httpx.AsyncClient() as client:
        response = await client.get(url)  # Added await
```

---

## H. Key Takeaways

ğŸ”‘ **@pytest.mark.asyncio**: Required marker  
ğŸ”‘ **async def**: Define async test  
ğŸ”‘ **async with**: Async context manager  
ğŸ”‘ **await**: Wait for async operation  
ğŸ”‘ **asyncio.gather()**: Run multiple tasks  
ğŸ”‘ **AsyncClient**: httpx async client  

---

## I. What's Next?

Lesson 2.6: httpx AsyncClient Basics - Deep dive into AsyncClient!

Ready? ğŸš€
