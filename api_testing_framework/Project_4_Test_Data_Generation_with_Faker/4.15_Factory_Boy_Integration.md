# 4.15 Factory Boy Integration

## A. Concept Overview

### What & Why
**Factory Boy** is a powerful library specifically designed for creating test fixtures. It provides advanced features like lazy attributes, sequences, sub-factories, and traits â€“ all built-in. While our custom factories work great, Factory Boy scales better for large projects with complex data relationships.

### Analogy
Think of Factory Boy like upgrading from **a basic workshop to an automated factory**.

**Custom factories** (manual):
- You control everything
- Simple and straightforward
- Good for small projects

**Factory Boy** (automated):
- Built-in sequences, traits, lazy evaluation
- Handles complex relationships automatically
- Scales to enterprise projects

Both work, Factory Boy adds industrial-strength features!

---

## B. Code Implementation

### Installation

```bash
pip install factory-boy faker
```

### File Path: `factories/factory_boy_examples.py`

```python
"""Factory Boy integration examples."""
import factory
from factory import Faker as FactoryFaker
from faker import Faker
from decimal import Decimal
from models.user_models import User, Address, Company, Product

fake = Faker()


# ==================== Basic Factory Boy Factory ====================

class AddressFactory(factory.Factory):
    """Factory for Address model using Factory Boy."""
    
    class Meta:
        model = Address
    
    street = FactoryFaker('street_address')
    city = FactoryFaker('city')
    state = FactoryFaker('state_abbr')
    zipcode = FactoryFaker('zipcode')
    country = "USA"


class CompanyFactory(factory.Factory):
    """Factory for Company model."""
    
    class Meta:
        model = Company
    
    name = FactoryFaker('company')
    industry = FactoryFaker('random_element', elements=[
        "Technology", "Finance", "Healthcare", "Education"
    ])
    website = FactoryFaker('url')


class UserFactoryBoy(factory.Factory):
    """Factory for User model using Factory Boy."""
    
    class Meta:
        model = User
    
    # Sequences for unique IDs
    id = factory.Sequence(lambda n: n + 1)
    
    # Faker integration
    username = FactoryFaker('user_name')
    email = FactoryFaker('email')
    first_name = FactoryFaker('first_name')
    last_name = FactoryFaker('last_name')
    phone = FactoryFaker('phone_number')
    date_of_birth = FactoryFaker('date_of_birth', minimum_age=18, maximum_age=80)
    
    # Sub-factories (nested models)
    address = factory.SubFactory(AddressFactory)
    company = None
    
    bio = None
    website = None
    is_active = True
    created_at = FactoryFaker('date_time_this_year')


# ==================== Lazy Attributes ====================

class ProductFactoryBoy(factory.Factory):
    """Factory for Product with lazy attributes."""
    
    class Meta:
        model = Product
    
    id = factory.Sequence(lambda n: n + 1)
    
    # Lazy attribute - computed from other fields
    @factory.lazy_attribute
    def sku(self):
        """Generate SKU based on category."""
        category_code = self.category[:3].upper()
        random_num = fake.random_int(10000, 99999)
        return f"{category_code}-{random_num}"
    
    name = FactoryFaker('sentence', nb_words=3)
    description = FactoryFaker('text', max_nb_chars=500)
    
    @factory.lazy_attribute
    def price(self):
        """Generate price as Decimal."""
        return Decimal(str(fake.pyfloat(min_value=1, max_value=1000, right_digits=2)))
    
    category = FactoryFaker('random_element', elements=[
        "Electronics", "Clothing", "Books"
    ])
    
    stock_quantity = FactoryFaker('random_int', min=0, max=500)
    is_available = True
    tags = FactoryFaker('words', nb=3)
    created_at = FactoryFaker('date_time_this_year')


# ==================== Traits ====================

class UserWithTraits(factory.Factory):
    """User factory with traits."""
    
    class Meta:
        model = User
    
    id = factory.Sequence(lambda n: n + 1)
    username = FactoryFaker('user_name')
    email = FactoryFaker('email')
    first_name = FactoryFaker('first_name')
    last_name = FactoryFaker('last_name')
    phone = FactoryFaker('phone_number')
    date_of_birth = FactoryFaker('date_of_birth', minimum_age=18)
    address = factory.SubFactory(AddressFactory)
    company = None
    bio = None
    website = None
    is_active = True
    created_at = FactoryFaker('date_time_this_year')
    
    class Params:
        """Trait parameters."""
        
        # Trait: admin user
        admin = factory.Trait(
            username="admin",
            email="admin@example.com",
            is_active=True
        )
        
        # Trait: with company
        with_company = factory.Trait(
            company=factory.SubFactory(CompanyFactory)
        )
        
        # Trait: inactive
        inactive = factory.Trait(
            is_active=False
        )


# ==================== Post Generation Hook ====================

class UserWithHooks(factory.Factory):
    """User factory with post-generation hooks."""
    
    class Meta:
        model = User
    
    id = factory.Sequence(lambda n: n + 1)
    username = FactoryFaker('user_name')
    email = FactoryFaker('email')
    first_name = FactoryFaker('first_name')
    last_name = FactoryFaker('last_name')
    phone = FactoryFaker('phone_number')
    date_of_birth = FactoryFaker('date_of_birth')
    address = factory.SubFactory(AddressFactory)
    company = None
    bio = None
    website = None
    is_active = True
    created_at = FactoryFaker('date_time_this_year')
    
    @factory.post_generation
    def set_bio(obj, create, extracted, **kwargs):
        """Set bio after generation."""
        if extracted:
            obj.bio = extracted
        elif fake.boolean(chance_of_getting_true=30):
            obj.bio = fake.text(max_nb_chars=200)


# ==================== Convenience Functions ====================

def create_user_fb(**kwargs) -> User:
    """Create user using Factory Boy."""
    return UserFactoryBoy.create(**kwargs)


def create_product_fb(**kwargs) -> Product:
    """Create product using Factory Boy."""
    return ProductFactoryBoy.create(**kwargs)
```

---

### File Path: `tests/test_factory_boy.py`

```python
"""Tests for Factory Boy integration."""
import pytest
from factories.factory_boy_examples import (
    UserFactoryBoy,
    AddressFactory,
    CompanyFactory,
    ProductFactoryBoy,
    UserWithTraits,
    UserWithHooks,
    create_user_fb,
    create_product_fb
)
from models.user_models import User, Address, Product


def test_basic_factory_boy():
    """Test basic Factory Boy usage."""
    user = UserFactoryBoy.create()
    
    assert isinstance(user, User)
    assert user.id > 0
    assert "@" in user.email
    
    print(f"âœ… Factory Boy user: {user.username}")


def test_factory_boy_sequence():
    """Test automatic sequence generation."""
    user1 = UserFactoryBoy.create()
    user2 = UserFactoryBoy.create()
    user3 = UserFactoryBoy.create()
    
    # IDs should be sequential
    assert user2.id == user1.id + 1
    assert user3.id == user2.id + 1
    
    print(f"âœ… Sequences: {user1.id}, {user2.id}, {user3.id}")


def test_factory_boy_batch():
    """Test batch creation with Factory Boy."""
    users = UserFactoryBoy.create_batch(10)
    
    assert len(users) == 10
    assert all(isinstance(u, User) for u in users)
    
    # All should have sequential IDs
    ids = [u.id for u in users]
    assert ids == sorted(ids)
    
    print(f"âœ… Batch created {len(users)} users")


def test_sub_factory():
    """Test sub-factory for nested models."""
    user = UserFactoryBoy.create()
    
    # Address should be auto-generated by SubFactory
    assert isinstance(user.address, Address)
    assert len(user.address.city) > 0
    assert len(user.address.state) == 2
    
    print(f"âœ… Sub-factory: {user.address.city}, {user.address.state}")


def test_override_sub_factory():
    """Test overriding sub-factory values."""
    user = UserFactoryBoy.create(
        address__city="Boston",  # Override nested field!
        address__state="MA"
    )
    
    # Custom values used
    assert user.address.city == "Boston"
    assert user.address.state == "MA"
    
    print(f"âœ… Override sub-factory: {user.address.city}")


def test_lazy_attribute():
    """Test lazy attribute in product factory."""
    product1 = ProductFactoryBoy.create(category="Electronics")
    product2 = ProductFactoryBoy.create(category="Books")
    
    # SKU should start with category code
    assert product1.sku.startswith("ELE-")
    assert product2.sku.startswith("BOO-")
    
    print(f"âœ… Lazy attributes!")
    print(f"   Electronics: {product1.sku}")
    print(f"   Books: {product2.sku}")


def test_traits():
    """Test using traits."""
    # Regular user
    regular = UserWithTraits.create()
    assert regular.username != "admin"
    assert regular.company is None
    
    # Admin trait
    admin = UserWithTraits.create(admin=True)
    assert admin.username == "admin"
    assert admin.email == "admin@example.com"
    
    # With company trait
    with_company = UserWithTraits.create(with_company=True)
    assert with_company.company is not None
    
    # Multiple traits
    admin_with_company = UserWithTraits.create(admin=True, with_company=True)
    assert admin_with_company.username == "admin"
    assert admin_with_company.company is not None
    
    # Inactive trait
    inactive = UserWithTraits.create(inactive=True)
    assert inactive.is_active is False
    
    print(f"âœ… Traits work!")
    print(f"   Admin: {admin.username}")
    print(f"   With company: {with_company.company.name}")


def test_post_generation_hook():
    """Test post-generation hooks."""
    # Without bio
    user1 = UserWithHooks.create()
    # bio might be set randomly (30% chance)
    
    # With explicit bio
    user2 = UserWithHooks.create(set_bio="Custom bio text")
    assert user2.bio == "Custom bio text"
    
    print(f"âœ… Post-generation hooks work!")


def test_build_vs_create():
    """Test difference between build and create."""
    # Build doesn't save (useful for SQLAlchemy)
    # Create saves (useful for SQLAlchemy)
    # For our Pydantic models, both work the same
    
    built = UserFactoryBoy.build()
    created = UserFactoryBoy.create()
    
    assert isinstance(built, User)
    assert isinstance(created, User)
    
    print(f"âœ… Build and create both work!")


# ==================== Convenience Functions ====================

def test_convenience_functions():
    """Test convenience wrapper functions."""
    user = create_user_fb()
    product = create_product_fb()
    
    assert isinstance(user, User)
    assert isinstance(product, Product)
    
    print(f"âœ… Convenience functions work!")


# ==================== Advanced Patterns ====================

def test_factory_boy_with_httpx():
    """Test Factory Boy with httpx requests."""
    import httpx
    
    client = httpx.Client(base_url="https://jsonplaceholder.typicode.com")
    
    # Create user with Factory Boy
    user = UserFactoryBoy.create()
    
    # Use in API request
    request_data = {
        "name": f"{user.first_name} {user.last_name}",
        "email": user.email,
        "username": user.username
    }
    
    response = client.post("/users", json=request_data)
    assert response.status_code == 201
    
    print(f"âœ… Factory Boy + httpx: {user.username}")
```

---

## C. Connect & Apply

### How to Test It

```bash
# Install Factory Boy
pip install factory-boy

# Run tests
pytest tests/test_factory_boy.py -v -s
```

### Expected Result

```
tests/test_factory_boy.py::test_basic_factory_boy PASSED
âœ… Factory Boy user: jennifer_martinez

tests/test_factory_boy.py::test_factory_boy_sequence PASSED
âœ… Sequences: 1, 2, 3

tests/test_factory_boy.py::test_traits PASSED
âœ… Traits work!
   Admin: admin
   With company: Acme Corporation

======================== 13 passed in 1.12s =========================
```

---

## D. Factory Boy vs Custom Factories

| Feature | Custom | Factory Boy |
|---------|--------|-------------|
| **Learning curve** | Easy | Moderate |
| **Sequences** | Manual | Built-in |
| **Traits** | Manual | Built-in |
| **Sub-factories** | Manual | Built-in |
| **Lazy attributes** | Manual | Built-in |
| **Integration** | Direct | Via adapter |

---

## E. What You've Learned

âœ… Installing Factory Boy  
âœ… Basic Factory Boy factories  
âœ… Sequences for auto-incrementing IDs  
âœ… Sub-factories for nested models  
âœ… Traits for variations  
âœ… Lazy attributes  
âœ… Post-generation hooks  
âœ… Factory Boy + Pydantic integration  
âœ… When to use Factory Boy vs custom factories  

---

## F. What's Next?

In **Lesson 4.16 (Pytest Fixtures with Faker)**, we'll learn:
- Creating Faker-based pytest fixtures
- Reusable test data fixtures
- Fixture scoping and cleanup

Factory Boy mastered! ðŸŽ‰

---

**Ready for the next lesson?**
