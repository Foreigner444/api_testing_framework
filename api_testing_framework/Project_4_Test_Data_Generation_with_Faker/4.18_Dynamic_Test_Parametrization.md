# 4.18 Dynamic Test Parametrization

## A. Concept Overview

### What & Why
**Dynamic parametrization** combines pytest's `@pytest.mark.parametrize` with Faker to create data-driven tests that run with multiple realistic inputs automatically. Instead of hardcoding test cases, Faker generates them dynamically, giving you broader coverage with less code.

### Analogy
Think of parametrized tests with Faker like **testing a lock with many different keys**.

**Hardcoded parametrization**:
- Test with 3 specific keys you manually selected
- Limited coverage

**Faker parametrization**:
- Test with 100 random keys
- Each key is different and realistic
- Catches edge cases you wouldn't think of

Faker finds the keys that don't fit!

---

## B. Code Implementation

### File Path: `tests/test_parametrization_with_faker.py`

```python
"""Dynamic test parametrization with Faker."""
import pytest
import httpx
from faker import Faker
from pydantic import BaseModel, EmailStr, ValidationError
from factories.user_factory import UserFactory
from factories.product_factory import ProductFactory

fake = Faker()


# ==================== Basic Parametrization ====================

class UserCreate(BaseModel):
    """User creation model."""
    name: str
    email: EmailStr
    age: int


# Generate test data with Faker
test_users = [
    {"name": fake.name(), "email": fake.email(), "age": fake.random_int(18, 80)}
    for _ in range(5)
]


@pytest.mark.parametrize("user_data", test_users)
def test_user_creation_parametrized(user_data):
    """Test runs 5 times with different Faker data."""
    user = UserCreate.model_validate(user_data)
    
    assert user.age >= 18
    assert "@" in user.email
    
    print(f"âœ… Test passed for: {user.name} (age {user.age})")


# ==================== Parametrize with Fixtures ====================

@pytest.fixture(params=[fake.name() for _ in range(3)])
def user_name(request):
    """Parametrized fixture providing different names."""
    return request.param


def test_with_parametrized_fixture(user_name):
    """Test runs 3 times with different names."""
    assert isinstance(user_name, str)
    assert len(user_name) > 0
    
    print(f"âœ… Test with name: {user_name}")


# ==================== Generate Test Cases Dynamically ====================

def generate_test_cases(count: int):
    """Generate test cases dynamically."""
    Faker.seed(100)  # Reproducible
    fake_gen = Faker()
    
    return [
        {
            "name": fake_gen.name(),
            "email": fake_gen.email(),
            "age": fake_gen.random_int(18, 80)
        }
        for _ in range(count)
    ]


@pytest.mark.parametrize("user_data", generate_test_cases(10))
def test_with_generated_cases(user_data):
    """Test runs 10 times with dynamically generated data."""
    user = UserCreate.model_validate(user_data)
    
    assert user.age >= 18
    print(f"âœ… Generated test case: {user.name}")


# ==================== Parametrize Multiple Arguments ====================

ages = [fake.random_int(18, 30) for _ in range(5)]
names = [fake.name() for _ in range(5)]


@pytest.mark.parametrize("name,age", zip(names, ages))
def test_multiple_params(name, age):
    """Test with multiple parametrized arguments."""
    assert len(name) > 0
    assert 18 <= age <= 30
    
    print(f"âœ… Multi-param: {name}, age {age}")


# ==================== Parametrize with IDs ====================

user_scenarios = [
    pytest.param(
        fake.name(), 
        fake.email(), 
        25, 
        id="young_user"
    ),
    pytest.param(
        fake.name(), 
        fake.email(), 
        65, 
        id="senior_user"
    ),
    pytest.param(
        fake.name(), 
        fake.email(), 
        18, 
        id="minimum_age"
    )
]


@pytest.mark.parametrize("name,email,age", user_scenarios)
def test_with_scenario_ids(name, email, age):
    """Test with named scenarios."""
    user = UserCreate.model_validate({
        "name": name,
        "email": email,
        "age": age
    })
    
    assert user.age >= 18
    print(f"âœ… Scenario: {name}, age {age}")


# ==================== Edge Case Generation ====================

def generate_edge_cases():
    """Generate edge case test data."""
    Faker.seed(200)
    fake_edge = Faker()
    
    return [
        # Minimum age
        {"name": fake_edge.name(), "email": fake_edge.email(), "age": 18},
        # Maximum age
        {"name": fake_edge.name(), "email": fake_edge.email(), "age": 120},
        # Long name
        {"name": "A" * 50, "email": fake_edge.email(), "age": 30},
        # Special characters in name
        {"name": "Jean-Pierre O'Brien", "email": fake_edge.email(), "age": 40},
    ]


@pytest.mark.parametrize("user_data", generate_edge_cases())
def test_edge_cases(user_data):
    """Test edge cases generated with Faker."""
    user = UserCreate.model_validate(user_data)
    
    assert user.age >= 18
    print(f"âœ… Edge case: {user.name} (age {user.age})")


# ==================== API Testing with Parametrization ====================

# Generate API test data
api_test_data = [
    {
        "name": fake.name(),
        "email": fake.email(),
        "username": fake.user_name()
    }
    for _ in range(3)
]


@pytest.mark.parametrize("user_data", api_test_data)
def test_api_with_parametrized_faker(user_data):
    """Test API with parametrized Faker data."""
    client = httpx.Client(base_url="https://jsonplaceholder.typicode.com")
    
    response = client.post("/users", json=user_data)
    assert response.status_code == 201
    
    print(f"âœ… API test: Created {user_data['username']}")


# ==================== Factories in Parametrization ====================

test_products = [ProductFactory.create() for _ in range(5)]


@pytest.mark.parametrize("product", test_products)
def test_with_factory_instances(product):
    """Test parametrized with factory-generated instances."""
    assert product.id > 0
    assert product.price > 0
    
    print(f"âœ… Factory instance: {product.name} - ${product.price}")


# ==================== Parametrize with Pytest Fixtures ====================

@pytest.fixture(params=[UserFactory.create() for _ in range(3)])
def parametrized_user(request):
    """Parametrized fixture with factory."""
    return request.param


def test_with_parametrized_user_fixture(parametrized_user):
    """Test runs 3 times with different users from fixture."""
    assert parametrized_user.id > 0
    
    print(f"âœ… Parametrized fixture: {parametrized_user.username}")


# ==================== Combining Strategies ====================

scenarios = [
    pytest.param(
        UserFactory.create(is_active=True),
        "active_user",
        id="active"
    ),
    pytest.param(
        UserFactory.create(is_active=False),
        "inactive_user",
        id="inactive"
    ),
    pytest.param(
        UserFactory.create_admin(),
        "admin_user",
        id="admin"
    )
]


@pytest.mark.parametrize("user,expected_type", scenarios)
def test_combined_parametrization(user, expected_type):
    """Test with combined parametrization strategies."""
    if expected_type == "admin_user":
        assert user.username == "admin"
    elif expected_type == "active_user":
        assert user.is_active is True
    elif expected_type == "inactive_user":
        assert user.is_active is False
    
    print(f"âœ… Combined: {expected_type} - {user.username}")


# ==================== Stress Testing ====================

@pytest.mark.parametrize("execution_number", range(100))
def test_stress_with_faker(execution_number):
    """Test runs 100 times with different Faker data each time."""
    user = UserFactory.create()
    
    # Each run gets different data
    assert user.id > 0
    assert "@" in user.email
    
    if execution_number % 10 == 0:  # Print every 10th
        print(f"âœ… Execution {execution_number}: {user.username}")


# ==================== Lazy Generation ====================

def generate_users_lazily():
    """Lazily generate users (only when requested)."""
    for i in range(10):
        yield UserFactory.create()


@pytest.mark.parametrize("user", list(generate_users_lazily()))
def test_lazy_generation(user):
    """Test with lazily generated users."""
    assert user.id > 0
    
    print(f"âœ… Lazy user: {user.username}")


# ==================== Error Case Parametrization ====================

invalid_users = [
    pytest.param(
        {"name": "", "email": "valid@example.com", "age": 25},
        id="empty_name"
    ),
    pytest.param(
        {"name": "John", "email": "invalid-email", "age": 25},
        id="invalid_email"
    ),
    pytest.param(
        {"name": "John", "email": "john@example.com", "age": 10},
        id="too_young"
    )
]


@pytest.mark.parametrize("user_data", invalid_users)
def test_validation_errors_parametrized(user_data):
    """Test that validation errors are caught for various invalid data."""
    with pytest.raises(ValidationError):
        UserCreate.model_validate(user_data)
    
    print(f"âœ… Caught invalid data")


# ==================== Real-World Example ====================

def test_data_driven_api_testing():
    """Demonstrate complete data-driven API testing."""
    client = httpx.Client(base_url="https://jsonplaceholder.typicode.com")
    
    # Generate test scenarios
    Faker.seed(300)
    test_scenarios = [
        {
            "scenario": f"scenario_{i}",
            "user": UserFactory.create()
        }
        for i in range(5)
    ]
    
    for scenario in test_scenarios:
        user = scenario["user"]
        
        request_data = {
            "name": f"{user.first_name} {user.last_name}",
            "email": user.email,
            "username": user.username
        }
        
        response = client.post("/users", json=request_data)
        assert response.status_code == 201
        
        print(f"âœ… {scenario['scenario']}: {user.username}")
```

---

## C. Connect & Apply

### How to Test It

```bash
# Run all parametrized tests
pytest tests/test_parametrization_with_faker.py -v -s

# Run stress test
pytest tests/test_parametrization_with_faker.py::test_stress_with_faker -v
```

### Expected Result

```
tests/test_parametrization_with_faker.py::test_user_creation_parametrized[user_data0] PASSED
âœ… Test passed for: Jennifer Martinez (age 34)

tests/test_parametrization_with_faker.py::test_user_creation_parametrized[user_data1] PASSED
âœ… Test passed for: Michael Johnson (age 52)

... [5 total parametrized tests]

tests/test_parametrization_with_faker.py::test_stress_with_faker[0] PASSED
âœ… Execution 0: user_2847

... [100 executions]

======================== 150+ passed in 3.45s =========================
```

---

## D. What You've Learned

âœ… Parametrizing tests with Faker data  
âœ… Generating test cases dynamically  
âœ… Parametrized fixtures  
âœ… Multiple parameter parametrization  
âœ… Named scenarios with IDs  
âœ… Edge case generation  
âœ… Stress testing with parametrization  
âœ… Lazy generation patterns  
âœ… Error case parametrization  
âœ… Data-driven API testing  

---

## E. What's Next?

In **Lesson 4.19 (Best Practices for Test Data)** - FINAL LESSON! ðŸŽ‰

We'll learn:
- Production-ready patterns
- Common pitfalls
- Performance optimization
- Complete best practices guide

Almost done with Project 4! ðŸŽ‰

---

**Ready for the final lesson?**
