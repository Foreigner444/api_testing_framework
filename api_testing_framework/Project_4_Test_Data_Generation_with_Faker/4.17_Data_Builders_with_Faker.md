# 4.17 Data Builders with Faker

## A. Concept Overview

### What & Why
The **Builder Pattern** provides a fluent, readable way to construct complex objects step-by-step. Combined with Faker, builders let you create test data with a natural, chainable syntax like `UserBuilder().with_name("John").in_city("Boston").build()`. This makes test data creation self-documenting and highly flexible.

### Analogy
Think of the Builder Pattern like **ordering a custom sandwich at a deli**.

**Factory Pattern**:
- "Give me a sandwich" â†’ Get standard sandwich
- Quick but less control

**Builder Pattern**:
- "I'll have whole wheat bread" `.with_bread("wheat")`
- "Add turkey" `.with_meat("turkey")`
- "Extra cheese" `.with_cheese("cheddar")`
- "Make it!" `.build()`
- Full control, clear intent

Builders let you customize step-by-step!

---

## B. Code Implementation

### File Path: `builders/user_builder.py`

```python
"""User builder with Faker integration."""
from faker import Faker
from typing import Optional
from datetime import date, datetime
from models.user_models import User, Address, Company

fake = Faker()


class AddressBuilder:
    """Builder for Address model."""
    
    def __init__(self):
        self._street = fake.street_address()
        self._city = fake.city()
        self._state = fake.state_abbr()
        self._zipcode = fake.zipcode()
        self._country = "USA"
    
    def with_street(self, street: str) -> 'AddressBuilder':
        """Set street address."""
        self._street = street
        return self
    
    def in_city(self, city: str) -> 'AddressBuilder':
        """Set city."""
        self._city = city
        return self
    
    def in_state(self, state: str) -> 'AddressBuilder':
        """Set state."""
        self._state = state
        return self
    
    def with_zipcode(self, zipcode: str) -> 'AddressBuilder':
        """Set zipcode."""
        self._zipcode = zipcode
        return self
    
    def in_country(self, country: str) -> 'AddressBuilder':
        """Set country."""
        self._country = country
        return self
    
    def build(self) -> Address:
        """Build the Address."""
        return Address(
            street=self._street,
            city=self._city,
            state=self._state,
            zipcode=self._zipcode,
            country=self._country
        )


class CompanyBuilder:
    """Builder for Company model."""
    
    def __init__(self):
        self._name = fake.company()
        self._industry = None
        self._website = None
    
    def with_name(self, name: str) -> 'CompanyBuilder':
        """Set company name."""
        self._name = name
        return self
    
    def in_industry(self, industry: str) -> 'CompanyBuilder':
        """Set industry."""
        self._industry = industry
        return self
    
    def with_website(self, website: str) -> 'CompanyBuilder':
        """Set website."""
        self._website = website
        return self
    
    def build(self) -> Company:
        """Build the Company."""
        return Company(
            name=self._name,
            industry=self._industry,
            website=self._website
        )


class UserBuilder:
    """Builder for User model with fluent interface."""
    
    def __init__(self):
        # Initialize with Faker defaults
        self._id = fake.random_int(1, 10000)
        self._username = fake.user_name()
        self._email = fake.email()
        self._first_name = fake.first_name()
        self._last_name = fake.last_name()
        self._phone = fake.phone_number()
        self._date_of_birth = fake.date_of_birth(minimum_age=18)
        self._address = AddressBuilder().build()
        self._company = None
        self._bio = None
        self._website = None
        self._is_active = True
        self._created_at = fake.date_time_this_year()
    
    def with_id(self, id: int) -> 'UserBuilder':
        """Set user ID."""
        self._id = id
        return self
    
    def with_username(self, username: str) -> 'UserBuilder':
        """Set username."""
        self._username = username
        return self
    
    def with_email(self, email: str) -> 'UserBuilder':
        """Set email."""
        self._email = email
        return self
    
    def with_name(self, first_name: str, last_name: str) -> 'UserBuilder':
        """Set first and last name."""
        self._first_name = first_name
        self._last_name = last_name
        return self
    
    def with_first_name(self, first_name: str) -> 'UserBuilder':
        """Set first name."""
        self._first_name = first_name
        return self
    
    def with_last_name(self, last_name: str) -> 'UserBuilder':
        """Set last name."""
        self._last_name = last_name
        return self
    
    def with_phone(self, phone: str) -> 'UserBuilder':
        """Set phone number."""
        self._phone = phone
        return self
    
    def with_birth_date(self, birth_date: date) -> 'UserBuilder':
        """Set date of birth."""
        self._date_of_birth = birth_date
        return self
    
    def aged(self, age: int) -> 'UserBuilder':
        """Set age (calculates birth date)."""
        from datetime import date
        today = date.today()
        birth_year = today.year - age
        self._date_of_birth = date(birth_year, today.month, today.day)
        return self
    
    def in_city(self, city: str) -> 'UserBuilder':
        """Set city."""
        self._address = AddressBuilder().in_city(city).build()
        return self
    
    def in_state(self, state: str) -> 'UserBuilder':
        """Set state."""
        self._address = AddressBuilder().in_state(state).build()
        return self
    
    def with_address(self, address: Address) -> 'UserBuilder':
        """Set complete address."""
        self._address = address
        return self
    
    def at_company(self, company_name: str) -> 'UserBuilder':
        """Set company."""
        self._company = CompanyBuilder().with_name(company_name).build()
        return self
    
    def with_company(self, company: Company) -> 'UserBuilder':
        """Set complete company."""
        self._company = company
        return self
    
    def with_bio(self, bio: str) -> 'UserBuilder':
        """Set bio."""
        self._bio = bio
        return self
    
    def with_website(self, website: str) -> 'UserBuilder':
        """Set website."""
        self._website = website
        return self
    
    def active(self) -> 'UserBuilder':
        """Make user active."""
        self._is_active = True
        return self
    
    def inactive(self) -> 'UserBuilder':
        """Make user inactive."""
        self._is_active = False
        return self
    
    def created_at(self, created_at: datetime) -> 'UserBuilder':
        """Set creation timestamp."""
        self._created_at = created_at
        return self
    
    def build(self) -> User:
        """Build the User model."""
        return User(
            id=self._id,
            username=self._username,
            email=self._email,
            first_name=self._first_name,
            last_name=self._last_name,
            phone=self._phone,
            date_of_birth=self._date_of_birth,
            address=self._address,
            company=self._company,
            bio=self._bio,
            website=self._website,
            is_active=self._is_active,
            created_at=self._created_at
        )
```

---

### File Path: `tests/test_builders.py`

```python
"""Tests for data builders."""
import pytest
from datetime import date
from builders.user_builder import UserBuilder, AddressBuilder, CompanyBuilder
from models.user_models import User, Address


def test_basic_builder():
    """Test basic builder usage."""
    user = UserBuilder().build()
    
    # Should create valid user
    assert isinstance(user, User)
    assert user.id > 0
    
    print(f"âœ… Basic builder: {user.username}")


def test_builder_with_customization():
    """Test builder with method chaining."""
    user = (UserBuilder()
            .with_username("johndoe")
            .with_email("john@example.com")
            .with_name("John", "Doe")
            .aged(30)
            .in_city("Boston")
            .active()
            .build())
    
    # Custom values applied
    assert user.username == "johndoe"
    assert user.email == "john@example.com"
    assert user.first_name == "John"
    assert user.last_name == "Doe"
    assert user.address.city == "Boston"
    assert user.is_active is True
    
    # Age calculated
    today = date.today()
    age = today.year - user.date_of_birth.year
    assert 29 <= age <= 31  # Approximately 30
    
    print(f"âœ… Customized builder!")
    print(f"   {user.first_name} {user.last_name} ({user.username})")
    print(f"   {user.address.city}")


def test_builder_readability():
    """Test builder provides readable test data creation."""
    # Very readable - shows intent clearly!
    admin_user = (UserBuilder()
                  .with_username("admin")
                  .with_email("admin@example.com")
                  .at_company("Admin Corp")
                  .active()
                  .build())
    
    assert admin_user.username == "admin"
    assert admin_user.company.name == "Admin Corp"
    
    print(f"âœ… Readable builder: {admin_user.username} at {admin_user.company.name}")


def test_address_builder():
    """Test AddressBuilder."""
    address = (AddressBuilder()
               .with_street("123 Main St")
               .in_city("Boston")
               .in_state("MA")
               .with_zipcode("02101")
               .build())
    
    assert address.street == "123 Main St"
    assert address.city == "Boston"
    assert address.state == "MA"
    assert address.zipcode == "02101"
    
    print(f"âœ… Address builder: {address.city}, {address.state}")


def test_company_builder():
    """Test CompanyBuilder."""
    company = (CompanyBuilder()
               .with_name("TechCorp")
               .in_industry("Technology")
               .with_website("https://techcorp.com")
               .build())
    
    assert company.name == "TechCorp"
    assert company.industry == "Technology"
    
    print(f"âœ… Company builder: {company.name}")


def test_nested_builders():
    """Test using builders for nested models."""
    # Build address separately
    address = (AddressBuilder()
               .in_city("San Francisco")
               .in_state("CA")
               .build())
    
    # Build company separately
    company = (CompanyBuilder()
               .with_name("StartupCo")
               .in_industry("Technology")
               .build())
    
    # Build user with nested builders
    user = (UserBuilder()
            .with_name("Jane", "Smith")
            .with_address(address)
            .with_company(company)
            .build())
    
    assert user.address.city == "San Francisco"
    assert user.company.name == "StartupCo"
    
    print(f"âœ… Nested builders!")
    print(f"   {user.first_name} at {user.company.name} in {user.address.city}")


def test_builder_for_test_scenarios():
    """Test builder for different test scenarios."""
    # Scenario 1: Young user
    young_user = UserBuilder().aged(18).build()
    
    # Scenario 2: Inactive user
    inactive_user = UserBuilder().inactive().build()
    
    # Scenario 3: User with company
    corporate_user = UserBuilder().at_company("BigCorp").build()
    
    assert young_user.date_of_birth is not None
    assert inactive_user.is_active is False
    assert corporate_user.company.name == "BigCorp"
    
    print(f"âœ… Different scenarios with builder!")


def test_builder_with_faker_randomness():
    """Test that builder still uses Faker for unspecified fields."""
    # Only set username
    user = UserBuilder().with_username("testuser").build()
    
    # Username is custom
    assert user.username == "testuser"
    
    # Other fields generated by Faker
    assert len(user.first_name) > 0
    assert "@" in user.email
    assert len(user.address.city) > 0
    
    print(f"âœ… Builder + Faker randomness!")
    print(f"   Custom: {user.username}")
    print(f"   Generated: {user.first_name} from {user.address.city}")


def test_builder_vs_factory():
    """Test builder vs factory comparison."""
    from factories.user_factory import UserFactory
    
    # Factory - concise
    factory_user = UserFactory.create(username="factoryuser")
    
    # Builder - fluent
    builder_user = UserBuilder().with_username("builderuser").build()
    
    # Both create valid users
    assert factory_user.username == "factoryuser"
    assert builder_user.username == "builderuser"
    
    print(f"âœ… Factory vs Builder both work!")
    print(f"   Factory: {factory_user.username}")
    print(f"   Builder: {builder_user.username}")


def test_builder_for_complex_setup():
    """Test builder for complex test setup."""
    # Builder shines for complex, readable setup
    user = (UserBuilder()
            .with_id(999)
            .with_username("poweruser")
            .with_email("power@example.com")
            .with_name("Power", "User")
            .aged(35)
            .in_city("New York")
            .in_state("NY")
            .at_company("PowerCorp")
            .with_bio("I am a power user")
            .with_website("https://poweruser.com")
            .active()
            .build())
    
    # All customizations applied
    assert user.id == 999
    assert user.username == "poweruser"
    assert user.first_name == "Power"
    assert user.address.city == "New York"
    assert user.company.name == "PowerCorp"
    assert user.bio == "I am a power user"
    
    print(f"âœ… Complex builder setup!")
    print(f"   {user.first_name} {user.last_name} ({user.username})")
    print(f"   {user.company.name} in {user.address.city}")


def test_builder_in_api_test():
    """Test using builder in API test."""
    import httpx
    
    client = httpx.Client(base_url="https://jsonplaceholder.typicode.com")
    
    # Build user with specific requirements
    user = (UserBuilder()
            .with_username("apitestuser")
            .with_email("apitest@example.com")
            .in_city("Seattle")
            .build())
    
    # Use in API request
    request_data = {
        "name": f"{user.first_name} {user.last_name}",
        "email": user.email,
        "username": user.username
    }
    
    response = client.post("/users", json=request_data)
    assert response.status_code == 201
    
    print(f"âœ… Builder in API test: {user.username}")


def test_multiple_users_with_builder():
    """Test creating multiple users with builder."""
    # Create 3 users with different characteristics
    users = [
        UserBuilder().with_username("user1").in_city("Boston").build(),
        UserBuilder().with_username("user2").in_city("Seattle").build(),
        UserBuilder().with_username("user3").in_city("Austin").build()
    ]
    
    assert len(users) == 3
    assert users[0].address.city == "Boston"
    assert users[1].address.city == "Seattle"
    assert users[2].address.city == "Austin"
    
    print(f"âœ… Multiple users with builder!")
    for user in users:
        print(f"   {user.username} in {user.address.city}")
```

---

## C. Connect & Apply

### How to Test It

```bash
pytest tests/test_builders.py -v -s
```

### Expected Result

```
tests/test_builders.py::test_builder_with_customization PASSED
âœ… Customized builder!
   John Doe (johndoe)
   Boston

tests/test_builders.py::test_builder_for_complex_setup PASSED
âœ… Complex builder setup!
   Power User (poweruser)
   PowerCorp in New York

tests/test_builders.py::test_multiple_users_with_builder PASSED
âœ… Multiple users with builder!
   user1 in Boston
   user2 in Seattle
   user3 in Austin

======================== 11 passed in 1.23s =========================
```

---

## D. Builder vs Factory

| Aspect | Factory | Builder |
|--------|---------|---------|
| **Syntax** | `Factory.create(field=value)` | `Builder().with_field(value).build()` |
| **Readability** | Good | Excellent (fluent) |
| **Flexibility** | High | Very High |
| **Complexity** | Simple | More code |
| **Use Case** | Quick creation | Complex setup |

**Recommendation**: Use both! Factory for simple cases, Builder for complex ones.

---

## E. What You've Learned

âœ… Builder pattern fundamentals  
âœ… Fluent interface design  
âœ… Method chaining  
âœ… Building complex objects step-by-step  
âœ… Nested builders  
âœ… Builder + Faker integration  
âœ… When to use builders vs factories  
âœ… Readable test data creation  

---

## F. What's Next?

In **Lesson 4.18 (Dynamic Test Parametrization)**, we'll learn:
- Parametrizing tests with Faker
- Data-driven testing
- Generating test cases dynamically

Builders complete! ðŸŽ‰

---

**Ready for the next lesson?**
