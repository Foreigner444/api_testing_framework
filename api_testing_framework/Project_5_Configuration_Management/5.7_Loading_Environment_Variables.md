# Lesson 5.7: Loading Environment Variables

## A. Concept Overview

### What & Why
**Loading environment variables** is the process of reading configuration from .env files or system environment into your Python application at startup. It's important because it ensures all configuration is available before any tests run, preventing runtime errors and providing consistent behavior across the test suite.

### Analogy
Think of loading environment variables like a pre-flight checklist. Before a plane takes off (before tests run), pilots verify all systems are operational and configured correctly (load and validate environment variables). If something's missing (required variable not set), you find out on the ground, not mid-flight.

---

## B. Code Implementation

### Basic Environment Loading in conftest.py

**File Path:** `conftest.py`

```python
"""
pytest configuration - loads environment variables before any tests run.
"""

import os
from pathlib import Path
from dotenv import load_dotenv, find_dotenv


def load_test_environment():
    """
    Load environment variables for testing.
    
    This function runs once when pytest starts.
    """
    # Method 1: Load from .env in current directory
    env_file = Path(".env")
    if env_file.exists():
        print(f"Loading environment from: {env_file.absolute()}")
        load_dotenv(dotenv_path=env_file)
        return
    
    # Method 2: Search parent directories
    found_env = find_dotenv()
    if found_env:
        print(f"Loading environment from: {found_env}")
        load_dotenv(dotenv_path=found_env)
        return
    
    # Method 3: No .env file, use system environment only
    print("No .env file found, using system environment variables")


# Load environment when pytest starts
load_test_environment()


def pytest_configure(config):
    """
    pytest hook - display loaded configuration.
    """
    print("\n" + "=" * 60)
    print("Test Environment Configuration")
    print("=" * 60)
    
    important_vars = ["API_BASE_URL", "ENVIRONMENT", "DEBUG"]
    
    for var in important_vars:
        value = os.getenv(var, "<not set>")
        # Mask sensitive values
        if "KEY" in var or "SECRET" in var:
            display_value = "***" if value != "<not set>" else "<not set>"
        else:
            display_value = value
        print(f"{var}: {display_value}")
    
    print("=" * 60 + "\n")
```

---

### Advanced Environment Loader

**File Path:** `config/env_loader.py`

```python
"""
Advanced environment loading with validation.
"""

import os
from pathlib import Path
from typing import Optional
from dotenv import load_dotenv


class EnvironmentLoader:
    """
    Loads configuration from environment-specific .env files.
    
    Priority (highest to lowest):
    1. System environment variables
    2. .env.{ENVIRONMENT}.local
    3. .env.{ENVIRONMENT}
    4. .env.local
    5. .env
    """
    
    def __init__(self, base_dir: Optional[Path] = None):
        self.base_dir = base_dir or Path.cwd()
        self.environment = os.getenv("ENVIRONMENT", "development")
    
    def load(self, override: bool = False) -> None:
        """Load environment variables from .env files."""
        env_files = [
            self.base_dir / ".env",
            self.base_dir / ".env.local",
            self.base_dir / f".env.{self.environment}",
            self.base_dir / f".env.{self.environment}.local",
        ]
        
        for env_file in env_files:
            if env_file.exists():
                print(f"Loading: {env_file.name}")
                load_dotenv(dotenv_path=env_file, override=override)
    
    def validate(self, required_vars: list[str]) -> None:
        """Validate required environment variables are set."""
        missing = [var for var in required_vars if var not in os.environ]
        
        if missing:
            raise ValueError(
                f"Missing required environment variables: {', '.join(missing)}\n"
                f"Environment: {self.environment}\n"
                f"Create appropriate .env file with these variables."
            )


def load_environment(required_vars: Optional[list[str]] = None) -> None:
    """Load and validate environment variables."""
    loader = EnvironmentLoader()
    loader.load()
    
    if required_vars:
        loader.validate(required_vars)
```

---

### Using in Tests

**File Path:** `tests/test_env_loading.py`

```python
import os
import pytest


def test_environment_variables_loaded():
    """Verify environment variables are available."""
    assert "API_BASE_URL" in os.environ
    
    api_url = os.getenv("API_BASE_URL")
    assert api_url is not None
    assert len(api_url) > 0


def test_environment_is_set():
    """Verify ENVIRONMENT variable is set."""
    environment = os.getenv("ENVIRONMENT", "development")
    assert environment in ["development", "staging", "production", "test"]
    
    print(f"\nRunning in: {environment} environment")
```

---

## C. Connect & Apply

### How to Test It

1. **Create .env file:**

```bash
cat > .env << 'EOF'
API_BASE_URL=http://localhost:8000
API_KEY=dev_key_123
ENVIRONMENT=development
DEBUG=true
EOF
```

2. **Run tests:**

```bash
pytest tests/test_env_loading.py -v -s
```

### Expected Result

```
Loading environment from: /project/.env
============================================================
Test Environment Configuration
============================================================
API_BASE_URL: http://localhost:8000
ENVIRONMENT: development
DEBUG: true
============================================================

tests/test_env_loading.py::test_environment_variables_loaded PASSED
tests/test_env_loading.py::test_environment_is_set PASSED

Running in: development environment
```

---

## D. Common Stumbling Blocks

### Mistake #1: Loading environment too late

**The Problem:**

```python
# Settings imported before load_dotenv()
from config.settings import settings

# conftest.py
load_dotenv()  # Too late!
```

**The Fix:**

```python
# conftest.py (at the very top)
from dotenv import load_dotenv
load_dotenv()  # Load FIRST

# Now imports can use env vars
from config.settings import settings
```

---

### Mistake #2: Silent failures

**The Problem:**

```python
load_dotenv()  # Doesn't fail if .env missing
api_key = os.environ["API_KEY"]  # KeyError!
```

**The Fix:**

```python
from pathlib import Path

env_file = Path(".env")
if not env_file.exists():
    print("WARNING: .env not found!")
else:
    load_dotenv()

api_key = os.getenv("API_KEY")
if not api_key:
    raise ValueError("API_KEY required")
```

---

## ðŸŽ¯ Key Takeaways

âœ… **Load environment early** - in conftest.py before imports  
âœ… **Validate required variables** - fail fast with clear errors  
âœ… **Check file existence** - provide helpful feedback  
âœ… **Use pytest hooks** - pytest_configure for display, pytest_sessionstart for validation  
âœ… **Load once per session** - efficient and consistent  

---

## What's Next?

Next lesson: **Environment-Specific .env Files** - managing multiple environment configurations!

**Ready to continue?** ðŸš€
