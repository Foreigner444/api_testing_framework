# Lesson 5.32: Feature Flags and Toggles

## A. Concept Overview

### What & Why
**Feature flags** (toggles) use configuration to enable/disable features without code changes, allowing gradual rollouts, A/B testing, and quick feature disabling if issues arise. Essential for modern developmentâ€”deploy code dark, enable when ready.

### Analogy
Feature flags are like light switchesâ€”the wiring (code) is always there, but you control when lights turn on. Test new lighting (features) in one room (staging) before illuminating the whole house (production). Flip switches instantly if bulbs are too bright (issues found).

---

## B. Code Implementation

```python
from typing import Dict
from pydantic import Field
from pydantic_settings import BaseSettings


class FeatureFlags(BaseSettings):
    """Feature flag configuration."""
    
    # New features (off by default)
    feature_new_ui: bool = Field(default=False, description="Enable new UI")
    feature_async_processing: bool = Field(default=False)
    feature_advanced_analytics: bool = Field(default=False)
    
    # Beta features
    beta_ai_recommendations: bool = False
    beta_realtime_updates: bool = False
    
    # Operational toggles
    enable_rate_limiting: bool = True
    enable_caching: bool = True
    enable_detailed_logging: bool = False
    
    # Percentage rollouts (0-100)
    rollout_percentage_new_algorithm: int = Field(default=0, ge=0, le=100)
    
    def is_feature_enabled(self, feature_name: str) -> bool:
        """Check if feature is enabled."""
        return getattr(self, feature_name, False)
    
    def get_all_flags(self) -> Dict[str, bool]:
        """Get all feature flags."""
        return {
            name: value
            for name, value in self.model_dump().items()
            if name.startswith(("feature_", "beta_", "enable_"))
        }


# .env.development (enable all features for testing)
# FEATURE_NEW_UI=true
# FEATURE_ASYNC_PROCESSING=true
# FEATURE_ADVANCED_ANALYTICS=true
# BETA_AI_RECOMMENDATIONS=true
# ENABLE_DETAILED_LOGGING=true

# .env.production (gradual rollout)
# FEATURE_NEW_UI=false  # Not ready yet
# FEATURE_ASYNC_PROCESSING=true  # Rolled out
# ROLLOUT_PERCENTAGE_NEW_ALGORITHM=10  # 10% of users


# Usage in code
flags = FeatureFlags()

if flags.feature_new_ui:
    # Use new UI
    pass
else:
    # Use old UI
    pass


# Usage in tests
def test_with_feature_flag():
    flags = FeatureFlags(feature_new_ui=True)
    # Test with feature enabled
    
def test_without_feature_flag():
    flags = FeatureFlags(feature_new_ui=False)
    # Test with feature disabled
```

---

## C. Connect & Apply

```python
flags = FeatureFlags()
print(f"New UI enabled: {flags.feature_new_ui}")
print(f"All flags: {flags.get_all_flags()}")
```

---

## D. Common Stumbling Blocks

**Mistake:** Hardcoding feature checks
**Fix:** Use configuration-based feature flags

---

## ðŸŽ¯ Key Takeaways

âœ… **Feature flags** enable/disable features via config  
âœ… **Test in staging** before production rollout  
âœ… **Gradual rollouts** with percentage flags  
âœ… **Quick disable** if issues found  

---

## What's Next?

Next: **Configuration for CI/CD**!

**Ready to continue?** ðŸš€
