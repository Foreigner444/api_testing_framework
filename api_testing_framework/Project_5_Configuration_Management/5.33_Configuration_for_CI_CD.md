# Lesson 5.33: Configuration for CI/CD

## A. Concept Overview

### What & Why
**CI/CD configuration** manages environment variables, secrets, and settings in continuous integration/deployment pipelines (GitHub Actions, Jenkins, GitLab CI). Essential for automated testingâ€”pipelines need proper configuration to run tests against correct environments.

### Analogy
CI/CD configuration is like a recipe that works in any kitchen. The recipe (tests) is the same, but each kitchen (CI environment) needs its own ingredients list (environment variables). Professional kitchens (CI) use ingredient lockers (secret stores) instead of leaving everything on the counter.

---

## B. Code Implementation

### GitHub Actions Configuration

**File Path:** `.github/workflows/test.yml`

```yaml
name: API Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test-development:
    runs-on: ubuntu-latest
    
    env:
      # Public configuration
      API_BASE_URL: https://api.dev.example.com
      ENVIRONMENT: development
      DEBUG: false
      LOG_LEVEL: INFO
      TIMEOUT: 30
      
      # Secrets from GitHub Secrets
      API_KEY: ${{ secrets.DEV_API_KEY }}
      DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Run tests
        run: |
          pytest tests/ -v --env=development
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-dev
          path: test-results/

  
  test-staging:
    runs-on: ubuntu-latest
    needs: test-development
    
    env:
      API_BASE_URL: https://api.staging.example.com
      ENVIRONMENT: staging
      API_KEY: ${{ secrets.STAGING_API_KEY }}
      DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
    
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run tests
        run: pytest tests/ -v --env=staging
```

---

### Environment-Specific CI Configuration

**File Path:** `config/ci_settings.py`

```python
from pydantic_settings import BaseSettings
import os


class CISettings(BaseSettings):
    """Settings specific to CI/CD environment."""
    
    # CI detection
    is_ci: bool = Field(default=False)
    ci_provider: str = Field(default="unknown")
    
    # GitHub Actions
    github_actions: bool = Field(default=False)
    github_repository: str = Field(default="")
    github_ref: str = Field(default="")
    
    # Test configuration
    parallel_tests: bool = Field(default=True)
    test_timeout: int = Field(default=300)
    
    @classmethod
    def detect_ci(cls):
        """Auto-detect CI environment."""
        if os.getenv("GITHUB_ACTIONS"):
            return cls(
                is_ci=True,
                ci_provider="github",
                github_actions=True,
                github_repository=os.getenv("GITHUB_REPOSITORY", ""),
                github_ref=os.getenv("GITHUB_REF", "")
            )
        elif os.getenv("GITLAB_CI"):
            return cls(is_ci=True, ci_provider="gitlab")
        elif os.getenv("JENKINS_HOME"):
            return cls(is_ci=True, ci_provider="jenkins")
        else:
            return cls(is_ci=False)


# Usage in tests
ci_settings = CISettings.detect_ci()

if ci_settings.is_ci:
    print(f"Running in {ci_settings.ci_provider} CI")
else:
    print("Running locally")
```

---

## C. Connect & Apply

### Setting GitHub Secrets

```bash
# Via GitHub UI:
# Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret

# Or via gh CLI:
gh secret set DEV_API_KEY --body "dev_key_12345"
gh secret set DEV_DATABASE_URL --body "postgresql://..."
gh secret set STAGING_API_KEY --body "staging_key_67890"
```

---

## D. Common Stumbling Blocks

**Mistake:** Hardcoding secrets in workflow files
**Fix:** Use `${{ secrets.SECRET_NAME }}`

---

## ðŸŽ¯ Key Takeaways

âœ… **Use GitHub Secrets** for sensitive values  
âœ… **env block** for public configuration  
âœ… **Test multiple environments** in pipeline  
âœ… **Auto-detect CI** in code  

---

## What's Next?

Next: **Docker Environment Variables**!

**Ready to continue?** ðŸš€
