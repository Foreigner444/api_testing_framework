# Lesson 5.31: Database Connection Strings

## A. Concept Overview

### What & Why
**Database connection string configuration** manages database URLs, credentials, and connection parameters across environments. Essential for testing against correct databasesâ€”dev uses local test DB, staging uses staging DB, production uses production DB.

### Analogy
Database connection strings are like phone numbers with area codesâ€”you need the complete number (protocol + host + port + database + credentials) to reach the right destination. Calling the wrong number (wrong database) means wrong data.

---

## B. Code Implementation

```python
from pydantic import Field, SecretStr, field_validator
from pydantic_settings import BaseSettings
from typing import Optional


class DatabaseSettings(BaseSettings):
    """Database configuration with secure credential management."""
    
    # Connection details
    db_host: str = "localhost"
    db_port: int = 5432
    db_name: str
    db_user: str
    db_password: SecretStr
    
    # Connection pool settings
    db_pool_size: int = Field(default=10, ge=1, le=100)
    db_pool_max_overflow: int = Field(default=20, ge=0, le=100)
    db_pool_timeout: int = Field(default=30, ge=1)
    
    # SSL settings
    db_ssl_mode: str = Field(default="prefer")
    
    @field_validator("db_ssl_mode")
    @classmethod
    def validate_ssl_mode(cls, v: str) -> str:
        allowed = ["disable", "allow", "prefer", "require", "verify-ca", "verify-full"]
        if v not in allowed:
            raise ValueError(f"SSL mode must be one of {allowed}")
        return v
    
    @property
    def database_url(self) -> str:
        """Build complete database URL."""
        password = self.db_password.get_secret_value()
        return (
            f"postgresql://{self.db_user}:{password}@"
            f"{self.db_host}:{self.db_port}/{self.db_name}"
            f"?sslmode={self.db_ssl_mode}"
        )
    
    @property
    def database_url_masked(self) -> str:
        """Database URL with masked password for logging."""
        return (
            f"postgresql://{self.db_user}:***@"
            f"{self.db_host}:{self.db_port}/{self.db_name}"
        )


# .env.development
# DB_HOST=localhost
# DB_PORT=5432
# DB_NAME=test_db
# DB_USER=dev_user
# DB_PASSWORD=dev_password
# DB_POOL_SIZE=5
# DB_SSL_MODE=disable

# .env.production
# DB_HOST=prod-db.example.com
# DB_PORT=5432
# DB_NAME=production_db
# DB_USER=prod_user
# DB_PASSWORD=secure_prod_password
# DB_POOL_SIZE=50
# DB_SSL_MODE=require


# Usage in tests
def get_database_connection(settings: DatabaseSettings):
    """Get database connection using settings."""
    print(f"Connecting to: {settings.database_url_masked}")
    # Use settings.database_url for actual connection
    # (password is handled securely)
```

---

## C. Connect & Apply

```python
db_settings = DatabaseSettings()
print(f"Database: {db_settings.database_url_masked}")
# postgresql://dev_user:***@localhost:5432/test_db
```

---

## D. Common Stumbling Blocks

**Mistake:** Logging full database URL with password
**Fix:** Use `database_url_masked` for logging

---

## ðŸŽ¯ Key Takeaways

âœ… **Build URLs** from components  
âœ… **Mask passwords** in logs  
âœ… **Different databases** per environment  
âœ… **SSL in production** (require mode)  

---

## What's Next?

Next: **Feature Flags and Toggles**!

**Ready to continue?** ðŸš€
