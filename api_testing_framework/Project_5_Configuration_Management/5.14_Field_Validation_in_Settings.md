# Lesson 5.14: Field Validation in Settings

## A. Concept Overview

### What & Why
**Field validation** in pydantic-settings allows custom validation logic beyond simple type checking. It's essential for ensuring configuration values are not just the right type, but also semantically valid (e.g., URLs are well-formed, ports are in valid range, API keys have correct format).

### Analogy
Think of field validation like a bouncer at a club who doesn't just check if you have an ID (type check), but also verifies the ID is valid, not expired, and you're actually old enough (business logic validation). Field validators are your configuration bouncers.

---

## B. Code Implementation

### Using field_validator

**File Path:** `config/validated_settings.py`

```python
from typing import List
from pydantic import field_validator, Field
from pydantic_settings import BaseSettings, SettingsConfigDict
import re


class Settings(BaseSettings):
    """Settings with comprehensive field validation."""
    
    # Basic fields
    api_key: str
    api_base_url: str
    environment: str
    log_level: str
    timeout: int = Field(ge=1, le=300)
    allowed_hosts: List[str]
    
    @field_validator("api_key")
    @classmethod
    def validate_api_key_format(cls, v: str) -> str:
        """Validate API key format."""
        if len(v) < 20:
            raise ValueError("API key must be at least 20 characters")
        if not re.match(r"^[A-Za-z0-9_-]+$", v):
            raise ValueError("API key contains invalid characters")
        return v
    
    @field_validator("api_base_url")
    @classmethod
    def validate_url(cls, v: str) -> str:
        """Ensure URL is well-formed."""
        if not v.startswith(("http://", "https://")):
            raise ValueError(f"URL must start with http:// or https://, got: {v}")
        if v.endswith("/"):
            # Normalize: remove trailing slash
            v = v.rstrip("/")
        return v
    
    @field_validator("environment")
    @classmethod
    def validate_environment(cls, v: str) -> str:
        """Validate environment name."""
        allowed = ["development", "staging", "production", "test"]
        if v.lower() not in allowed:
            raise ValueError(f"Environment must be one of {allowed}, got: {v}")
        return v.lower()
    
    @field_validator("log_level")
    @classmethod
    def validate_log_level(cls, v: str) -> str:
        """Normalize and validate log level."""
        allowed = ["DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"]
        v_upper = v.upper()
        if v_upper not in allowed:
            raise ValueError(f"Log level must be one of {allowed}, got: {v}")
        return v_upper
    
    @field_validator("allowed_hosts")
    @classmethod
    def validate_hosts(cls, v: List[str]) -> List[str]:
        """Validate host list is not empty."""
        if not v:
            raise ValueError("At least one allowed host must be specified")
        for host in v:
            if not host or host.isspace():
                raise ValueError(f"Invalid host: '{host}'")
        return v
    
    model_config = SettingsConfigDict(
        env_file=".env",
        case_sensitive=False
    )
```

---

## C. Connect & Apply

### How to Test It

```python
# Test valid configuration
import os
os.environ["API_KEY"] = "valid_api_key_with_20plus_chars"
os.environ["API_BASE_URL"] = "https://api.example.com/"
os.environ["ENVIRONMENT"] = "development"
os.environ["LOG_LEVEL"] = "info"
os.environ["ALLOWED_HOSTS"] = "localhost,example.com"

from config.validated_settings import Settings
settings = Settings()
print(f"âœ“ Valid configuration loaded")
print(f"  URL normalized: {settings.api_base_url}")
print(f"  Log level normalized: {settings.log_level}")
```

### Expected Result

```
âœ“ Valid configuration loaded
  URL normalized: https://api.example.com
  Log level normalized: INFO
```

---

## D. Common Stumbling Blocks

### Mistake #1: Forgetting @classmethod decorator

**The Problem:**
```python
@field_validator("api_key")
def validate_key(self, v):  # âŒ Missing @classmethod
    return v
```

**The Fix:**
```python
@field_validator("api_key")
@classmethod  # âœ… Required in Pydantic v2
def validate_key(cls, v: str) -> str:
    return v
```

---

## ðŸŽ¯ Key Takeaways

âœ… **field_validator** for custom validation logic  
âœ… **@classmethod** required in Pydantic v2  
âœ… **Validators run after type conversion**  
âœ… **Return normalized/cleaned value**  
âœ… **Raise ValueError** for validation failures  

---

## What's Next?

Next: **Nested Settings Models** - organizing complex configuration!

**Ready to continue?** ðŸš€
