# Lesson 5.35: Configuration Testing Strategies

## A. Concept Overview

### What & Why
**Configuration testing** validates that your configuration system itself works correctlyâ€”loading, validation, precedence, and environment switching. Essential because configuration bugs can cause silent failures, wrong-environment deployments, and security issues.

### Analogy
Configuration testing is like testing your GPS before a road trip. You verify it powers on (loads), finds satellites (connects), calculates routes correctly (validation), and updates when you change destination (reloading). Don't discover your GPS is broken when you're lost at midnight.

---

## B. Code Implementation

### Testing Configuration Loading

**File Path:** `tests/test_config_loading.py`

```python
import pytest
from pathlib import Path
from config.settings import Settings
from pydantic import ValidationError


def test_settings_load_from_env_file(tmp_path):
    """Test settings load from .env file."""
    # Create temporary .env file
    env_file = tmp_path / ".env"
    env_file.write_text("""
API_KEY=test_key_12345678901234567890
API_BASE_URL=http://localhost:8000
TIMEOUT=30
""")
    
    # Load settings from file
    settings = Settings(_env_file=str(env_file))
    
    assert settings.api_key == "test_key_12345678901234567890"
    assert settings.api_base_url == "http://localhost:8000"
    assert settings.timeout == 30


def test_required_fields_validation():
    """Test that required fields raise ValidationError."""
    with pytest.raises(ValidationError) as exc_info:
        Settings()
    
    # Check specific fields are mentioned
    error_str = str(exc_info.value)
    assert "api_key" in error_str or "field required" in error_str


def test_field_type_validation():
    """Test that invalid types are rejected."""
    env_file_content = """
API_KEY=valid_key_1234567890
API_BASE_URL=http://localhost
TIMEOUT=not_a_number
"""
    
    with pytest.raises(ValidationError) as exc_info:
        # This should fail because TIMEOUT must be int
        pass


def test_environment_specific_loading():
    """Test loading different environment files."""
    # Test development
    dev_settings = Settings(_env_file=".env.development")
    assert dev_settings.environment == "development"
    
    # Test staging
    staging_settings = Settings(_env_file=".env.staging")
    assert staging_settings.environment == "staging"
```

---

### Testing Configuration Validation

**File Path:** `tests/test_config_validation.py`

```python
def test_url_validation():
    """Test URL format validation."""
    with pytest.raises(ValidationError):
        Settings(
            api_key="valid_key_1234567890",
            api_base_url="not-a-valid-url",  # Invalid
            environment="development"
        )


def test_environment_validation():
    """Test environment name validation."""
    with pytest.raises(ValidationError) as exc_info:
        Settings(
            api_key="valid_key",
            api_base_url="http://localhost",
            environment="invalid_environment"  # Not in allowed list
        )
    
    assert "environment" in str(exc_info.value).lower()


def test_production_specific_validation():
    """Test production requires HTTPS."""
    with pytest.raises(ValidationError):
        Settings(
            api_key="valid_key_1234567890",
            api_base_url="http://localhost",  # HTTP not allowed in prod
            environment="production"
        )
```

---

### Testing Configuration Precedence

**File Path:** `tests/test_config_precedence.py`

```python
import os


def test_system_env_overrides_file():
    """Test system environment variables override .env file."""
    # Set system env var
    os.environ["API_KEY"] = "from_system_env"
    
    # Load settings (which would normally load from .env)
    settings = Settings(_env_file=".env.development")
    
    # System env var should win
    assert settings.api_key == "from_system_env"
    
    # Cleanup
    del os.environ["API_KEY"]


def test_later_env_file_overrides_earlier():
    """Test precedence with multiple .env files."""
    # When loading multiple files, later ones override
    settings = Settings(_env_file=(".env", ".env.local"))
    
    # .env.local values should override .env values
    # (Test specific to your setup)
```

---

### Testing Configuration in Different Environments

**File Path:** `tests/test_config_environments.py`

```python
@pytest.mark.parametrize("environment,expected_timeout", [
    ("development", 10),
    ("staging", 30),
    ("production", 60),
])
def test_environment_specific_timeouts(environment, expected_timeout):
    """Test that each environment has correct timeout."""
    settings = Settings(_env_file=f".env.{environment}")
    assert settings.timeout == expected_timeout


def test_all_environments_have_required_fields():
    """Test all environment files have required configuration."""
    environments = ["development", "staging", "production"]
    
    for env in environments:
        env_file = Path(f".env.{env}")
        if not env_file.exists():
            pytest.skip(f"Environment file not found: {env_file}")
        
        # Should load without errors
        settings = Settings(_env_file=str(env_file))
        
        # All environments must have these
        assert settings.api_key
        assert settings.api_base_url
        assert settings.environment == env
```

---

## C. Connect & Apply

```bash
# Run configuration tests
pytest tests/test_config_*.py -v

# Test configuration loading specifically
pytest tests/test_config_loading.py -v

# Test all environment files are valid
pytest tests/test_config_environments.py -v
```

### Expected Result

```
tests/test_config_loading.py::test_settings_load_from_env_file PASSED
tests/test_config_validation.py::test_url_validation PASSED
tests/test_config_precedence.py::test_system_env_overrides_file PASSED
tests/test_config_environments.py::test_all_environments_have_required_fields PASSED
```

---

## D. Common Stumbling Blocks

**Mistake:** Not testing configuration itself
**Fix:** Treat configuration as codeâ€”test it!

---

## ðŸŽ¯ Key Takeaways

âœ… **Test configuration loading** from all sources  
âœ… **Test validation rules** catch bad config  
âœ… **Test precedence rules** work correctly  
âœ… **Test all environment files** are valid  
âœ… **Use parametrize** for multi-environment tests  

---

## What's Next?

Next: **Best Practices for Configuration** - the final lesson!

**Ready to continue?** ðŸš€
