# 3.5 Required vs Optional Fields

## A. Concept Overview

### What & Why
Understanding the difference between **required** and **optional** fields is crucial for API testing. Required fields must be present in every request/response, while optional fields can be omitted. Pydantic gives you precise control over this behavior, preventing bugs and making your API contracts crystal clear.

### Analogy
Think of required vs optional fields like **filling out a form**.

- **Required fields** (name, email) have a red asterisk (*) ‚Äì you can't submit the form without them
- **Optional fields** (phone, middle name) can be left blank ‚Äì the form accepts them

If you try to submit without filling in the required fields, the form stops you. Pydantic does the same for your data!

---

## B. Code Implementation

Let's explore all the ways to handle required and optional fields.

### File Path: `models/required_optional.py`

```python
"""Demonstrating required vs optional fields in Pydantic."""
from typing import Optional
from pydantic import BaseModel, Field


# ==================== Basic Required Fields ====================

class UserRequired(BaseModel):
    """All fields are required by default."""
    name: str           # Required
    email: str          # Required
    age: int            # Required


# ==================== Optional Fields ====================

class UserOptional(BaseModel):
    """Some fields are optional."""
    # Required fields
    name: str
    email: str
    
    # Optional fields (can be omitted)
    age: Optional[int] = None
    phone: Optional[str] = None
    address: Optional[str] = None


# ==================== Default Values ====================

class UserWithDefaults(BaseModel):
    """Fields with default values are optional."""
    name: str                           # Required (no default)
    email: str                          # Required (no default)
    age: int = 18                      # Optional (has default)
    country: str = "US"                # Optional (has default)
    is_active: bool = True             # Optional (has default)
    role: str = Field(default="user")  # Optional (has default)


# ==================== The Tricky Cases ====================

class TrickyCases(BaseModel):
    """Understanding the subtleties."""
    
    # Case 1: Required, can be None
    # You MUST provide this field, but it can be None
    field1: Optional[str]
    # Or: field1: str | None
    
    # Case 2: Optional, defaults to None
    # You can omit this field entirely, defaults to None
    field2: Optional[str] = None
    
    # Case 3: Required string (can't be None)
    # Must provide, must be a string
    field3: str
    
    # Case 4: Optional with non-None default
    # Can omit, defaults to "default"
    field4: str = "default"


# ==================== Real-World Example ====================

class UserRegistration(BaseModel):
    """User registration model - realistic required/optional mix."""
    # Required fields for registration
    username: str = Field(min_length=3, max_length=50)
    email: str
    password: str = Field(min_length=8)
    
    # Optional profile fields
    first_name: Optional[str] = None
    last_name: Optional[str] = None
    phone: Optional[str] = None
    date_of_birth: Optional[str] = None
    
    # Optional with defaults
    newsletter_subscribed: bool = False
    terms_accepted: bool = Field(default=True)
    country: str = "US"
    language: str = "en"


class UserProfile(BaseModel):
    """User profile - everything optional except ID."""
    # Only ID is required (users can update any other field)
    id: int
    
    # All profile fields are optional
    username: Optional[str] = None
    first_name: Optional[str] = None
    last_name: Optional[str] = None
    email: Optional[str] = None
    phone: Optional[str] = None
    bio: Optional[str] = None
    avatar_url: Optional[str] = None


class APIResponse(BaseModel):
    """API response with optional error field."""
    # Always present
    success: bool
    status_code: int
    
    # Present on success
    data: Optional[dict] = None
    
    # Present on error
    error: Optional[str] = None
    error_code: Optional[str] = None
```

---

## C. Testing Required vs Optional

### File Path: `tests/test_required_optional.py`

```python
"""Tests demonstrating required vs optional field behavior."""
import pytest
from pydantic import ValidationError

from models.required_optional import (
    UserRequired,
    UserOptional,
    UserWithDefaults,
    TrickyCases,
    UserRegistration,
    UserProfile,
    APIResponse,
)


def test_all_required_fields_valid():
    """Test that all required fields must be provided."""
    user = UserRequired(
        name="Alice",
        email="alice@example.com",
        age=30
    )
    
    assert user.name == "Alice"
    assert user.email == "alice@example.com"
    assert user.age == 30
    print("‚úÖ All required fields provided successfully!")


def test_missing_required_field():
    """Test that missing required fields raise ValidationError."""
    with pytest.raises(ValidationError) as exc:
        UserRequired(
            name="Bob",
            # Missing 'email' and 'age' - required fields!
        )
    
    errors = exc.value.errors()
    assert len(errors) == 2
    
    missing_fields = [error["loc"][0] for error in errors]
    assert "email" in missing_fields
    assert "age" in missing_fields
    
    print("‚úÖ Pydantic correctly caught missing required fields!")


def test_optional_fields_can_be_omitted():
    """Test that optional fields can be omitted."""
    user = UserOptional(
        name="Charlie",
        email="charlie@example.com"
        # Omitting age, phone, address - all optional!
    )
    
    assert user.name == "Charlie"
    assert user.email == "charlie@example.com"
    assert user.age is None
    assert user.phone is None
    assert user.address is None
    
    print("‚úÖ Optional fields can be omitted, default to None!")


def test_optional_fields_can_be_provided():
    """Test that optional fields can also be explicitly provided."""
    user = UserOptional(
        name="Diana",
        email="diana@example.com",
        age=28,
        phone="+1234567890",
        address="123 Main St"
    )
    
    assert user.age == 28
    assert user.phone == "+1234567890"
    assert user.address == "123 Main St"
    
    print("‚úÖ Optional fields can be explicitly provided!")


def test_optional_fields_can_be_none():
    """Test that optional fields can be explicitly set to None."""
    user = UserOptional(
        name="Eve",
        email="eve@example.com",
        age=None,      # Explicitly None
        phone=None,    # Explicitly None
        address=None   # Explicitly None
    )
    
    assert user.age is None
    assert user.phone is None
    assert user.address is None
    
    print("‚úÖ Optional fields can be explicitly set to None!")


def test_default_values():
    """Test that fields with defaults are optional."""
    # Provide only required fields
    user = UserWithDefaults(
        name="Frank",
        email="frank@example.com"
        # Omitting age, country, is_active, role
    )
    
    # Defaults are used
    assert user.name == "Frank"
    assert user.age == 18           # Default value
    assert user.country == "US"     # Default value
    assert user.is_active is True   # Default value
    assert user.role == "user"      # Default value
    
    print("‚úÖ Default values work correctly!")


def test_overriding_defaults():
    """Test that defaults can be overridden."""
    user = UserWithDefaults(
        name="Grace",
        email="grace@example.com",
        age=35,                    # Override default
        country="UK",              # Override default
        is_active=False,           # Override default
        role="admin"               # Override default
    )
    
    assert user.age == 35
    assert user.country == "UK"
    assert user.is_active is False
    assert user.role == "admin"
    
    print("‚úÖ Default values can be overridden!")


def test_tricky_case_1_required_none():
    """Test field that's required but can be None."""
    # Must provide field1, but it can be None
    data = TrickyCases(
        field1=None,     # MUST be provided (even if None)
        field3="value"   # Required string
    )
    
    assert data.field1 is None
    assert data.field2 is None  # Optional, defaults to None
    assert data.field3 == "value"
    assert data.field4 == "default"
    
    print("‚úÖ Tricky Case 1: Required field can be None if specified!")


def test_tricky_case_1_missing():
    """Test that required None field must still be provided."""
    with pytest.raises(ValidationError) as exc:
        TrickyCases(
            # field1 is missing - even though it can be None, it's required!
            field3="value"
        )
    
    errors = exc.value.errors()
    assert any(error["loc"][0] == "field1" for error in errors)
    
    print("‚úÖ Required field must be provided even if it accepts None!")


def test_user_registration_minimal():
    """Test minimal user registration (only required fields)."""
    user = UserRegistration(
        username="newuser",
        email="newuser@example.com",
        password="securepass123"
        # All other fields are optional
    )
    
    assert user.username == "newuser"
    assert user.first_name is None
    assert user.newsletter_subscribed is False  # Default
    assert user.terms_accepted is True          # Default
    assert user.country == "US"                 # Default
    
    print("‚úÖ Minimal registration works with defaults!")


def test_user_registration_full():
    """Test full user registration (all fields provided)."""
    user = UserRegistration(
        username="fulluser",
        email="fulluser@example.com",
        password="securepass123",
        first_name="John",
        last_name="Doe",
        phone="+1234567890",
        date_of_birth="1990-01-15",
        newsletter_subscribed=True,
        terms_accepted=True,
        country="UK",
        language="en-GB"
    )
    
    assert user.first_name == "John"
    assert user.last_name == "Doe"
    assert user.newsletter_subscribed is True
    assert user.country == "UK"
    
    print("‚úÖ Full registration works with all optional fields!")


def test_user_profile_update():
    """Test updating user profile (only changed fields)."""
    # Update only username and bio
    update = UserProfile(
        id=123,                    # Required
        username="newusername",    # Updating
        bio="New bio text"         # Updating
        # Not updating other fields
    )
    
    assert update.id == 123
    assert update.username == "newusername"
    assert update.bio == "New bio text"
    assert update.first_name is None  # Not updated
    assert update.email is None       # Not updated
    
    print("‚úÖ Partial profile update works!")


def test_api_response_success():
    """Test successful API response."""
    response = APIResponse(
        success=True,
        status_code=200,
        data={"user_id": 123, "name": "Alice"}
        # No error fields
    )
    
    assert response.success is True
    assert response.data is not None
    assert response.error is None
    
    print("‚úÖ Success response: data present, error absent!")


def test_api_response_error():
    """Test error API response."""
    response = APIResponse(
        success=False,
        status_code=400,
        error="Invalid email format",
        error_code="INVALID_EMAIL"
        # No data field
    )
    
    assert response.success is False
    assert response.error == "Invalid email format"
    assert response.data is None
    
    print("‚úÖ Error response: error present, data absent!")
```

---

## D. Connect & Apply

### How to Test It

```bash
# Run all tests
pytest tests/test_required_optional.py -v

# Run with detailed output
pytest tests/test_required_optional.py -v -s
```

### Expected Result

```
tests/test_required_optional.py::test_all_required_fields_valid PASSED
‚úÖ All required fields provided successfully!

tests/test_required_optional.py::test_missing_required_field PASSED
‚úÖ Pydantic correctly caught missing required fields!

tests/test_required_optional.py::test_optional_fields_can_be_omitted PASSED
‚úÖ Optional fields can be omitted, default to None!

... [all tests pass]

tests/test_required_optional.py::test_api_response_error PASSED
‚úÖ Error response: error present, data absent!

======================== 15 passed in 0.67s =========================
```

---

## E. Common Stumbling Blocks

### Problem 1: Confusion Between "Can Be None" vs "Can Be Omitted"

```python
# ‚ùå Common mistake
class Model(BaseModel):
    field: Optional[str]  # Required! Must provide it (can be None)

# ‚úÖ Correct - truly optional
class Model(BaseModel):
    field: Optional[str] = None  # Optional! Can omit entirely
```

**Key Rule:** Without a default value, the field is **always required**, even if it accepts `None`.

---

### Problem 2: Mutable Default Values

```python
# ‚ùå DANGER - mutable default
class Model(BaseModel):
    tags: List[str] = []  # This is shared across instances!

# ‚úÖ Correct - use default_factory
from pydantic import Field

class Model(BaseModel):
    tags: List[str] = Field(default_factory=list)
```

---

### Problem 3: Optional vs Union

```python
# These are equivalent in Python 3.10+
from typing import Optional

field1: Optional[str]      # Old way
field2: str | None         # New way (Python 3.10+)
```

Both mean "string OR None". Use whichever your team prefers!

---

## F. Quick Reference Table

| Pattern | Required? | Can be None? | Default Value |
|---------|-----------|--------------|---------------|
| `field: str` | ‚úÖ Yes | ‚ùå No | N/A |
| `field: Optional[str]` | ‚úÖ Yes | ‚úÖ Yes | N/A |
| `field: Optional[str] = None` | ‚ùå No | ‚úÖ Yes | `None` |
| `field: str = "default"` | ‚ùå No | ‚ùå No | `"default"` |
| `field: Optional[str] = "default"` | ‚ùå No | ‚úÖ Yes | `"default"` |

---

## G. Real-World Best Practices

### 1. **API Responses: Most fields optional**
```python
class UserResponse(BaseModel):
    id: int  # Only ID required
    name: Optional[str] = None
    email: Optional[str] = None
    # API might return partial data
```

### 2. **API Requests: Clear requirements**
```python
class UserCreate(BaseModel):
    username: str  # Required
    email: str     # Required
    age: Optional[int] = None  # Optional
```

### 3. **Update Endpoints: Everything optional except ID**
```python
class UserUpdate(BaseModel):
    id: int  # Required to identify what to update
    username: Optional[str] = None  # All fields optional
    email: Optional[str] = None
```

---

## H. What You've Learned

‚úÖ Required fields must always be provided  
‚úÖ Optional fields need `= None` or another default  
‚úÖ `Optional[T]` without default is still required!  
‚úÖ Fields with defaults are automatically optional  
‚úÖ The difference between "can be None" and "can be omitted"  
‚úÖ Use `default_factory` for mutable defaults  
‚úÖ Real-world patterns for registration, updates, and responses  

---

## I. What's Next?

In **Lesson 3.6 (Default Values and Field Defaults)**, we'll explore:
- Advanced default value patterns
- Using `Field()` for complex defaults
- `default_factory` for computed defaults
- Callable defaults

You now fully understand required vs optional fields! üéâ

---

**Does that make sense? Let me know if you'd like me to explain it in a different way.**

**Ready for the next lesson, or would you like to practice this a bit more?**
