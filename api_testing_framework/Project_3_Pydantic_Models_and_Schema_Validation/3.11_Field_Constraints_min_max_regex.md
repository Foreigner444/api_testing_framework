# 3.11 Field Constraints (min, max, regex)

## A. Concept Overview

### What & Why
Pydantic's `Field()` function provides powerful built-in constraints that handle common validation scenarios without writing custom validators. These constraints make your models concise, readable, and self-documenting while catching invalid data automatically.

### Analogy
Think of Field constraints like **pre-configured quality control machines** in a factory.

Instead of hiring a person (custom validator) to check every item, you have specialized machines:
- **Length checker**: Ensures strings are 3-20 characters
- **Number validator**: Ensures values are between 0 and 100
- **Pattern matcher**: Ensures strings match a specific format (like phone numbers)

These machines are pre-built, reliable, and faster than manual inspection!

---

## B. Code Implementation

### File Path: `models/field_constraints.py`

```python
"""Comprehensive guide to Field constraints in Pydantic."""
import re
from decimal import Decimal
from typing import List
from pydantic import BaseModel, EmailStr, Field, conint, confloat, constr, conlist


# ==================== String Constraints ====================

class StringConstraints(BaseModel):
    """String field constraints."""
    # Length constraints
    username: str = Field(min_length=3, max_length=20)
    password: str = Field(min_length=8, max_length=100)
    bio: str = Field(max_length=500)
    required_field: str = Field(min_length=1)
    
    # Pattern (regex) constraint
    phone: str = Field(pattern=r'^\+?[1-9]\d{1,14}$')
    zip_code: str = Field(pattern=r'^\d{5}(-\d{4})?$')
    username_pattern: str = Field(pattern=r'^[a-zA-Z0-9_]+$')
    
    # Combined constraints
    product_code: str = Field(
        min_length=5,
        max_length=10,
        pattern=r'^[A-Z0-9-]+$'
    )


# ==================== Numeric Constraints ====================

class NumericConstraints(BaseModel):
    """Numeric field constraints."""
    # Greater than / less than
    age: int = Field(gt=0, lt=150)          # 0 < age < 150
    score: int = Field(ge=0, le=100)        # 0 <= score <= 100
    
    # Just minimum
    quantity: int = Field(ge=1)              # quantity >= 1
    price: float = Field(gt=0)               # price > 0
    
    # Just maximum
    discount: float = Field(le=100)          # discount <= 100
    
    # Multiple of
    even_number: int = Field(multiple_of=2)  # Must be even
    price_in_cents: int = Field(multiple_of=5)  # 5, 10, 15, 20...
    
    # Decimal places
    money: Decimal = Field(decimal_places=2)


# ==================== List/Collection Constraints ====================

class CollectionConstraints(BaseModel):
    """Collection field constraints."""
    # List length
    tags: List[str] = Field(min_length=1, max_length=10)
    items: List[int] = Field(min_length=1)
    optional_items: List[str] = Field(default_factory=list, max_length=5)
    
    # Using conlist (alternative syntax)
    usernames: conlist(str, min_length=1, max_length=100)
    scores: conlist(int, min_length=5, max_length=5)  # Exactly 5 items


# ==================== Constrained Types ====================

class ConstrainedTypes(BaseModel):
    """Using con* types for constraints."""
    # Constrained string
    username: constr(
        min_length=3,
        max_length=20,
        pattern=r'^[a-zA-Z0-9_]+$'
    )
    
    # Constrained integer
    age: conint(ge=0, le=150)
    quantity: conint(gt=0, multiple_of=1)
    
    # Constrained float
    price: confloat(ge=0.0, le=1000000.0)
    percentage: confloat(ge=0.0, le=100.0)


# ==================== Common Patterns ====================

class CommonPatterns(BaseModel):
    """Common validation patterns."""
    # Phone numbers (international format)
    phone_intl: str = Field(pattern=r'^\+[1-9]\d{1,14}$')
    
    # US phone number
    phone_us: str = Field(pattern=r'^\d{3}-\d{3}-\d{4}$')
    
    # ZIP code (US)
    zip_code: str = Field(pattern=r'^\d{5}(-\d{4})?$')
    
    # Credit card (basic)
    credit_card: str = Field(pattern=r'^\d{13,19}$')
    
    # URL slug
    slug: str = Field(pattern=r'^[a-z0-9]+(?:-[a-z0-9]+)*$')
    
    # Hex color
    hex_color: str = Field(pattern=r'^#[0-9A-Fa-f]{6}$')
    
    # IPv4 address
    ipv4: str = Field(
        pattern=r'^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$'
    )
    
    # UUID
    uuid_pattern: str = Field(
        pattern=r'^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
    )


# ==================== Field Metadata ====================

class FieldMetadata(BaseModel):
    """Fields with rich metadata."""
    username: str = Field(
        min_length=3,
        max_length=20,
        description="User's unique username",
        examples=["john_doe", "alice123"],
        json_schema_extra={"ui_widget": "text"}
    )
    
    age: int = Field(
        ge=13,
        le=120,
        description="User's age in years",
        examples=[25, 30, 45]
    )
    
    email: EmailStr = Field(
        description="User's email address",
        examples=["user@example.com"]
    )


# ==================== Real-World Examples ====================

class UserProfile(BaseModel):
    """User profile with comprehensive constraints."""
    # Username: 3-20 chars, alphanumeric + underscore
    username: str = Field(
        min_length=3,
        max_length=20,
        pattern=r'^[a-zA-Z0-9_]+$',
        description="Unique username"
    )
    
    # Display name: 1-50 chars
    display_name: str = Field(
        min_length=1,
        max_length=50,
        description="Public display name"
    )
    
    # Bio: optional, max 500 chars
    bio: str = Field(
        default="",
        max_length=500,
        description="User biography"
    )
    
    # Age: 13-120
    age: int = Field(
        ge=13,
        le=120,
        description="User age"
    )
    
    # Website: optional URL pattern
    website: str = Field(
        default="",
        max_length=200,
        pattern=r'^https?://',
        description="Personal website URL"
    )


class Product(BaseModel):
    """Product with business constraints."""
    # Product name: required, 1-200 chars
    name: str = Field(min_length=1, max_length=200)
    
    # SKU: 5-20 chars, uppercase alphanumeric + hyphen
    sku: str = Field(
        min_length=5,
        max_length=20,
        pattern=r'^[A-Z0-9\-]+$'
    )
    
    # Price: positive, max 1 million, 2 decimal places
    price: Decimal = Field(
        gt=0,
        le=1000000,
        decimal_places=2
    )
    
    # Stock: non-negative integer
    stock_quantity: int = Field(ge=0)
    
    # Weight: positive kg, max 1000kg
    weight_kg: float = Field(gt=0, le=1000)
    
    # Tags: 1-10 tags, each 2-30 chars
    tags: List[str] = Field(
        min_length=1,
        max_length=10
    )
    
    # Discount: 0-99%
    discount_percent: float = Field(ge=0, le=99, default=0)


class CreditCard(BaseModel):
    """Credit card with strict validation."""
    # Card number: 13-19 digits
    number: str = Field(
        pattern=r'^\d{13,19}$',
        description="Card number (13-19 digits)"
    )
    
    # CVV: 3-4 digits
    cvv: str = Field(
        pattern=r'^\d{3,4}$',
        description="Card verification value"
    )
    
    # Expiry month: 1-12
    expiry_month: int = Field(ge=1, le=12)
    
    # Expiry year: current year onwards
    expiry_year: int = Field(ge=2024, le=2050)
    
    # Cardholder name: 2-50 chars
    cardholder_name: str = Field(min_length=2, max_length=50)


class APIRequest(BaseModel):
    """API request with constraints."""
    # Query: 1-100 chars
    query: str = Field(min_length=1, max_length=100)
    
    # Page: positive integer
    page: int = Field(ge=1, default=1)
    
    # Per page: 1-100
    per_page: int = Field(ge=1, le=100, default=20)
    
    # Sort order: specific values
    sort_order: str = Field(pattern=r'^(asc|desc)$', default="asc")
    
    # Filters: max 10 filters
    filters: List[str] = Field(default_factory=list, max_length=10)


class PasswordPolicy(BaseModel):
    """Password with strict policy."""
    password: str = Field(
        min_length=12,
        max_length=128,
        pattern=r'^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]+$',
        description="Must contain uppercase, lowercase, digit, and special character"
    )


class BankAccount(BaseModel):
    """Bank account with format constraints."""
    # Account number: 8-12 digits
    account_number: str = Field(
        pattern=r'^\d{8,12}$',
        description="8-12 digit account number"
    )
    
    # Routing number: exactly 9 digits
    routing_number: str = Field(
        pattern=r'^\d{9}$',
        description="9-digit routing number"
    )
    
    # Account type: checking or savings
    account_type: str = Field(
        pattern=r'^(checking|savings)$'
    )
    
    # Balance: non-negative, 2 decimal places
    balance: Decimal = Field(
        ge=0,
        decimal_places=2
    )


class Rating(BaseModel):
    """Rating system with constraints."""
    # Star rating: 1-5
    stars: int = Field(ge=1, le=5)
    
    # Review text: 10-1000 chars
    review: str = Field(min_length=10, max_length=1000)
    
    # Helpful votes: non-negative
    helpful_votes: int = Field(ge=0, default=0)
    
    # Images: optional, max 5
    images: List[str] = Field(default_factory=list, max_length=5)


class ColorRGB(BaseModel):
    """RGB color with strict ranges."""
    red: int = Field(ge=0, le=255)
    green: int = Field(ge=0, le=255)
    blue: int = Field(ge=0, le=255)
    alpha: float = Field(ge=0.0, le=1.0, default=1.0)
```

---

## C. Testing Field Constraints

### File Path: `tests/test_field_constraints.py`

```python
"""Tests for Field constraints."""
import pytest
from decimal import Decimal
from pydantic import ValidationError

from models.field_constraints import (
    StringConstraints,
    NumericConstraints,
    CollectionConstraints,
    Product,
    CreditCard,
    APIRequest,
    ColorRGB,
    Rating,
)


def test_string_length_constraints():
    """Test string length validation."""
    # Valid
    obj = StringConstraints(
        username="john_doe",
        password="securepass123",
        bio="This is my bio",
        required_field="x",
        phone="+12345678901",
        zip_code="12345",
        username_pattern="user123",
        product_code="PROD-123"
    )
    assert obj.username == "john_doe"
    
    # Too short
    with pytest.raises(ValidationError) as exc:
        StringConstraints(
            username="ab",  # Min 3
            password="securepass123",
            bio="Bio",
            required_field="x",
            phone="+12345678901",
            zip_code="12345",
            username_pattern="user123",
            product_code="PROD-123"
        )
    assert "at least 3 characters" in str(exc.value)
    
    # Too long
    with pytest.raises(ValidationError) as exc:
        StringConstraints(
            username="a" * 25,  # Max 20
            password="securepass123",
            bio="Bio",
            required_field="x",
            phone="+12345678901",
            zip_code="12345",
            username_pattern="user123",
            product_code="PROD-123"
        )
    assert "at most 20 characters" in str(exc.value)
    
    print("âœ… String length constraints work!")


def test_pattern_constraints():
    """Test regex pattern validation."""
    # Valid phone
    obj = StringConstraints(
        username="user",
        password="password123",
        bio="Bio",
        required_field="x",
        phone="+12345678901",
        zip_code="12345-6789",
        username_pattern="user_123",
        product_code="PROD-ABC-123"
    )
    assert obj.phone == "+12345678901"
    
    # Invalid phone pattern
    with pytest.raises(ValidationError) as exc:
        StringConstraints(
            username="user",
            password="password123",
            bio="Bio",
            required_field="x",
            phone="invalid-phone",
            zip_code="12345",
            username_pattern="user123",
            product_code="PROD-123"
        )
    assert "string does not match pattern" in str(exc.value).lower()
    
    print("âœ… Pattern constraints work!")


def test_numeric_constraints():
    """Test numeric constraints."""
    # Valid
    obj = NumericConstraints(
        age=25,
        score=85,
        quantity=10,
        price=19.99,
        discount=15.0,
        even_number=42,
        price_in_cents=500,
        money=Decimal("19.99")
    )
    assert obj.age == 25
    
    # Age too low (gt=0)
    with pytest.raises(ValidationError) as exc:
        NumericConstraints(
            age=0,
            score=85,
            quantity=10,
            price=19.99,
            discount=15.0,
            even_number=42,
            price_in_cents=500,
            money=Decimal("19.99")
        )
    assert "greater than 0" in str(exc.value)
    
    # Not even
    with pytest.raises(ValidationError) as exc:
        NumericConstraints(
            age=25,
            score=85,
            quantity=10,
            price=19.99,
            discount=15.0,
            even_number=43,  # Odd!
            price_in_cents=500,
            money=Decimal("19.99")
        )
    assert "multiple of 2" in str(exc.value)
    
    print("âœ… Numeric constraints work!")


def test_collection_constraints():
    """Test collection length constraints."""
    # Valid
    obj = CollectionConstraints(
        tags=["python", "testing"],
        items=[1, 2, 3],
        usernames=["user1", "user2"],
        scores=[1, 2, 3, 4, 5]
    )
    assert len(obj.tags) == 2
    
    # Empty list (min_length=1)
    with pytest.raises(ValidationError) as exc:
        CollectionConstraints(
            tags=[],  # Too few!
            items=[1],
            usernames=["user1"],
            scores=[1, 2, 3, 4, 5]
        )
    assert "at least 1 item" in str(exc.value)
    
    # Too many tags (max_length=10)
    with pytest.raises(ValidationError) as exc:
        CollectionConstraints(
            tags=["tag"] * 11,  # Too many!
            items=[1],
            usernames=["user1"],
            scores=[1, 2, 3, 4, 5]
        )
    assert "at most 10 items" in str(exc.value)
    
    print("âœ… Collection constraints work!")


def test_product_constraints():
    """Test real-world product constraints."""
    # Valid product
    product = Product(
        name="Awesome Product",
        sku="PROD-12345",
        price=Decimal("29.99"),
        stock_quantity=100,
        weight_kg=2.5,
        tags=["electronics", "new"]
    )
    assert product.sku == "PROD-12345"
    
    # Invalid price (too low)
    with pytest.raises(ValidationError) as exc:
        Product(
            name="Product",
            sku="PROD-123",
            price=Decimal("0"),  # Must be > 0
            stock_quantity=10,
            weight_kg=1.0,
            tags=["tag"]
        )
    assert "greater than 0" in str(exc.value)
    
    # Invalid SKU pattern
    with pytest.raises(ValidationError) as exc:
        Product(
            name="Product",
            sku="prod_123",  # Lowercase, underscore not allowed
            price=Decimal("10.00"),
            stock_quantity=10,
            weight_kg=1.0,
            tags=["tag"]
        )
    assert "string does not match pattern" in str(exc.value).lower()
    
    print("âœ… Product constraints work!")


def test_credit_card_constraints():
    """Test credit card validation."""
    # Valid card
    card = CreditCard(
        number="1234567890123456",
        cvv="123",
        expiry_month=12,
        expiry_year=2025,
        cardholder_name="John Doe"
    )
    assert len(card.number) == 16
    
    # Invalid card number (too short)
    with pytest.raises(ValidationError) as exc:
        CreditCard(
            number="123456",
            cvv="123",
            expiry_month=12,
            expiry_year=2025,
            cardholder_name="John Doe"
        )
    assert "does not match pattern" in str(exc.value).lower()
    
    # Invalid month
    with pytest.raises(ValidationError) as exc:
        CreditCard(
            number="1234567890123456",
            cvv="123",
            expiry_month=13,  # Max 12
            expiry_year=2025,
            cardholder_name="John Doe"
        )
    assert "less than or equal to 12" in str(exc.value)
    
    print("âœ… Credit card constraints work!")


def test_api_request_constraints():
    """Test API request constraints."""
    # Valid request
    request = APIRequest(query="search term")
    assert request.page == 1  # Default
    assert request.per_page == 20  # Default
    
    # Custom values
    request2 = APIRequest(
        query="test",
        page=5,
        per_page=50,
        sort_order="desc"
    )
    assert request2.per_page == 50
    
    # Invalid sort order
    with pytest.raises(ValidationError) as exc:
        APIRequest(
            query="test",
            sort_order="invalid"
        )
    assert "does not match pattern" in str(exc.value).lower()
    
    # Invalid per_page (too high)
    with pytest.raises(ValidationError) as exc:
        APIRequest(
            query="test",
            per_page=200  # Max 100
        )
    assert "less than or equal to 100" in str(exc.value)
    
    print("âœ… API request constraints work!")


def test_color_rgb_constraints():
    """Test RGB color constraints."""
    # Valid color
    color = ColorRGB(red=255, green=128, blue=0)
    assert color.red == 255
    assert color.alpha == 1.0  # Default
    
    # With alpha
    color2 = ColorRGB(red=100, green=150, blue=200, alpha=0.5)
    assert color2.alpha == 0.5
    
    # Invalid red (too high)
    with pytest.raises(ValidationError) as exc:
        ColorRGB(red=300, green=128, blue=0)
    assert "less than or equal to 255" in str(exc.value)
    
    # Invalid alpha (negative)
    with pytest.raises(ValidationError) as exc:
        ColorRGB(red=100, green=100, blue=100, alpha=-0.5)
    assert "greater than or equal to 0" in str(exc.value)
    
    print("âœ… RGB color constraints work!")


def test_rating_constraints():
    """Test rating constraints."""
    # Valid rating
    rating = Rating(
        stars=5,
        review="This product is excellent! I highly recommend it to everyone."
    )
    assert rating.stars == 5
    
    # Invalid stars (too low)
    with pytest.raises(ValidationError) as exc:
        Rating(
            stars=0,
            review="This is a review with enough characters to pass validation."
        )
    assert "greater than or equal to 1" in str(exc.value)
    
    # Invalid review (too short)
    with pytest.raises(ValidationError) as exc:
        Rating(
            stars=5,
            review="Too short"  # Min 10 chars
        )
    assert "at least 10 characters" in str(exc.value)
    
    print("âœ… Rating constraints work!")
```

---

## D. Connect & Apply

### How to Test It

```bash
pytest tests/test_field_constraints.py -v -s
```

### Expected Result

```
tests/test_field_constraints.py::test_string_length_constraints PASSED
âœ… String length constraints work!

tests/test_field_constraints.py::test_pattern_constraints PASSED
âœ… Pattern constraints work!

... [all tests pass]

======================== 9 passed in 0.92s =========================
```

---

## E. Quick Reference

### String Constraints
```python
field: str = Field(min_length=3, max_length=20)
field: str = Field(pattern=r'^[A-Z0-9]+$')
```

### Numeric Constraints
```python
field: int = Field(gt=0, lt=100)      # 0 < field < 100
field: int = Field(ge=0, le=100)      # 0 <= field <= 100
field: int = Field(multiple_of=5)     # 0, 5, 10, 15...
```

### Collection Constraints
```python
field: List[str] = Field(min_length=1, max_length=10)
```

---

## F. What You've Learned

âœ… String length constraints (`min_length`, `max_length`)  
âœ… Pattern matching with regex  
âœ… Numeric constraints (`gt`, `ge`, `lt`, `le`, `multiple_of`)  
âœ… Collection size constraints  
âœ… Decimal places for money  
âœ… Common validation patterns  
âœ… Field metadata and documentation  
âœ… Real-world constraint combinations  

---

## G. What's Next?

In **Lesson 3.12 (Parsing httpx Responses to Models)**, we'll learn:
- Parsing httpx JSON responses directly to Pydantic models
- Handling API response validation
- Working with real API endpoints

You're now a constraint expert! ðŸŽ‰

---

**Ready for the next lesson?**
