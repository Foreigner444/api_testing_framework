# 3.17 Response Model Factories

## A. Concept Overview

### What & Why
**Model factories** are reusable functions that create Pydantic model instances with sensible defaults. Instead of manually creating test data every time, factories generate it automatically, making tests cleaner and more maintainable. They're especially useful for testing with varied, realistic data.

### Analogy
Think of model factories like **templates in a document editor**.

Instead of:
- Creating a new document from scratch every time
- Manually filling in name, address, date, etc.
- Repeating this for every test case

You:
- Use a template that auto-fills common fields
- Customize only what's different
- Save hours of repetitive work!

Model factories are your test data templates!

---

## B. Code Implementation

### File Path: `factories/user_factory.py`

```python
"""User model factories for testing."""
from datetime import datetime, date
from typing import Optional, List
from faker import Faker
from models.api_models import User, Address, Company, Geo

fake = Faker()


# ==================== Basic Factories ====================

def create_geo(
    lat: Optional[str] = None,
    lng: Optional[str] = None
) -> Geo:
    """Create a Geo model with defaults."""
    return Geo(
        lat=lat or str(fake.latitude()),
        lng=lng or str(fake.longitude())
    )


def create_address(
    street: Optional[str] = None,
    suite: Optional[str] = None,
    city: Optional[str] = None,
    zipcode: Optional[str] = None,
    geo: Optional[Geo] = None
) -> Address:
    """Create an Address model with defaults."""
    return Address(
        street=street or fake.street_address(),
        suite=suite or f"Apt. {fake.random_int(1, 999)}",
        city=city or fake.city(),
        zipcode=zipcode or fake.zipcode(),
        geo=geo or create_geo()
    )


def create_company(
    name: Optional[str] = None,
    catchPhrase: Optional[str] = None,
    bs: Optional[str] = None
) -> Company:
    """Create a Company model with defaults."""
    return Company(
        name=name or fake.company(),
        catchPhrase=catchPhrase or fake.catch_phrase(),
        bs=bs or fake.bs()
    )


def create_user(
    id: Optional[int] = None,
    name: Optional[str] = None,
    username: Optional[str] = None,
    email: Optional[str] = None,
    address: Optional[Address] = None,
    phone: Optional[str] = None,
    website: Optional[str] = None,
    company: Optional[Company] = None
) -> User:
    """Create a User model with defaults."""
    return User(
        id=id or fake.random_int(1, 10000),
        name=name or fake.name(),
        username=username or fake.user_name(),
        email=email or fake.email(),
        address=address or create_address(),
        phone=phone or fake.phone_number(),
        website=website or fake.domain_name(),
        company=company or create_company()
    )


# ==================== Advanced Factory Patterns ====================

class UserFactory:
    """Class-based user factory with presets."""
    
    @staticmethod
    def create(**kwargs) -> User:
        """Create a user with custom fields."""
        return create_user(**kwargs)
    
    @staticmethod
    def create_batch(count: int, **kwargs) -> List[User]:
        """Create multiple users."""
        return [create_user(**kwargs) for _ in range(count)]
    
    @staticmethod
    def create_admin() -> User:
        """Create an admin user."""
        return create_user(
            username="admin",
            email="admin@example.com",
            company=create_company(name="Admin Corp")
        )
    
    @staticmethod
    def create_regular() -> User:
        """Create a regular user."""
        return create_user(
            username=f"user_{fake.random_int(1000, 9999)}",
            email=fake.free_email()
        )
    
    @staticmethod
    def create_with_location(city: str, country: str = "USA") -> User:
        """Create user with specific location."""
        address = create_address(city=city)
        return create_user(address=address)


# ==================== Sequence Factory ====================

class SequenceFactory:
    """Factory that generates sequential data."""
    
    def __init__(self):
        self.counter = 0
    
    def next(self) -> int:
        """Get next sequential number."""
        self.counter += 1
        return self.counter
    
    def create_user(self, **kwargs) -> User:
        """Create user with sequential ID."""
        user_id = kwargs.pop("id", self.next())
        return create_user(id=user_id, **kwargs)


# ==================== Builder Pattern ====================

class UserBuilder:
    """Builder pattern for constructing users step by step."""
    
    def __init__(self):
        self._id = fake.random_int(1, 10000)
        self._name = fake.name()
        self._username = fake.user_name()
        self._email = fake.email()
        self._address = create_address()
        self._phone = fake.phone_number()
        self._website = fake.domain_name()
        self._company = create_company()
    
    def with_id(self, id: int) -> 'UserBuilder':
        """Set user ID."""
        self._id = id
        return self
    
    def with_name(self, name: str) -> 'UserBuilder':
        """Set user name."""
        self._name = name
        return self
    
    def with_username(self, username: str) -> 'UserBuilder':
        """Set username."""
        self._username = username
        return self
    
    def with_email(self, email: str) -> 'UserBuilder':
        """Set email."""
        self._email = email
        return self
    
    def with_company(self, company_name: str) -> 'UserBuilder':
        """Set company name."""
        self._company = create_company(name=company_name)
        return self
    
    def in_city(self, city: str) -> 'UserBuilder':
        """Set city."""
        self._address = create_address(city=city)
        return self
    
    def build(self) -> User:
        """Build the user."""
        return User(
            id=self._id,
            name=self._name,
            username=self._username,
            email=self._email,
            address=self._address,
            phone=self._phone,
            website=self._website,
            company=self._company
        )
```

---

### File Path: `tests/test_model_factories.py`

```python
"""Tests for model factories."""
import pytest
from factories.user_factory import (
    create_user,
    create_address,
    create_company,
    create_geo,
    UserFactory,
    SequenceFactory,
    UserBuilder
)
from models.api_models import User, Address, Company


# ==================== Basic Factory Tests ====================

def test_create_geo():
    """Test geo factory."""
    geo = create_geo()
    
    assert geo.lat is not None
    assert geo.lng is not None
    
    # Custom values
    custom_geo = create_geo(lat="42.3601", lng="-71.0589")
    assert custom_geo.lat == "42.3601"
    assert custom_geo.lng == "-71.0589"
    
    print(f"âœ… Geo factory works! Lat: {geo.lat}, Lng: {geo.lng}")


def test_create_address():
    """Test address factory."""
    address = create_address()
    
    assert isinstance(address, Address)
    assert len(address.street) > 0
    assert len(address.city) > 0
    assert address.geo is not None
    
    # Custom city
    custom_address = create_address(city="Boston")
    assert custom_address.city == "Boston"
    
    print(f"âœ… Address factory works! City: {address.city}")


def test_create_company():
    """Test company factory."""
    company = create_company()
    
    assert isinstance(company, Company)
    assert len(company.name) > 0
    assert len(company.catchPhrase) > 0
    
    # Custom name
    custom_company = create_company(name="Acme Corp")
    assert custom_company.name == "Acme Corp"
    
    print(f"âœ… Company factory works! Name: {company.name}")


def test_create_user():
    """Test user factory."""
    user = create_user()
    
    assert isinstance(user, User)
    assert user.id > 0
    assert len(user.name) > 0
    assert "@" in user.email
    assert isinstance(user.address, Address)
    assert isinstance(user.company, Company)
    
    print(f"âœ… User factory works! User: {user.name}")


def test_create_user_with_custom_fields():
    """Test user factory with custom fields."""
    user = create_user(
        id=999,
        name="John Doe",
        email="john@example.com"
    )
    
    assert user.id == 999
    assert user.name == "John Doe"
    assert user.email == "john@example.com"
    
    # Other fields auto-generated
    assert user.username is not None
    assert user.address is not None
    
    print(f"âœ… Custom user created: {user.name}")


# ==================== Class Factory Tests ====================

def test_user_factory_create():
    """Test UserFactory.create()."""
    user = UserFactory.create()
    
    assert isinstance(user, User)
    assert user.id > 0
    
    print(f"âœ… UserFactory.create() works!")


def test_user_factory_create_batch():
    """Test creating multiple users."""
    users = UserFactory.create_batch(5)
    
    assert len(users) == 5
    assert all(isinstance(u, User) for u in users)
    assert all(u.id > 0 for u in users)
    
    print(f"âœ… Created batch of {len(users)} users!")


def test_user_factory_create_admin():
    """Test admin user preset."""
    admin = UserFactory.create_admin()
    
    assert admin.username == "admin"
    assert admin.email == "admin@example.com"
    assert admin.company.name == "Admin Corp"
    
    print(f"âœ… Admin user created: {admin.username}")


def test_user_factory_create_regular():
    """Test regular user preset."""
    user = UserFactory.create_regular()
    
    assert user.username.startswith("user_")
    assert "@" in user.email
    
    print(f"âœ… Regular user created: {user.username}")


def test_user_factory_with_location():
    """Test user with specific location."""
    user = UserFactory.create_with_location("Boston")
    
    assert user.address.city == "Boston"
    
    print(f"âœ… User in {user.address.city} created!")


# ==================== Sequence Factory Tests ====================

def test_sequence_factory():
    """Test sequential ID generation."""
    factory = SequenceFactory()
    
    user1 = factory.create_user()
    user2 = factory.create_user()
    user3 = factory.create_user()
    
    assert user1.id == 1
    assert user2.id == 2
    assert user3.id == 3
    
    print(f"âœ… Sequential IDs: {user1.id}, {user2.id}, {user3.id}")


# ==================== Builder Pattern Tests ====================

def test_user_builder_basic():
    """Test basic user builder."""
    user = UserBuilder().build()
    
    assert isinstance(user, User)
    assert user.id > 0
    assert len(user.name) > 0
    
    print(f"âœ… Builder created user: {user.name}")


def test_user_builder_chaining():
    """Test builder method chaining."""
    user = (UserBuilder()
            .with_id(123)
            .with_name("Jane Doe")
            .with_username("janedoe")
            .with_email("jane@example.com")
            .with_company("TechCorp")
            .in_city("San Francisco")
            .build())
    
    assert user.id == 123
    assert user.name == "Jane Doe"
    assert user.username == "janedoe"
    assert user.email == "jane@example.com"
    assert user.company.name == "TechCorp"
    assert user.address.city == "San Francisco"
    
    print(f"âœ… Builder chain created: {user.name} in {user.address.city}")


# ==================== Test Data Reusability ====================

def test_factory_creates_valid_models():
    """Test that factory-created models are valid."""
    users = [create_user() for _ in range(10)]
    
    # All users are valid Pydantic models
    assert all(isinstance(u, User) for u in users)
    
    # All users are different
    ids = [u.id for u in users]
    assert len(set(ids)) == len(ids)  # All unique
    
    emails = [u.email for u in users]
    assert len(set(emails)) == len(emails)  # All unique
    
    print(f"âœ… Created {len(users)} unique, valid users!")


def test_factory_for_parametrized_tests():
    """Test using factories with parametrized tests."""
    test_cases = [
        UserFactory.create(name="Alice"),
        UserFactory.create(name="Bob"),
        UserFactory.create(name="Charlie")
    ]
    
    for user in test_cases:
        assert isinstance(user, User)
        assert len(user.name) > 0
    
    print(f"âœ… Factory works for parametrized tests!")


# ==================== Real-World Usage ====================

def test_factory_in_api_test():
    """Example: Using factory in API test."""
    # Create test user
    expected_user = create_user(
        id=1,
        name="Test User",
        email="test@example.com"
    )
    
    # In real test, you'd compare with API response
    # Here we just demonstrate the pattern
    assert expected_user.id == 1
    assert expected_user.name == "Test User"
    
    print(f"âœ… Factory used in API test simulation!")


def test_multiple_test_scenarios():
    """Test multiple scenarios with factories."""
    # Scenario 1: New user registration
    new_user = UserFactory.create_regular()
    assert new_user.username.startswith("user_")
    
    # Scenario 2: Admin user
    admin = UserFactory.create_admin()
    assert admin.username == "admin"
    
    # Scenario 3: User from specific location
    boston_user = UserFactory.create_with_location("Boston")
    assert boston_user.address.city == "Boston"
    
    print(f"âœ… Multiple test scenarios covered!")


# ==================== Factory Benefits ====================

def test_factory_consistency():
    """Test that factories create consistent data."""
    users = [create_user() for _ in range(100)]
    
    # All have valid structure
    assert all(isinstance(u.address, Address) for u in users)
    assert all(isinstance(u.company, Company) for u in users)
    assert all("@" in u.email for u in users)
    
    print(f"âœ… {len(users)} users all have consistent structure!")


def test_factory_customization():
    """Test factory customization flexibility."""
    # Fully custom user
    custom_user = create_user(
        id=1,
        name="Custom Name",
        username="customuser",
        email="custom@example.com",
        address=create_address(city="Custom City"),
        company=create_company(name="Custom Corp")
    )
    
    assert custom_user.id == 1
    assert custom_user.name == "Custom Name"
    assert custom_user.address.city == "Custom City"
    assert custom_user.company.name == "Custom Corp"
    
    print(f"âœ… Factory allows full customization!")
```

---

## C. Connect & Apply

### How to Test It

```bash
# Run factory tests
pytest tests/test_model_factories.py -v -s
```

### Expected Result

```
tests/test_model_factories.py::test_create_user PASSED
âœ… User factory works! User: John Smith

tests/test_model_factories.py::test_user_factory_create_batch PASSED
âœ… Created batch of 5 users!

tests/test_model_factories.py::test_user_builder_chaining PASSED
âœ… Builder chain created: Jane Doe in San Francisco

tests/test_model_factories.py::test_factory_creates_valid_models PASSED
âœ… Created 10 unique, valid users!

======================== 17 passed in 1.45s =========================
```

---

## D. Factory Patterns Summary

| Pattern | When to Use |
|---------|-------------|
| **Simple Function** | Basic factories, quick tests |
| **Class Factory** | Multiple presets, batch creation |
| **Sequence Factory** | Sequential IDs needed |
| **Builder Pattern** | Complex objects, fluent API |

---

## E. What You've Learned

âœ… Creating model factories with defaults  
âœ… Using Faker for realistic data  
âœ… Class-based factories with presets  
âœ… Sequence factories for IDs  
âœ… Builder pattern for complex objects  
âœ… Batch creation  
âœ… Factory customization  
âœ… Real-world test usage  

---

## F. What's Next?

In **Lesson 3.18 (Best Practices for Pydantic Models)**, we'll learn:
- Model organization strategies
- Performance optimization
- Common pitfalls to avoid
- Production-ready patterns

This is the final lesson! ðŸŽ‰

---

**Ready for the last lesson?**
