# Lesson 6.4: API Keys from Configuration

## A. Concept Overview

### What & Why
**Loading API keys from configuration** instead of hardcoding them enables secure, environment-aware authentication. Essential for multi-environment testingâ€”use safe test keys in development, real keys in production, without changing code.

### Analogy
Loading API keys from configuration is like having a keychain with different keys (dev key, staging key, prod key) where the environment determines which key is used. Same lock mechanism (API), different keys per environment.

---

## B. Code Implementation

```python
from pydantic import SecretStr
from pydantic_settings import BaseSettings, SettingsConfigDict
import httpx
from httpx import Auth, Request


class AuthConfig(BaseSettings):
    """Authentication configuration."""
    
    api_key: SecretStr
    api_key_header_name: str = "X-API-Key"
    
    model_config = SettingsConfigDict(
        env_file=".env",
        env_prefix="API_",
        case_sensitive=False
    )


class ConfiguredAPIKeyAuth(Auth):
    """API Key auth using configuration."""
    
    def __init__(self, config: AuthConfig):
        self.api_key = config.api_key.get_secret_value()
        self.header_name = config.api_key_header_name
    
    def auth_flow(self, request: Request):
        request.headers[self.header_name] = self.api_key
        yield request


# .env.development:
# API_API_KEY=dev_test_key_safe
# API_API_KEY_HEADER_NAME=X-API-Key

# .env.production:
# API_API_KEY=prod_real_secret_key
# API_API_KEY_HEADER_NAME=X-API-Key


# pytest fixture
import pytest

@pytest.fixture(scope="session")
def auth_config():
    return AuthConfig()

@pytest.fixture(scope="session")
def authenticated_client(auth_config):
    auth = ConfiguredAPIKeyAuth(auth_config)
    client = httpx.Client(
        base_url="https://api.example.com",
        auth=auth
    )
    yield client
    client.close()


# Test
def test_api_with_configured_auth(authenticated_client):
    response = authenticated_client.get("/data")
    assert response.status_code == 200
```

---

## C. Connect & Apply

```bash
cat > .env << 'EOF'
API_API_KEY=my_test_key_12345
API_API_KEY_HEADER_NAME=X-API-Key
EOF

pytest tests/test_configured_auth.py -v
```

---

## D. Common Stumbling Blocks

**Mistake:** Hardcoding API key instead of using config
**Fix:** Always load from AuthConfig

---

## ðŸŽ¯ Key Takeaways

âœ… **Load API keys** from configuration (env vars)  
âœ… **Use SecretStr** to protect keys  
âœ… **Different keys** per environment  
âœ… **pytest fixtures** for configured auth  

---

## What's Next?

Next: **Bearer Token Authentication**!

**Ready to continue?** ðŸš€
