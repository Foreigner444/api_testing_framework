# Lesson 6.12: Decoding and Validating JWT

## A. Concept Overview

### What & Why
**Decoding and validating JWTs** verifies token authenticity, checks signatures, and validates claims (expiration, issuer, audience). Essential for secure testingâ€”never trust tokens without validation.

### Analogy
Validating a JWT is like verifying a diplomaâ€”check the school's seal (signature), verify it hasn't expired (expiration), and confirm it's issued to the right person (claims).

---

## B. Code Implementation

```python
import jwt
from datetime import datetime, timedelta
import pytest


def validate_jwt(token: str, secret: str) -> dict:
    """
    Decode and validate JWT token.
    
    Checks:
    - Signature is valid
    - Token hasn't expired
    - Required claims are present
    """
    try:
        # Decode with verification
        payload = jwt.decode(
            token,
            secret,
            algorithms=["HS256"]
        )
        
        # Additional validation
        required_claims = ["sub", "exp"]
        for claim in required_claims:
            if claim not in payload:
                raise ValueError(f"Missing required claim: {claim}")
        
        return payload
        
    except jwt.ExpiredSignatureError:
        raise ValueError("Token has expired")
    except jwt.InvalidTokenError as e:
        raise ValueError(f"Invalid token: {e}")


# Testing
def test_valid_jwt():
    """Test valid JWT decodes successfully."""
    secret = "test_secret"
    
    # Create valid token
    payload = {
        "sub": "user123",
        "name": "Test User",
        "exp": datetime.utcnow() + timedelta(hours=1)
    }
    
    token = jwt.encode(payload, secret, algorithm="HS256")
    
    # Validate
    decoded = validate_jwt(token, secret)
    assert decoded["sub"] == "user123"
    assert decoded["name"] == "Test User"


def test_expired_jwt_fails():
    """Test expired JWT raises error."""
    secret = "test_secret"
    
    # Create expired token
    payload = {
        "sub": "user123",
        "exp": datetime.utcnow() - timedelta(hours=1)  # Already expired
    }
    
    token = jwt.encode(payload, secret, algorithm="HS256")
    
    # Should raise error
    with pytest.raises(ValueError, match="expired"):
        validate_jwt(token, secret)


def test_invalid_signature_fails():
    """Test JWT with invalid signature fails validation."""
    secret = "correct_secret"
    wrong_secret = "wrong_secret"
    
    # Create token with one secret
    payload = {"sub": "user123", "exp": datetime.utcnow() + timedelta(hours=1)}
    token = jwt.encode(payload, secret, algorithm="HS256")
    
    # Validate with different secret
    with pytest.raises(ValueError, match="Invalid token"):
        validate_jwt(token, wrong_secret)
```

---

## C. Connect & Apply

```bash
pip install PyJWT

python -c "
import jwt
from datetime import datetime, timedelta

payload = {'sub': 'user123', 'exp': datetime.utcnow() + timedelta(hours=1)}
token = jwt.encode(payload, 'secret', algorithm='HS256')
decoded = jwt.decode(token, 'secret', algorithms=['HS256'])
print(decoded)
"
```

---

## D. Common Stumbling Blocks

**Mistake:** Not specifying algorithms parameter
**Fix:** Always use `algorithms=["HS256"]` when decoding

---

## ðŸŽ¯ Key Takeaways

âœ… Always validate JWT signatures  
âœ… Check expiration (exp claim)  
âœ… Verify required claims present  
âœ… Use PyJWT library  

---

## What's Next?

Next: **Pydantic Models for JWT Claims**!

**Ready to continue?** ðŸš€
