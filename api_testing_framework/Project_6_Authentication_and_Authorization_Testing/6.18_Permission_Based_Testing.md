# Lesson 6.18: Permission Based Testing

## A. Concept Overview

### What & Why
**Permission-based testing** validates fine-grained access control where users have specific permissions (read:users, write:posts, delete:comments) rather than broad roles. Essential for complex APIs with granular authorization.

### Analogy
Permissions are like app permissions on your phoneâ€”Camera app needs camera permission, Maps needs location permission, each app gets only what it needs (principle of least privilege).

---

## B. Code Implementation

```python
import httpx
import pytest


# Permission-based test data
USER_PERMISSIONS = {
    "editor": ["read:posts", "write:posts", "edit:posts"],
    "viewer": ["read:posts"],
    "moderator": ["read:posts", "read:users", "delete:comments"],
    "admin": ["read:*", "write:*", "delete:*"]
}


@pytest.mark.parametrize("permission,endpoint,method,should_succeed", [
    ("read:posts", "/posts", "GET", True),
    ("read:posts", "/posts/1", "DELETE", False),
    ("write:posts", "/posts", "POST", True),
    ("delete:comments", "/comments/1", "DELETE", True),
    ("read:users", "/admin/users", "GET", False),  # Needs different permission
])
def test_permission_based_access(permission, endpoint, method, should_succeed):
    """Test access based on specific permissions."""
    
    # Create client with specific permission
    client = httpx.Client(
        base_url="https://api.example.com",
        headers={"X-Permissions": permission}
    )
    
    response = client.request(method, endpoint)
    
    if should_succeed:
        assert response.status_code == 200
    else:
        assert response.status_code == 403


def test_user_with_multiple_permissions():
    """Test user with multiple permissions."""
    permissions = ["read:posts", "write:posts", "delete:own_posts"]
    
    client = httpx.Client(
        base_url="https://api.example.com",
        headers={"X-Permissions": ",".join(permissions)}
    )
    
    # Can read
    assert client.get("/posts").status_code == 200
    
    # Can write
    assert client.post("/posts", json={}).status_code == 201
    
    # Cannot delete others' posts
    assert client.delete("/posts/other_user_post").status_code == 403
```

---

## C. Connect & Apply

Test permission-based access with different permission combinations.

---

## D. Common Stumbling Blocks

**Mistake:** Not testing permission combinations
**Fix:** Test all required permission combinations

---

## ðŸŽ¯ Key Takeaways

âœ… Permissions for fine-grained access control  
âœ… Test each permission explicitly  
âœ… Parametrize for coverage  
âœ… Principle of least privilege  

---

## What's Next?

Next: **Security Testing Basics**!

**Ready to continue?** ðŸš€
