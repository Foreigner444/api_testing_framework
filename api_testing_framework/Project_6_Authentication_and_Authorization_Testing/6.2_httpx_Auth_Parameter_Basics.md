# Lesson 6.2: httpx Auth Parameter Basics

## A. Concept Overview

### What & Why
**The httpx auth parameter** provides a clean, standardized way to handle authentication in HTTP requests. It's important because it simplifies credential management, works with built-in auth schemes, and allows custom authentication logic without manually manipulating headers for every request.

### Analogy
The auth parameter is like a digital wallet that automatically presents your credentials when needed. Instead of manually pulling out your credit card (adding auth headers) for every purchase (request), your digital wallet (auth parameter) handles it automatically and securely.

---

## B. Code Implementation

### Basic httpx Auth Parameter Usage

**File Path:** `examples/httpx_auth_basics.py`

```python
import httpx
from httpx import Auth, Request, Response


# Method 1: Basic Authentication (built-in)
def basic_auth_example():
    """Using httpx built-in basic auth."""
    
    # Manual approach (tedious)
    client_manual = httpx.Client(
        base_url="https://api.example.com",
        headers={"Authorization": "Basic dXNlcjpwYXNz"}  # base64("user:pass")
    )
    
    # httpx auth parameter (clean)
    client_auto = httpx.Client(
        base_url="https://api.example.com",
        auth=("username", "password")  # Automatically encodes to Basic auth
    )
    
    response = client_auto.get("/protected")
    print(f"Status: {response.status_code}")


# Method 2: Custom Auth Class
class BearerAuth(Auth):
    """Custom authentication class for Bearer tokens."""
    
    def __init__(self, token: str):
        self.token = token
    
    def auth_flow(self, request: Request):
        """Add Bearer token to each request."""
        request.headers["Authorization"] = f"Bearer {self.token}"
        yield request


def bearer_auth_example():
    """Using custom Bearer auth class."""
    
    auth = BearerAuth(token="my_jwt_token_abc123")
    
    client = httpx.Client(
        base_url="https://api.example.com",
        auth=auth  # Automatically adds Bearer token to all requests
    )
    
    # All requests automatically include auth header
    response1 = client.get("/users")
    response2 = client.post("/posts", json={"title": "Hello"})
    response3 = client.get("/profile")
    # No need to add Authorization header manually!


# Method 3: API Key Auth Class
class APIKeyAuth(Auth):
    """Custom authentication class for API keys."""
    
    def __init__(self, api_key: str, header_name: str = "X-API-Key"):
        self.api_key = api_key
        self.header_name = header_name
    
    def auth_flow(self, request: Request):
        """Add API key to each request."""
        request.headers[self.header_name] = self.api_key
        yield request


def api_key_example():
    """Using API key authentication."""
    
    auth = APIKeyAuth(api_key="my_api_key_12345")
    
    client = httpx.Client(
        base_url="https://api.example.com",
        auth=auth
    )
    
    response = client.get("/data")
    # Request automatically includes: X-API-Key: my_api_key_12345
```

---

### Auth vs Headers: When to Use Each

```python
# ‚ùå Manual headers (tedious, error-prone)
def test_with_manual_headers():
    token = "my_token"
    
    client = httpx.Client(base_url="https://api.example.com")
    
    # Must add header to EVERY request
    response1 = client.get("/users", headers={"Authorization": f"Bearer {token}"})
    response2 = client.post("/posts", json={...}, headers={"Authorization": f"Bearer {token}"})
    response3 = client.get("/profile", headers={"Authorization": f"Bearer {token}"})


# ‚úÖ Auth parameter (clean, automatic)
def test_with_auth_parameter():
    auth = BearerAuth(token="my_token")
    
    client = httpx.Client(
        base_url="https://api.example.com",
        auth=auth  # Set once
    )
    
    # Auth automatically added to all requests
    response1 = client.get("/users")
    response2 = client.post("/posts", json={...})
    response3 = client.get("/profile")
```

---

### Combining Auth with Configuration

**File Path:** `config/auth_config.py`

```python
from pydantic import SecretStr
from pydantic_settings import BaseSettings, SettingsConfigDict
from httpx import Auth, Request


class AuthSettings(BaseSettings):
    """Authentication configuration from environment."""
    
    api_key: SecretStr
    auth_type: str = "bearer"  # bearer, basic, api_key
    
    model_config = SettingsConfigDict(
        env_file=".env",
        env_prefix="AUTH_"
    )


class ConfiguredBearerAuth(Auth):
    """Bearer auth using configuration."""
    
    def __init__(self, settings: AuthSettings):
        self.token = settings.api_key.get_secret_value()
    
    def auth_flow(self, request: Request):
        request.headers["Authorization"] = f"Bearer {self.token}"
        yield request


# Usage
settings = AuthSettings()
auth = ConfiguredBearerAuth(settings)

client = httpx.Client(
    base_url="https://api.example.com",
    auth=auth  # Auth from configuration
)
```

---

## C. Connect & Apply

### How to Test It

```python
# Test basic auth
client = httpx.Client(
    base_url="https://httpbin.org",
    auth=("testuser", "testpass")
)
response = client.get("/basic-auth/testuser/testpass")
print(f"Basic auth: {response.status_code}")  # 200

# Test custom Bearer auth
class BearerAuth(httpx.Auth):
    def __init__(self, token):
        self.token = token
    
    def auth_flow(self, request):
        request.headers["Authorization"] = f"Bearer {self.token}"
        yield request

client = httpx.Client(
    base_url="https://api.example.com",
    auth=BearerAuth("test_token")
)
response = client.get("/protected")
```

### Expected Result

```
Basic auth: 200
Bearer auth configured automatically for all requests
```

---

## D. Common Stumbling Blocks

### Mistake #1: Forgetting to yield in auth_flow

**The Problem:**

```python
class BadAuth(Auth):
    def auth_flow(self, request):
        request.headers["Authorization"] = "Bearer token"
        # ‚ùå Missing yield!
```

**Error:** `auth_flow must yield at least one request`

**The Fix:**

```python
class GoodAuth(Auth):
    def auth_flow(self, request):
        request.headers["Authorization"] = "Bearer token"
        yield request  # ‚úÖ Required!
```

---

### Mistake #2: Using auth parameter with AsyncClient incorrectly

**The Problem:**

```python
# Auth class doesn't support async
class SyncAuth(Auth):
    def auth_flow(self, request):
        yield request

async with httpx.AsyncClient(auth=SyncAuth()) as client:
    # May have issues
```

**The Fix:**

```python
# Auth classes work with both sync and async
class UniversalAuth(Auth):
    def auth_flow(self, request):
        # This works with both Client and AsyncClient
        yield request
```

---

## üéØ Key Takeaways

‚úÖ **auth parameter** provides clean authentication handling in httpx  
‚úÖ **Built-in support** for Basic authentication with tuple `(user, pass)`  
‚úÖ **Custom Auth classes** for Bearer tokens, API keys, etc.  
‚úÖ **auth_flow method** must `yield request` after modifying it  
‚úÖ **Set once** on client, applies to all requests automatically  
‚úÖ **Cleaner than** manually adding headers to every request  

---

## What's Next?

Next lesson: **API Key Authentication with httpx** - implementing and testing API key authentication!

**Ready to continue?** üöÄ
