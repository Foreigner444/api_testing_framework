# Lesson 6.1: Authentication vs Authorization

## A. Concept Overview

### What & Why
**Authentication** verifies WHO you are (proving identity), while **Authorization** determines WHAT you can do (permissions). Understanding this distinction is critical for API testing because you need to test both identity verification AND permission enforcementâ€”they're different security layers with different test strategies.

### Analogy
Think of an airport: **Authentication** is showing your ID at security (proving you are who you claim to be). **Authorization** is your boarding pass determining which plane you can board and where you can sit (what you're allowed to do). You need valid ID AND the right boarding passâ€”both are checked, both can fail.

---

## B. Code Implementation

### Authentication Example (WHO you are)

**File Path:** `examples/authentication_example.py`

```python
import httpx


def demonstrate_authentication():
    """
    Authentication: Proving your identity to the API.
    """
    
    # âŒ No authentication - API doesn't know who you are
    client = httpx.Client(base_url="https://api.example.com")
    response = client.get("/profile")
    # Result: 401 Unauthorized - "Who are you?"
    print(f"No auth: {response.status_code}")  # 401
    
    # âœ… With authentication - API knows you're user "john@example.com"
    authenticated_client = httpx.Client(
        base_url="https://api.example.com",
        headers={"Authorization": "Bearer user_token_abc123"}
    )
    response = authenticated_client.get("/profile")
    # Result: 200 OK - "Welcome, John!"
    print(f"With auth: {response.status_code}")  # 200
    print(f"User: {response.json()['email']}")  # john@example.com


# Authentication answers: "WHO are you?"
# - API Key: "You're client application XYZ"
# - JWT Token: "You're user john@example.com, verified at 2024-01-15"
# - OAuth: "You're the user authenticated via Google"
# - Basic Auth: "You're user 'admin' with correct password"
```

---

### Authorization Example (WHAT you can do)

**File Path:** `examples/authorization_example.py`

```python
import httpx


def demonstrate_authorization():
    """
    Authorization: Determining what actions you're allowed to perform.
    """
    
    # Authenticated as regular user
    user_token = "user_token_regular_permissions"
    user_client = httpx.Client(
        base_url="https://api.example.com",
        headers={"Authorization": f"Bearer {user_token}"}
    )
    
    # âœ… Allowed: Read own profile (user has permission)
    response = user_client.get("/profile")
    print(f"Read own profile: {response.status_code}")  # 200 OK
    
    # âŒ Forbidden: Delete another user (user lacks permission)
    response = user_client.delete("/users/456")
    print(f"Delete other user: {response.status_code}")  # 403 Forbidden
    
    # Authenticated as admin
    admin_token = "admin_token_full_permissions"
    admin_client = httpx.Client(
        base_url="https://api.example.com",
        headers={"Authorization": f"Bearer {admin_token}"}
    )
    
    # âœ… Allowed: Delete user (admin has permission)
    response = admin_client.delete("/users/456")
    print(f"Admin delete user: {response.status_code}")  # 200 OK
    
    # Both users are AUTHENTICATED (identity verified)
    # But they have different AUTHORIZATION (different permissions)


# Authorization answers: "WHAT can you do?"
# - Regular user: Read own data, update own profile
# - Admin user: Read all data, update/delete any user
# - Service account: Access backend APIs, no UI access
# - Guest: Read public data only
```

---

### Testing Both Authentication and Authorization

**File Path:** `tests/test_auth_vs_authz.py`

```python
import httpx
import pytest


class TestAuthentication:
    """Test authentication (identity verification)."""
    
    def test_missing_credentials_returns_401(self):
        """API rejects requests without credentials."""
        client = httpx.Client(base_url="https://api.example.com")
        response = client.get("/protected-endpoint")
        
        assert response.status_code == 401
        assert "unauthorized" in response.json()["error"].lower()
    
    def test_invalid_credentials_returns_401(self):
        """API rejects requests with invalid credentials."""
        client = httpx.Client(
            base_url="https://api.example.com",
            headers={"Authorization": "Bearer invalid_token"}
        )
        response = client.get("/protected-endpoint")
        
        assert response.status_code == 401
    
    def test_valid_credentials_returns_200(self):
        """API accepts requests with valid credentials."""
        client = httpx.Client(
            base_url="https://api.example.com",
            headers={"Authorization": "Bearer valid_token"}
        )
        response = client.get("/profile")
        
        assert response.status_code == 200
        assert "email" in response.json()


class TestAuthorization:
    """Test authorization (permission enforcement)."""
    
    @pytest.fixture
    def regular_user_client(self):
        """Client authenticated as regular user."""
        return httpx.Client(
            base_url="https://api.example.com",
            headers={"Authorization": "Bearer regular_user_token"}
        )
    
    @pytest.fixture
    def admin_client(self):
        """Client authenticated as admin user."""
        return httpx.Client(
            base_url="https://api.example.com",
            headers={"Authorization": "Bearer admin_token"}
        )
    
    def test_user_can_read_own_data(self, regular_user_client):
        """Regular users can read their own data."""
        response = regular_user_client.get("/profile")
        assert response.status_code == 200
    
    def test_user_cannot_delete_others(self, regular_user_client):
        """Regular users cannot delete other users (authorization check)."""
        response = regular_user_client.delete("/users/other-user-id")
        
        # 403 Forbidden: Authenticated but not authorized
        assert response.status_code == 403
        assert "forbidden" in response.json()["error"].lower()
    
    def test_admin_can_delete_users(self, admin_client):
        """Admins can delete users (has permission)."""
        response = admin_client.delete("/users/some-user-id")
        
        # 200 OK: Authenticated AND authorized
        assert response.status_code in [200, 204]
    
    def test_user_cannot_access_admin_endpoints(self, regular_user_client):
        """Regular users cannot access admin-only endpoints."""
        response = regular_user_client.get("/admin/dashboard")
        
        assert response.status_code == 403
```

---

### Status Codes: Authentication vs Authorization

```python
"""
HTTP Status Codes for Auth Testing:

Authentication Failures (Identity Issues):
- 401 Unauthorized: No credentials provided
- 401 Unauthorized: Invalid credentials (wrong password/token)
- 401 Unauthorized: Expired credentials (token expired)

Authorization Failures (Permission Issues):
- 403 Forbidden: Valid identity, but lacking permission
- 403 Forbidden: Correct user, wrong role
- 403 Forbidden: Resource access denied

Success:
- 200 OK: Authenticated AND authorized
- 204 No Content: Authorized action completed (e.g., delete)

Common Confusion:
âŒ WRONG: Using 401 when user lacks permission
âœ… RIGHT: 401 = authentication problem, 403 = authorization problem
"""


def test_status_code_correctness():
    """Verify API returns correct status codes."""
    
    # No credentials â†’ 401 (not 403!)
    response = client.get("/profile")
    assert response.status_code == 401, "Missing auth should return 401"
    
    # Valid credentials, insufficient permission â†’ 403 (not 401!)
    response = authenticated_client.delete("/admin/users")
    assert response.status_code == 403, "Insufficient permission should return 403"
```

---

### Real-World Scenarios

**File Path:** `examples/real_world_scenarios.py`

```python
"""
Real-world authentication vs authorization scenarios.
"""


# Scenario 1: Social Media API
class SocialMediaAPI:
    """
    Authentication: Login with username/password or OAuth
    Authorization: 
    - Regular users can post/read their feed
    - Moderators can delete inappropriate posts
    - Admins can ban users
    """
    
    def test_user_can_post(authenticated_user_client):
        # Authenticated: User proved identity
        # Authorized: Users have permission to post
        response = authenticated_user_client.post("/posts", json={"content": "Hello"})
        assert response.status_code == 201
    
    def test_user_cannot_ban_users(authenticated_user_client):
        # Authenticated: Valid user
        # NOT Authorized: Regular users can't ban
        response = authenticated_user_client.post("/admin/ban-user", json={"user_id": 123})
        assert response.status_code == 403


# Scenario 2: Banking API
class BankingAPI:
    """
    Authentication: Multi-factor authentication (password + OTP)
    Authorization:
    - View own accounts only
    - Transfer money from own accounts only
    - Cannot view others' accounts (even if you guess the account ID)
    """
    
    def test_cannot_view_other_account(authenticated_client):
        # Trying to access someone else's account
        response = authenticated_client.get("/accounts/other-person-account-id")
        assert response.status_code == 403


# Scenario 3: Multi-Tenant SaaS API
class MultiTenantAPI:
    """
    Authentication: API key identifies the tenant
    Authorization: 
    - Can only access data within own tenant
    - Tenant admin vs tenant user permissions
    """
    
    def test_tenant_data_isolation(tenant_a_client, tenant_b_client):
        # Tenant A creates a resource
        response = tenant_a_client.post("/resources", json={"name": "Secret Data"})
        resource_id = response.json()["id"]
        
        # Tenant B tries to access it
        response = tenant_b_client.get(f"/resources/{resource_id}")
        assert response.status_code == 403  # Authorization failure
```

---

## C. Connect & Apply

### How to Test It

```python
# Create test file
cat > tests/test_auth_authz_basics.py << 'EOF'
import httpx
import pytest

def test_no_auth_gets_401():
    """No credentials = authentication failure."""
    client = httpx.Client(base_url="https://reqres.in/api")
    # This endpoint might not require auth, but demonstrates concept
    response = client.get("/users/1")
    # Note: reqres.in doesn't require auth, so this returns 200
    # Use an API that requires auth for real 401 testing
    
def test_valid_auth_but_no_permission_gets_403():
    """Valid identity but insufficient permission = authorization failure."""
    # Authenticated as regular user
    client = httpx.Client(
        base_url="https://api.example.com",
        headers={"Authorization": "Bearer user_token"}
    )
    # Try to access admin endpoint
    response = client.get("/admin/settings")
    # Should return 403 Forbidden
    assert response.status_code == 403
EOF

pytest tests/test_auth_authz_basics.py -v
```

### Expected Result

```
tests/test_auth_authz_basics.py::test_no_auth_gets_401 PASSED
tests/test_auth_authz_basics.py::test_valid_auth_but_no_permission_gets_403 PASSED

Key Differences Demonstrated:
- 401: "I don't know who you are" (authentication failure)
- 403: "I know who you are, but you can't do that" (authorization failure)
```

---

## D. Common Stumbling Blocks

### Mistake #1: Confusing 401 and 403

**The Problem:**

```python
# âŒ WRONG: Expecting 401 when user lacks permission
def test_user_cannot_delete_admin_data(user_client):
    response = user_client.delete("/admin/data")
    assert response.status_code == 401  # WRONG!
```

**The Fix:**

```python
# âœ… RIGHT: 403 for authorization failures
def test_user_cannot_delete_admin_data(user_client):
    response = user_client.delete("/admin/data")
    assert response.status_code == 403  # User is authenticated but not authorized
```

**Remember:**
- **401 Unauthorized**: "Who are you?" (missing/invalid credentials)
- **403 Forbidden**: "I know who you are, but you can't do that" (insufficient permissions)

---

### Mistake #2: Testing only authentication, not authorization

**The Problem:**

```python
# âŒ Incomplete: Only tests if login works
def test_login():
    response = client.post("/login", json={"user": "john", "pass": "secret"})
    assert response.status_code == 200
    # But does the token actually grant the right permissions?
```

**The Fix:**

```python
# âœ… Complete: Test both authentication and authorization
def test_login_and_permissions():
    # Authenticate
    response = client.post("/login", json={"user": "john", "pass": "secret"})
    assert response.status_code == 200
    token = response.json()["token"]
    
    # Verify authorization - what can this user do?
    auth_client = httpx.Client(
        base_url="https://api.example.com",
        headers={"Authorization": f"Bearer {token}"}
    )
    
    # Can read own data
    assert auth_client.get("/profile").status_code == 200
    
    # Cannot access admin endpoints
    assert auth_client.get("/admin/users").status_code == 403
```

---

### Mistake #3: Assuming authentication implies authorization

**The Problem:**

```python
# âŒ Dangerous assumption
def test_authenticated_user_can_delete_everything():
    # User has valid token (authenticated)
    # Assumes they can delete anything (wrong!)
    response = authenticated_client.delete("/users/admin-account")
    # This should be 403, not 200!
```

**The Fix:**

```python
# âœ… Test authorization explicitly
def test_authorization_prevents_unauthorized_deletion():
    # User is authenticated (has valid token)
    response = authenticated_user_client.delete("/users/admin-account")
    
    # But not authorized to delete admin accounts
    assert response.status_code == 403
    assert "permission" in response.json()["error"].lower()
```

---

## ğŸ¯ Key Takeaways

âœ… **Authentication** = Identity verification (WHO you are)  
âœ… **Authorization** = Permission enforcement (WHAT you can do)  
âœ… **401 Unauthorized** = Authentication failure (bad/missing credentials)  
âœ… **403 Forbidden** = Authorization failure (valid identity, insufficient permissions)  
âœ… **Test both layers** - authentication AND authorization  
âœ… **Don't assume** authenticated users can do everything  
âœ… **Different roles** require different authorization tests  

---

### Authentication Methods (What You'll Learn)

| Method | Proves Identity Via | Use Case |
|--------|-------------------|----------|
| API Key | Static key in header | Service-to-service |
| Bearer Token | JWT or opaque token | Modern APIs |
| Basic Auth | Username + password | Simple auth |
| OAuth 2.0 | Third-party provider | Social login |
| Session Cookie | Server-side session | Web applications |

---

### Authorization Models (What You'll Test)

| Model | How It Works | Example |
|-------|--------------|---------|
| Role-Based (RBAC) | User has roles | Admin, User, Guest |
| Permission-Based | User has permissions | read:posts, delete:users |
| Attribute-Based (ABAC) | User attributes checked | department=engineering |
| Resource-Based | Ownership checks | Can edit own posts only |

---

## What's Next?

In the next lesson, we'll dive into **httpx Auth Parameter Basics**â€”learning how to use httpx's built-in authentication features to handle credentials in your API tests!

**Ready to continue?** ğŸš€
