# Lesson 6.3: API Key Authentication with httpx

## A. Concept Overview

### What & Why
**API Key authentication** uses a static secret key to identify and authenticate API clients. It's one of the simplest auth methods, commonly used for service-to-service communication and developer APIs. Important to understand because many APIs (Stripe, OpenAI, GitHub) use API keys as primary authentication.

### Analogy
An API key is like a building access cardâ€”swipe it at the reader (send it in header), and if it's valid, you get in. Lost your card? Deactivate it and get a new one. Simple, effective for trusted access.

---

## B. Code Implementation

### Basic API Key Authentication

**File Path:** `examples/api_key_auth.py`

```python
import httpx
from httpx import Auth, Request


class APIKeyAuth(Auth):
    """
    API Key authentication for httpx.
    
    Adds API key to request headers automatically.
    """
    
    def __init__(self, api_key: str, header_name: str = "X-API-Key"):
        """
        Initialize API key authentication.
        
        Args:
            api_key: The API key value
            header_name: Header name (default: X-API-Key)
        """
        self.api_key = api_key
        self.header_name = header_name
    
    def auth_flow(self, request: Request):
        """Add API key to request headers."""
        request.headers[self.header_name] = self.api_key
        yield request


# Usage
auth = APIKeyAuth(api_key="sk_test_abc123xyz789")

client = httpx.Client(
    base_url="https://api.example.com",
    auth=auth
)

# All requests automatically include X-API-Key header
response = client.get("/users")
response = client.post("/data", json={"value": 123})
```

---

### Different API Key Header Names

```python
# Common API key header names across different APIs

# Standard (many APIs)
auth_standard = APIKeyAuth("key123", header_name="X-API-Key")

# Authorization header (some APIs)
class AuthorizationAPIKey(Auth):
    def __init__(self, api_key: str):
        self.api_key = api_key
    
    def auth_flow(self, request: Request):
        request.headers["Authorization"] = f"ApiKey {self.api_key}"
        yield request

# Custom header names
auth_custom = APIKeyAuth("key123", header_name="X-Custom-Auth-Key")

# Query parameter instead of header (less common, less secure)
def api_key_in_query():
    client = httpx.Client(base_url="https://api.example.com")
    response = client.get("/data", params={"api_key": "key123"})
    # Note: Less secure - appears in logs, browser history
```

---

### Testing API Key Authentication

**File Path:** `tests/test_api_key_auth.py`

```python
import httpx
import pytest
from auth.api_key_auth import APIKeyAuth


def test_api_key_in_header():
    """Test that API key is added to request headers."""
    
    auth = APIKeyAuth(api_key="test_key_12345")
    
    # Use httpbin to echo back headers
    client = httpx.Client(
        base_url="https://httpbin.org",
        auth=auth
    )
    
    response = client.get("/headers")
    headers = response.json()["headers"]
    
    # Verify API key was sent
    assert "X-Api-Key" in headers
    assert headers["X-Api-Key"] == "test_key_12345"


def test_without_api_key_fails():
    """Test that requests without API key are rejected."""
    
    # No auth
    client = httpx.Client(base_url="https://api.example.com")
    response = client.get("/protected-endpoint")
    
    assert response.status_code == 401
    error = response.json()
    assert "api key" in error.get("message", "").lower()


def test_with_invalid_api_key_fails():
    """Test that invalid API keys are rejected."""
    
    auth = APIKeyAuth(api_key="invalid_key")
    
    client = httpx.Client(
        base_url="https://api.example.com",
        auth=auth
    )
    
    response = client.get("/data")
    
    assert response.status_code == 401
    error = response.json()
    assert "invalid" in error.get("message", "").lower()


def test_with_valid_api_key_succeeds():
    """Test that valid API key grants access."""
    
    auth = APIKeyAuth(api_key="valid_key_from_config")
    
    client = httpx.Client(
        base_url="https://api.example.com",
        auth=auth
    )
    
    response = client.get("/data")
    
    assert response.status_code == 200
    assert "data" in response.json()
```

---

## C. Connect & Apply

### How to Test It

```python
# Create auth class
from httpx import Auth, Request

class APIKeyAuth(Auth):
    def __init__(self, api_key: str):
        self.api_key = api_key
    
    def auth_flow(self, request: Request):
        request.headers["X-API-Key"] = self.api_key
        yield request

# Test with httpbin
client = httpx.Client(
    base_url="https://httpbin.org",
    auth=APIKeyAuth("my_test_key")
)

response = client.get("/headers")
print(response.json()["headers"])
```

### Expected Result

```json
{
  "headers": {
    "X-Api-Key": "my_test_key",
    "Host": "httpbin.org",
    ...
  }
}
```

---

## D. Common Stumbling Blocks

### Mistake #1: Wrong header name

**The Problem:** Different APIs use different header names for API keys

```python
# Your code
auth = APIKeyAuth(api_key="key", header_name="X-API-Key")

# But API expects "Authorization: ApiKey {key}"
# Result: 401 Unauthorized
```

**The Fix:** Check API documentation for exact header name and format

---

### Mistake #2: Exposing API key in logs

**The Problem:**

```python
print(f"Using API key: {api_key}")  # Logged!
logger.info(f"Auth header: {request.headers}")  # Key exposed!
```

**The Fix:**

```python
from pydantic import SecretStr

api_key = SecretStr("secret_key")
print(f"Using API key: ***")  # Don't log actual value
```

---

## ðŸŽ¯ Key Takeaways

âœ… **auth parameter** in httpx for clean authentication  
âœ… **Built-in Basic auth** with tuple `(user, pass)`  
âœ… **Custom Auth classes** for API keys, Bearer tokens  
âœ… **auth_flow method** adds auth to all requests automatically  
âœ… **Check API docs** for correct header name  
âœ… **Never log** API keys or tokens  

---

## What's Next?

Next: **API Keys from Configuration** - loading API keys securely from environment variables!

**Ready to continue?** ðŸš€
