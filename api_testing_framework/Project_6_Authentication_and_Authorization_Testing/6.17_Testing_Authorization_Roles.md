# Lesson 6.17: Testing Authorization Roles

## A. Concept Overview

### What & Why
**Role-Based Access Control (RBAC) testing** validates that users with different roles (admin, user, guest) have appropriate permissions. Critical for securityâ€”ensure users can only access resources their role permits.

### Analogy
RBAC is like employee badgesâ€”janitors access all rooms but can't modify security systems, managers access offices and systems, executives access everything. Same building, different access levels.

---

## B. Code Implementation

```python
import httpx
import pytest


# Role-based client fixtures
@pytest.fixture
def admin_client():
    """Client authenticated as admin."""
    return httpx.Client(
        base_url="https://api.example.com",
        headers={"Authorization": "Bearer admin_token"}
    )


@pytest.fixture
def user_client():
    """Client authenticated as regular user."""
    return httpx.Client(
        base_url="https://api.example.com",
        headers={"Authorization": "Bearer user_token"}
    )


@pytest.fixture
def guest_client():
    """Client authenticated as guest."""
    return httpx.Client(
        base_url="https://api.example.com",
        headers={"Authorization": "Bearer guest_token"}
    )


# Tests
def test_admin_can_access_all_resources(admin_client):
    """Admins have full access."""
    assert admin_client.get("/users").status_code == 200
    assert admin_client.get("/admin/settings").status_code == 200
    assert admin_client.delete("/users/123").status_code == 200


def test_user_has_limited_access(user_client):
    """Regular users have limited access."""
    assert user_client.get("/profile").status_code == 200
    assert user_client.get("/users").status_code == 403
    assert user_client.delete("/users/123").status_code == 403


def test_guest_read_only_access(guest_client):
    """Guests have read-only access."""
    assert guest_client.get("/public/posts").status_code == 200
    assert guest_client.post("/posts", json={}).status_code == 403


@pytest.mark.parametrize("role,endpoint,method,expected_status", [
    ("admin", "/users", "GET", 200),
    ("admin", "/users/1", "DELETE", 200),
    ("user", "/users", "GET", 403),
    ("user", "/profile", "GET", 200),
    ("user", "/users/1", "DELETE", 403),
    ("guest", "/public/posts", "GET", 200),
    ("guest", "/posts", "POST", 403),
])
def test_role_based_access(role, endpoint, method, expected_status):
    """Parametrized role-based access testing."""
    tokens = {
        "admin": "admin_token",
        "user": "user_token",
        "guest": "guest_token"
    }
    
    client = httpx.Client(
        base_url="https://api.example.com",
        headers={"Authorization": f"Bearer {tokens[role]}"}
    )
    
    response = client.request(method, endpoint)
    assert response.status_code == expected_status
```

---

## C. Connect & Apply

Test access for each role: admin (full), user (limited), guest (read-only).

---

## D. Common Stumbling Blocks

**Mistake:** Assuming authenticated = authorized
**Fix:** Test permissions explicitly for each role

---

## ðŸŽ¯ Key Takeaways

âœ… Different roles = different permissions  
âœ… Test each role's access explicitly  
âœ… Parametrize for comprehensive coverage  
âœ… 403 for insufficient permissions  

---

## What's Next?

Next: **Permission Based Testing**!

**Ready to continue?** ðŸš€
