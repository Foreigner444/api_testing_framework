# Lesson 6.21: Token Expiration and Refresh

## A. Concept Overview

### What & Why
**Token expiration and refresh testing** validates that access tokens expire correctly and can be refreshed without re-authentication. Essential for securityâ€”expired tokens must be rejected, refresh mechanism must work reliably.

### Analogy
Token refresh is like renewing a driver's licenseâ€”your current license expires (access token), but you can renew it (refresh token) without retaking the driving test (re-entering password).

---

## B. Code Implementation

```python
import httpx
import pytest
import jwt
from datetime import datetime, timedelta


def test_expired_token_rejected():
    """Test API rejects expired tokens."""
    
    # Create expired token
    payload = {
        "sub": "user123",
        "exp": int((datetime.utcnow() - timedelta(hours=1)).timestamp())  # Expired
    }
    
    expired_token = jwt.encode(payload, "secret", algorithm="HS256")
    
    client = httpx.Client(
        base_url="https://api.example.com",
        headers={"Authorization": f"Bearer {expired_token}"}
    )
    
    response = client.get("/protected")
    
    assert response.status_code == 401
    error = response.json()
    assert "expired" in error.get("message", "").lower()


def test_token_refresh_flow():
    """Test token refresh mechanism."""
    
    client = httpx.Client(base_url="https://api.example.com")
    
    # Initial login returns access_token and refresh_token
    login_response = client.post(
        "/login",
        json={"username": "test", "password": "secret"}
    )
    
    assert login_response.status_code == 200
    tokens = login_response.json()
    
    access_token = tokens["access_token"]
    refresh_token = tokens["refresh_token"]
    
    # Use access token
    auth_client = httpx.Client(
        base_url="https://api.example.com",
        headers={"Authorization": f"Bearer {access_token}"}
    )
    
    response = auth_client.get("/data")
    assert response.status_code == 200
    
    # When access token expires, refresh it
    refresh_response = client.post(
        "/refresh",
        json={"refresh_token": refresh_token}
    )
    
    assert refresh_response.status_code == 200
    new_tokens = refresh_response.json()
    
    # Should receive new access token
    assert "access_token" in new_tokens
    new_access_token = new_tokens["access_token"]
    
    # New token should work
    new_client = httpx.Client(
        base_url="https://api.example.com",
        headers={"Authorization": f"Bearer {new_access_token}"}
    )
    
    response = new_client.get("/data")
    assert response.status_code == 200


def test_refresh_token_expiration():
    """Test refresh tokens also expire."""
    
    # Use expired refresh token
    client = httpx.Client(base_url="https://api.example.com")
    
    response = client.post(
        "/refresh",
        json={"refresh_token": "expired_refresh_token"}
    )
    
    # Should fail
    assert response.status_code == 401
    assert "expired" in response.json().get("error", "").lower()


def test_token_rotation_on_refresh():
    """Test refresh token rotation (security best practice)."""
    
    client = httpx.Client(base_url="https://api.example.com")
    
    # Login
    login_response = client.post("/login", json={"user": "test", "pass": "secret"})
    tokens1 = login_response.json()
    
    # Refresh
    refresh_response = client.post(
        "/refresh",
        json={"refresh_token": tokens1["refresh_token"]}
    )
    
    tokens2 = refresh_response.json()
    
    # Should receive NEW refresh token (rotation)
    assert tokens2["refresh_token"] != tokens1["refresh_token"]
    
    # Old refresh token should be invalidated
    old_refresh_response = client.post(
        "/refresh",
        json={"refresh_token": tokens1["refresh_token"]}
    )
    
    assert old_refresh_response.status_code == 401
```

---

## C. Connect & Apply

Test token expiration, refresh flow, and token rotation.

---

## D. Common Stumbling Blocks

**Mistake:** Not testing refresh token expiration
**Fix:** Test both access and refresh token expiration

---

## ðŸŽ¯ Key Takeaways

âœ… Access tokens expire (short-lived)  
âœ… Refresh tokens for renewal (long-lived)  
âœ… Expired tokens return 401  
âœ… Refresh token rotation for security  
âœ… Test complete refresh flow  

---

## What's Next?

Next: **Faker for Auth Test Data**!

**Ready to continue?** ðŸš€
